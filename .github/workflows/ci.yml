name: CI

on:
  push:
    branches: [main, audit-fixes]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================
  #  SOLIDITY: Compile, Test, Coverage
  # ============================================================
  solidity:
    name: Solidity Build & Test
    runs-on: ubuntu-latest
    steps:
      # SHA-pinned all Actions to prevent supply-chain attacks
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache Hardhat artifacts
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/hardhat-nodejs
            cache
            artifacts
          key: ${{ runner.os }}-hardhat-${{ hashFiles('contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-hardhat-

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts (with retry)
        run: |
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            npx hardhat compile && break || {
              echo "Compile failed, waiting 10s before retry..."
              sleep 10
            }
          done
        env:
          # Increase timeout for compiler download
          HARDHAT_NETWORK_TIMEOUT: 120000

      - name: Run tests
        run: npx hardhat test

      - name: Coverage report
        run: npx hardhat coverage
        # Coverage can fail on CI due to memory limits but should not block
        continue-on-error: true

      - name: Check coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json 2>/dev/null | jq -r '.total.statements.pct // 0' || echo "0")
          echo "Statement coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "::error::Coverage below 90% threshold — institutional audit requires ≥90%"
            exit 1
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: solidity-coverage
          path: coverage/
          retention-days: 14

  # ============================================================
  #  FOUNDRY: Fuzz & Invariant Tests
  # ============================================================
  foundry:
    name: Foundry Fuzz & Invariant Tests
    runs-on: ubuntu-latest
    needs: solidity
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8f1998e9878d786b7571f19a22fa0e656386e004 # v1.3.0

      - name: Run Foundry tests
        run: forge test -vvv

  # ============================================================
  #  SOLIDITY: Static Analysis & Security Audit
  # ============================================================
  solidity-security:
    name: Solidity Security Scan
    runs-on: ubuntu-latest
    needs: solidity
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Cache Hardhat artifacts
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            ~/.cache/hardhat-nodejs
            cache
            artifacts
          key: ${{ runner.os }}-hardhat-${{ hashFiles('contracts/**/*.sol') }}
          restore-keys: |
            ${{ runner.os }}-hardhat-

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts (with retry)
        run: |
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            npx hardhat compile && break || {
              echo "Compile failed, waiting 10s before retry..."
              sleep 10
            }
          done
        env:
          HARDHAT_NETWORK_TIMEOUT: 120000

      # Slither static analysis
      - name: Run Slither
        uses: crytic/slither-action@6bf3d1e41fe5ee8f8b86ad4e63f6a7ffc81e3d45 # v0.4.0
        id: slither
        with:
          node-version: "20"
          solc-version: "0.8.26"
          sarif: results.sarif
          fail-on: high
          slither-config: slither.config.json
          slither-args: --exclude-dependencies --filter-paths "contracts/mocks" --exclude naming-convention,arbitrary-send-erc20,arbitrary-send-eth,pragma,solc-version,missing-inheritance,shadowing-local,events-maths,missing-zero-check,calls-loop,reentrancy-benign,reentrancy-events,reentrancy-no-eth,timestamp,low-level-calls,unused-return,divide-before-multiply,incorrect-equality,locked-ether,unindexed-event-address,unused-state,cache-array-length,immutable-states,dead-code,cyclomatic-complexity,costly-loop
          # Only fail on HIGH severity - medium often has false positives
          # Excluded detectors explanation:
          # - arbitrary-send-*: Admin-only emergency functions with proper access control
          # - reentrancy-*: Functions protected by nonReentrant or CEI pattern used intentionally
          # - calls-loop: Bounded loops over admin-controlled strategy arrays
          # - incorrect-equality: Valid zero checks for early returns (elapsed==0, debt==0)
          # - divide-before-multiply: Intentional order for APY calculations with sufficient precision
          # - locked-ether: Mock contracts for testing only
          # - timestamp: Legitimate usage for cooldowns and rate limiting
          # - unused-return: Intentional ignoring of certain return values
          # - pragma/solc-version: OpenZeppelin uses different pragma versions
          # - Other informational detectors excluded for audit noise reduction

      - name: Upload Slither SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          sarif_file: results.sarif
        continue-on-error: true  # SARIF upload can fail on forks

  # ============================================================
  #  M-05: UUPS Storage Layout Validation
  # ============================================================
  storage-layout:
    name: UUPS Storage Layout Check
    runs-on: ubuntu-latest
    needs: solidity
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate UUPS storage layouts
        run: npx hardhat run scripts/validate-storage-layout.ts

  # ============================================================
  #  MYTHRIL: Symbolic Execution Analysis
  # ============================================================
  mythril:
    name: Mythril Symbolic Analysis
    runs-on: ubuntu-latest
    needs: solidity
    continue-on-error: true  # Advisory — Mythril can timeout on complex contracts
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Install Mythril
        run: |
          pip3 install mythril

      - name: Run Mythril on core contracts
        run: |
          CORE_CONTRACTS=(
            "contracts/BorrowModule.sol"
            "contracts/CollateralVault.sol"
            "contracts/DirectMintV2.sol"
            "contracts/LiquidationEngine.sol"
            "contracts/SMUSD.sol"
            "contracts/PriceOracle.sol"
            "contracts/MUSD.sol"
          )
          EXIT_CODE=0
          for contract in "${CORE_CONTRACTS[@]}"; do
            echo "═══════════════════════════════════════════════"
            echo "  Analyzing: $contract"
            echo "═══════════════════════════════════════════════"
            myth analyze "$contract" \
              --solv 0.8.26 \
              --execution-timeout 300 \
              --max-depth 12 \
              --strategy bfs \
              2>&1 || EXIT_CODE=$?
          done
          exit $EXIT_CODE

  # ============================================================
  #  DAML: Build & Test
  # ============================================================
  daml:
    name: DAML Build & Test
    runs-on: ubuntu-latest
    env:
      DAML_SDK_VERSION: "2.10.3"
      DAML_HOME: /home/runner/.daml
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install DAML SDK ${{ env.DAML_SDK_VERSION }}
        run: |
          # Create DAML directories
          mkdir -p "$DAML_HOME/bin" "$DAML_HOME/sdk/$DAML_SDK_VERSION"
          
          # Download and run installer with TERM set
          export TERM=xterm
          curl -sSL https://get.daml.com/ | bash -s $DAML_SDK_VERSION
        env:
          TERM: xterm

      - name: Add DAML to PATH
        run: echo "$DAML_HOME/bin" >> $GITHUB_PATH

      - name: Verify DAML installation
        run: |
          export PATH="$DAML_HOME/bin:$PATH"
          daml version

      - name: Build DAML
        working-directory: daml
        run: |
          export PATH="$DAML_HOME/bin:$PATH"
          daml build

      - name: Run DAML tests
        working-directory: daml
        run: |
          export PATH="$DAML_HOME/bin:$PATH"
          daml test

  # ============================================================
  #  RELAY: TypeScript Build & Lint
  # ============================================================
  relay:
    name: Relay Service Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install relay dependencies
        working-directory: relay
        run: npm ci || npm install

      - name: TypeScript compile check
        working-directory: relay
        run: npx tsc --noEmit

  # ============================================================
  #  DOCKER: Build & Scan Relay Image
  # ============================================================
  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    needs: [relay]
    # Skip on PRs - Dockerfile changes need to be on main first
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0

      - name: Build relay image
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355 # v6.10.0
        with:
          context: relay
          push: false
          tags: musd-relay:ci
          load: true
          no-cache: true

      # Trivy vulnerability scanner
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: musd-relay:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          trivyignores: relay/.trivyignore
          # Fail on CRITICAL/HIGH vulnerabilities

  # ============================================================
  #  KUBERNETES: Validate Manifests
  # ============================================================
  k8s-validate:
    name: K8s Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate K8s manifests
        run: |
          find k8s/ -name '*.yaml' -exec kubeconform \
            -strict \
            -ignore-missing-schemas \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -summary {} +

  # ============================================================
  #  DEPENDENCY AUDIT
  # ============================================================
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: npm audit (production)
        run: npm audit --omit=dev --audit-level=high
        # Fails on HIGH or CRITICAL vulnerabilities

      - name: Check for known vulnerabilities
        run: npx audit-ci --config audit-ci.json
        # GHSA-37qj-frw5-hhjh allowlisted (mitigated via npm override)

  # ============================================================
  #  CERTORA FORMAL VERIFICATION
  # ============================================================
  certora:
    name: Certora Formal Verification
    runs-on: ubuntu-latest
    needs: solidity
    continue-on-error: true  # Advisory until all specs are production-ready
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Certora CLI
        run: pip3 install certora-cli

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run Certora — MUSD invariants
        run: certoraRun certora/MUSD.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}

      - name: Run Certora — SMUSD invariants
        run: certoraRun certora/SMUSD.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}

      - name: Run Certora — BorrowModule invariants
        run: certoraRun certora/BorrowModule.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}

      - name: Run Certora — LiquidationEngine invariants
        run: certoraRun certora/LiquidationEngine.conf
        env:
          CERTORAKEY: ${{ secrets.CERTORAKEY }}

  # ============================================================
  #  SECRET SCANNING
  # ============================================================
  secret-scan:
    name: Secret Scanning (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
