name: CI

on:
  push:
    branches: [main, audit-fixes]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================
  #  SOLIDITY: Compile, Test, Coverage
  # ============================================================
  solidity:
    name: Solidity Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run tests
        run: npx hardhat test

      - name: Coverage report
        run: npx hardhat coverage
        # Coverage can fail on CI due to memory limits but should not block
        continue-on-error: true

      - name: Check coverage threshold
        run: |
          # Ensure at least 50% statement coverage
          COVERAGE=$(cat coverage/coverage-summary.json 2>/dev/null | jq -r '.total.statements.pct // 0' || echo "0")
          echo "Statement coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "::warning::Coverage below 50% threshold"
          fi
        continue-on-error: true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solidity-coverage
          path: coverage/
          retention-days: 14

  # ============================================================
  #  SOLIDITY: Static Analysis & Security Audit
  # ============================================================
  solidity-security:
    name: Solidity Security Scan
    runs-on: ubuntu-latest
    needs: solidity
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      # Slither static analysis
      - name: Run Slither
        uses: crytic/slither-action@v0.4.0
        id: slither
        with:
          solc-version: "0.8.26"
          sarif: results.sarif
          fail-on: high
          slither-args: --exclude-dependencies --exclude naming-convention --exclude arbitrary-send-erc20
          # Only fail on HIGH severity - medium often has false positives
          # arbitrary-send-erc20 excluded: Treasury deposit functions are access-controlled

      - name: Upload Slither SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
        continue-on-error: true  # SARIF upload can fail on forks

  # ============================================================
  #  DAML: Build & Test
  # ============================================================
  daml:
    name: DAML Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install DAML SDK 2.10.3
        run: |
          curl -sSL https://get.daml.com/ | sh -s 2.10.3
          echo "$HOME/.daml/bin" >> $GITHUB_PATH

      - name: Verify DAML installation
        run: |
          daml version

      - name: Build DAML
        working-directory: daml
        run: daml build

      - name: Run DAML tests
        working-directory: daml
        run: daml test

  # ============================================================
  #  RELAY: TypeScript Build & Lint
  # ============================================================
  relay:
    name: Relay Service Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install relay dependencies
        working-directory: relay
        run: npm ci || npm install

      - name: TypeScript compile check
        working-directory: relay
        run: npx tsc --noEmit

  # ============================================================
  #  DOCKER: Build & Scan Relay Image
  # ============================================================
  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    needs: [relay]
    # Skip on PRs - Dockerfile changes need to be on main first
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build relay image
        uses: docker/build-push-action@v6
        with:
          context: relay
          push: false
          tags: musd-relay:ci
          load: true
          no-cache: true

      # Trivy vulnerability scanner
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: musd-relay:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          trivyignores: relay/.trivyignore
          # Fail on CRITICAL/HIGH vulnerabilities

  # ============================================================
  #  KUBERNETES: Validate Manifests
  # ============================================================
  k8s-validate:
    name: K8s Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate K8s manifests
        run: |
          find k8s/ -name '*.yaml' -exec kubeconform -strict -summary {} +

  # ============================================================
  #  DEPENDENCY AUDIT
  # ============================================================
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: npm audit (production)
        run: npm audit --omit=dev --audit-level=high
        # Fails on HIGH or CRITICAL vulnerabilities

      - name: Check for known vulnerabilities
        run: npx audit-ci --config audit-ci.json
        # GHSA-37qj-frw5-hhjh allowlisted (mitigated via npm override)
