#!/bin/bash
# FIX C-7: Pre-commit hook to prevent accidental secret commits
# Install: git config core.hooksPath .githooks
#
# Scans staged files for common secret patterns:
#   - Private keys (hex-encoded 32-byte values)
#   - API keys / tokens
#   - .env files with sensitive vars
#
# This is a defense-in-depth measure ‚Äî also use gitleaks/trufflehog in CI.

set -euo pipefail

RED='\033[0;31m'
NC='\033[0m' # No Color

echo "üîí Running secret scan on staged files..."

# Get list of staged files (added, copied, modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

# Pattern 1: .env files containing known sensitive variable names
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env($|\.)' || true)
if [ -n "$ENV_FILES" ]; then
    for file in $ENV_FILES; do
        if git show ":$file" 2>/dev/null | grep -qiE '(PRIVATE_KEY|SECRET|PASSWORD|API_KEY|MNEMONIC)=.{8,}'; then
            echo -e "${RED}BLOCKED:${NC} $file contains what appears to be secrets"
            FOUND_SECRETS=1
        fi
    done
fi

# Pattern 2: Raw hex private keys (64 hex chars after 0x prefix)
for file in $STAGED_FILES; do
    # Skip binary files, node_modules, and known safe patterns
    case "$file" in
        *.sol|*.ts|*.js|*.json|*.yaml|*.yml|*.sh|*.daml|*.md|*.toml)
            # Check for private key patterns (but ignore well-known test addresses)
            if git show ":$file" 2>/dev/null | grep -nE '(0x)?[0-9a-fA-F]{64}' | \
               grep -ivE '(keccak|sha256|bytes32|hash|digest|slot|gap|entropy|attestationId|messageHash|ethHash|expectedId|SECP256K1_N|0x0{63}[01])' | \
               grep -qiE '(private.?key|secret|wallet|signer|account)'; then
                echo -e "${RED}BLOCKED:${NC} $file may contain a private key"
                FOUND_SECRETS=1
            fi
            ;;
    esac
done

# Pattern 3: AWS credentials
for file in $STAGED_FILES; do
    case "$file" in
        *.sol|*.ts|*.js|*.json|*.yaml|*.yml|*.sh|*.env*)
            if git show ":$file" 2>/dev/null | grep -qE '(AKIA[0-9A-Z]{16}|aws_secret_access_key)'; then
                echo -e "${RED}BLOCKED:${NC} $file contains AWS credentials"
                FOUND_SECRETS=1
            fi
            ;;
    esac
done

if [ "$FOUND_SECRETS" -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå COMMIT BLOCKED ‚Äî potential secrets detected in staged files.${NC}"
    echo "   If these are false positives, use: git commit --no-verify"
    echo "   But verify CAREFULLY before bypassing this check."
    exit 1
fi

echo "‚úÖ No secrets detected in staged files."
exit 0
