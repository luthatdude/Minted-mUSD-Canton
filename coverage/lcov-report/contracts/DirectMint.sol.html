<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/DirectMint.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> DirectMint.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">79.31% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>46/58</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">52.78% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>38/72</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.75% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.13% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>69/83</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
// BLE Protocol - DirectMint
// User-facing mint/redeem: USDC &lt;-&gt; mUSD
&nbsp;
pragma solidity 0.8.26;
&nbsp;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
&nbsp;
interface IMUSD {
    function mint(address to, uint256 amount) external;
    function burn(address from, uint256 amount) external;
    function supplyCap() external view returns (uint256);
    function totalSupply() external view returns (uint256);
}
&nbsp;
interface ITreasury {
    function deposit(address from, uint256 amount) external;
    function withdraw(address to, uint256 amount) external;
    function availableReserves() external view returns (uint256);
}
&nbsp;
/// @title DirectMint
/// @notice Allows users to mint mUSD by depositing USDC 1:1 (minus fees)
///         and redeem mUSD for USDC. Treasury holds the backing.
contract DirectMint is AccessControl, ReentrancyGuard, Pausable {
    using SafeERC20 for IERC20;
&nbsp;
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
    bytes32 public constant FEE_MANAGER_ROLE = keccak256("FEE_MANAGER_ROLE");
&nbsp;
    IERC20 public immutable usdc;
    IMUSD public immutable musd;
    ITreasury public immutable treasury;
&nbsp;
    // Fees in basis points (100 = 1%)
    uint256 public mintFeeBps;
    uint256 public redeemFeeBps;
    uint256 public constant MAX_FEE_BPS = 500; // 5% max
&nbsp;
    // Accumulated fees (in USDC decimals) - tracked separately
    uint256 public mintFees;    // Fees from minting (held in this contract)
    uint256 public redeemFees;  // Fees from redeeming (held in Treasury)
    address public feeRecipient;
&nbsp;
    // Per-transaction limits (in USDC decimals, 6 decimals)
    uint256 public minMintAmount;
    uint256 public maxMintAmount;
    uint256 public minRedeemAmount;
    uint256 public maxRedeemAmount;
&nbsp;
    // Events
    event Minted(address indexed user, uint256 usdcIn, uint256 musdOut, uint256 fee);
    event Redeemed(address indexed user, uint256 musdIn, uint256 usdcOut, uint256 fee);
    event FeesWithdrawn(address indexed to, uint256 amount);
    event FeeRecipientUpdated(address indexed oldRecipient, address indexed newRecipient);
    event FeesUpdated(uint256 mintFeeBps, uint256 redeemFeeBps);
    event LimitsUpdated(uint256 minMint, uint256 maxMint, uint256 minRedeem, uint256 maxRedeem);
&nbsp;
    constructor(
        address _usdc,
        address _musd,
        address _treasury,
        address _feeRecipient
    ) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_usdc != address(0), "INVALID_USDC");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_musd != address(0), "INVALID_MUSD");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_treasury != address(0), "INVALID_TREASURY");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_feeRecipient != address(0), "INVALID_FEE_RECIPIENT");
&nbsp;
        usdc = IERC20(_usdc);
        musd = IMUSD(_musd);
        treasury = ITreasury(_treasury);
        feeRecipient = _feeRecipient;
&nbsp;
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(PAUSER_ROLE, msg.sender);
        _grantRole(FEE_MANAGER_ROLE, msg.sender);
&nbsp;
        // Default limits
        minMintAmount = 1e6;          // 1 USDC
        maxMintAmount = 1_000_000e6;  // 1M USDC
        minRedeemAmount = 1e6;        // 1 USDC equivalent
        maxRedeemAmount = 1_000_000e6;
    }
&nbsp;
    // ============================================================
    //                    CORE FUNCTIONS
    // ============================================================
&nbsp;
    /// @notice Mint mUSD by depositing USDC
    /// @param usdcAmount Amount of USDC to deposit (6 decimals)
    /// @return musdOut Amount of mUSD minted (18 decimals)
    function mint(uint256 usdcAmount) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant whenNotPaused returns (uint256 musdOut) {
        require(usdcAmount &gt;= minMintAmount, "BELOW_MIN");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(usdcAmount &lt;= maxMintAmount, "ABOVE_MAX");
&nbsp;
        // Calculate fee in USDC terms
        uint256 feeUsdc = (usdcAmount * mintFeeBps) / 10000;
        uint256 usdcAfterFee = usdcAmount - feeUsdc;
&nbsp;
        // Convert USDC (6 decimals) to mUSD (18 decimals)
        musdOut = usdcAfterFee * 1e12;
&nbsp;
        // Check supply cap
        require(musd.totalSupply() + musdOut &lt;= musd.supplyCap(), "EXCEEDS_SUPPLY_CAP");
&nbsp;
        // Transfer USDC from user to this contract
        usdc.safeTransferFrom(msg.sender, address(this), usdcAmount);
&nbsp;
        // FIX H-04: Reset approval to 0 first, then set to avoid safeApprove revert
        // safeApprove reverts if current allowance is non-zero (preventing front-running)
        usdc.forceApprove(address(treasury), usdcAfterFee);
        treasury.deposit(address(this), usdcAfterFee);
&nbsp;
        // Track mint fees (held in this contract)
        if (feeUsdc &gt; 0) {
            mintFees += feeUsdc;
        }
&nbsp;
        // Mint mUSD to user
        musd.mint(msg.sender, musdOut);
&nbsp;
        emit Minted(msg.sender, usdcAmount, musdOut, feeUsdc);
    }
&nbsp;
    /// @notice Redeem mUSD for USDC
    /// @param musdAmount Amount of mUSD to redeem (18 decimals)
    /// @return usdcOut Amount of USDC returned (6 decimals)
    function redeem(uint256 musdAmount) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant whenNotPaused returns (uint256 usdcOut) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(musdAmount &gt; 0, "INVALID_AMOUNT");
&nbsp;
        // Convert mUSD to USDC equivalent
        uint256 usdcEquivalent = musdAmount / 1e12;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(usdcEquivalent &gt;= minRedeemAmount, "BELOW_MIN");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(usdcEquivalent &lt;= maxRedeemAmount, "ABOVE_MAX");
&nbsp;
        // Calculate fee - using combined calculation to avoid precision loss
        // feeUsdc = (musdAmount * redeemFeeBps) / (1e12 * 10000)
        uint256 feeUsdc = (musdAmount * redeemFeeBps) / (1e12 * 10000);
        usdcOut = usdcEquivalent - feeUsdc;
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(usdcOut &gt; 0, "ZERO_OUTPUT");
&nbsp;
        // Check treasury has enough
        <span class="missing-if-branch" title="else path not taken" >E</span>require(treasury.availableReserves() &gt;= usdcOut, "INSUFFICIENT_RESERVES");
&nbsp;
        // Burn user's mUSD (user must have approved this contract)
        musd.burn(msg.sender, musdAmount);
&nbsp;
        // Withdraw from treasury to user
        treasury.withdraw(msg.sender, usdcOut);
&nbsp;
        // Track redeem fees (these remain in the Treasury, not in this contract)
        <span class="missing-if-branch" title="if path not taken" >I</span>if (feeUsdc &gt; 0) {
            redeemFees += feeUsdc;
        }
&nbsp;
        emit Redeemed(msg.sender, musdAmount, usdcOut, feeUsdc);
    }
&nbsp;
    // ============================================================
    //                    VIEW FUNCTIONS
    // ============================================================
&nbsp;
    /// @notice Preview how much mUSD user will receive for USDC deposit
    function previewMint(uint256 usdcAmount) external view returns (uint256 musdOut, uint256 feeUsdc) {
        feeUsdc = (usdcAmount * mintFeeBps) / 10000;
        uint256 usdcAfterFee = usdcAmount - feeUsdc;
        musdOut = usdcAfterFee * 1e12;
    }
&nbsp;
    /// @notice Preview how much USDC user will receive for mUSD redemption
    function previewRedeem(uint256 musdAmount) external view returns (uint256 usdcOut, uint256 feeUsdc) {
        uint256 usdcEquivalent = musdAmount / 1e12;
        // Combined calculation to avoid precision loss
        feeUsdc = (musdAmount * redeemFeeBps) / (1e12 * 10000);
        usdcOut = usdcEquivalent - feeUsdc;
    }
&nbsp;
    /// @notice Check how much more mUSD can be minted
<span class="fstat-no" title="function not covered" >    function remainingMintable() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        uint256 cap = musd.supplyCap();</span>
<span class="cstat-no" title="statement not covered" >        uint256 supply = musd.totalSupply();</span>
<span class="cstat-no" title="statement not covered" >        return cap &gt; supply ? cap - supply : 0;</span>
    }
&nbsp;
    /// @notice Check treasury balance available for redemptions
<span class="fstat-no" title="function not covered" >    function availableForRedemption() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return treasury.availableReserves();</span>
    }
&nbsp;
    // ============================================================
    //                    ADMIN FUNCTIONS
    // ============================================================
&nbsp;
    function setFees(uint256 _mintFeeBps, uint256 _redeemFeeBps) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(FEE_MANAGER_ROLE) {
        require(_mintFeeBps &lt;= MAX_FEE_BPS, "MINT_FEE_TOO_HIGH");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_redeemFeeBps &lt;= MAX_FEE_BPS, "REDEEM_FEE_TOO_HIGH");
        mintFeeBps = _mintFeeBps;
        redeemFeeBps = _redeemFeeBps;
        emit FeesUpdated(_mintFeeBps, _redeemFeeBps);
    }
&nbsp;
    function setLimits(
        uint256 _minMint,
        uint256 _maxMint,
        uint256 _minRedeem,
        uint256 _maxRedeem
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(DEFAULT_ADMIN_ROLE) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_minMint &lt;= _maxMint, "INVALID_MINT_LIMITS");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_minRedeem &lt;= _maxRedeem, "INVALID_REDEEM_LIMITS");
        minMintAmount = _minMint;
        maxMintAmount = _maxMint;
        minRedeemAmount = _minRedeem;
        maxRedeemAmount = _maxRedeem;
        emit LimitsUpdated(_minMint, _maxMint, _minRedeem, _maxRedeem);
    }
&nbsp;
    function setFeeRecipient(address _recipient) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(DEFAULT_ADMIN_ROLE) {
        require(_recipient != address(0), "INVALID_RECIPIENT");
        address old = feeRecipient;
        feeRecipient = _recipient;
        emit FeeRecipientUpdated(old, _recipient);
    }
&nbsp;
    function withdrawFees() external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(FEE_MANAGER_ROLE) {
        uint256 fees = mintFees;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(fees &gt; 0, "NO_FEES");
        mintFees = 0;
        usdc.safeTransfer(feeRecipient, fees);
        emit FeesWithdrawn(feeRecipient, fees);
    }
&nbsp;
    /// @notice FIX S-H02: Withdraw accumulated redeem fees from Treasury
    /// Redeem fees stay in Treasury during redeem(); this function extracts them.
<span class="fstat-no" title="function not covered" >    function withdrawRedeemFees() external onlyRole(FEE_MANAGER_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        uint256 fees = redeemFees;</span>
<span class="cstat-no" title="statement not covered" >        require(fees &gt; 0, "NO_REDEEM_FEES")</span>;
        redeemFees = 0;
<span class="cstat-no" title="statement not covered" >        treasury.withdraw(feeRecipient, fees)</span>;
<span class="cstat-no" title="statement not covered" >        emit FeesWithdrawn(feeRecipient, fees);</span>
    }
&nbsp;
    /// @notice View total accumulated fees (mint + redeem) for accounting
<span class="fstat-no" title="function not covered" >    function totalAccumulatedFees() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return mintFees + redeemFees;</span>
    }
&nbsp;
    function pause() external onlyRole(PAUSER_ROLE) {
        _pause();
    }
&nbsp;
    /// FIX M-5: Unpause requires admin, not pauser (separation of duties)
    /// This prevents a compromised pauser from resuming a malicious unpause
    function unpause() external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(DEFAULT_ADMIN_ROLE) {
        _unpause();
    }
&nbsp;
    /// @notice Emergency token recovery (not USDC or mUSD)
    /// FIX 5C-M02: Block recovery of both USDC and mUSD to prevent fund extraction
<span class="fstat-no" title="function not covered" >    function recoverToken(address token, uint256 amount) external onlyRole(DEFAULT_ADMIN_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        require(token != address(usdc), "CANNOT_RECOVER_USDC")</span>;
<span class="cstat-no" title="statement not covered" >        require(token != address(musd), "CANNOT_RECOVER_MUSD")</span>;
<span class="cstat-no" title="statement not covered" >        IERC20(token).safeTransfer(msg.sender, amount)</span>;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Feb 01 2026 18:45:31 GMT-0500 (Eastern Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
