<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/LiquidationEngine.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> LiquidationEngine.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.49% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>43/47</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">58% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>29/50</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">88.14% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>52/59</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
// BLE Protocol - Liquidation Engine
// Liquidates undercollateralized positions in the borrowing system
&nbsp;
pragma solidity 0.8.26;
&nbsp;
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
&nbsp;
interface ICollateralVaultLiq {
    function deposits(address user, address token) external view returns (uint256);
    function getSupportedTokens() external view returns (address[] memory);
    function getConfig(address token) external view returns (
        bool enabled, uint256 collateralFactorBps, uint256 liquidationThresholdBps, uint256 liquidationPenaltyBps
    );
    function seize(address user, address token, uint256 amount, address liquidator) external;
}
&nbsp;
interface IPriceOracleLiqExt {
    function getPrice(address token) external view returns (uint256);
    function getValueUsd(address token, uint256 amount) external view returns (uint256);
}
&nbsp;
// FIX H-01: Token decimals interface for proper seizure calculation
interface IERC20Decimals {
    function decimals() external view returns (uint8);
}
&nbsp;
interface IBorrowModule {
    function totalDebt(address user) external view returns (uint256);
    function healthFactor(address user) external view returns (uint256);
    function reduceDebt(address user, uint256 amount) external;
}
&nbsp;
interface IPriceOracleLiq {
    function getPrice(address token) external view returns (uint256);
    function getValueUsd(address token, uint256 amount) external view returns (uint256);
}
&nbsp;
interface IMUSDBurn {
    function burn(address from, uint256 amount) external;
}
&nbsp;
/// @title LiquidationEngine
/// @notice Liquidates undercollateralized borrowing positions.
///         Liquidators repay a portion of the debt in mUSD and receive
///         the borrower's collateral at a discount (liquidation penalty).
contract LiquidationEngine is AccessControl, ReentrancyGuard, Pausable {
    using SafeERC20 for IERC20;
&nbsp;
    bytes32 public constant ENGINE_ADMIN_ROLE = keccak256("ENGINE_ADMIN_ROLE");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
&nbsp;
    ICollateralVaultLiq public immutable vault;
    IBorrowModule public immutable borrowModule;
    IPriceOracleLiq public immutable oracle;
    IMUSDBurn public immutable musd;
&nbsp;
    // Maximum percentage of debt that can be liquidated in a single call (basis points)
    // e.g., 5000 = 50% (similar to Aave's close factor)
    uint256 public closeFactorBps;
&nbsp;
    // Minimum health factor below which full liquidation is allowed
    uint256 public fullLiquidationThreshold; // bps, e.g., 5000 = 0.5
    
    // FIX M-20: Minimum profitable liquidation to prevent dust attacks
    // Set to 100 mUSD (18 decimals) to ensure liquidations are economically meaningful
    uint256 public constant MIN_LIQUIDATION_AMOUNT = 100e18;
&nbsp;
    event Liquidation(
        address indexed liquidator,
        address indexed borrower,
        address indexed collateralToken,
        uint256 debtRepaid,
        uint256 collateralSeized
    );
    event CloseFactorUpdated(uint256 oldFactor, uint256 newFactor);
    event FullLiquidationThresholdUpdated(uint256 oldThreshold, uint256 newThreshold);
&nbsp;
    constructor(
        address _vault,
        address _borrowModule,
        address _oracle,
        address _musd,
        uint256 _closeFactorBps
    ) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_vault != address(0), "INVALID_VAULT");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_borrowModule != address(0), "INVALID_BORROW_MODULE");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_oracle != address(0), "INVALID_ORACLE");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_musd != address(0), "INVALID_MUSD");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_closeFactorBps &gt; 0 &amp;&amp; _closeFactorBps &lt;= 10000, "INVALID_CLOSE_FACTOR");
&nbsp;
        vault = ICollateralVaultLiq(_vault);
        borrowModule = IBorrowModule(_borrowModule);
        oracle = IPriceOracleLiq(_oracle);
        musd = IMUSDBurn(_musd);
        closeFactorBps = _closeFactorBps;
        fullLiquidationThreshold = 5000; // 0.5 health factor = allow full liquidation
&nbsp;
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(ENGINE_ADMIN_ROLE, msg.sender);
    }
&nbsp;
    /// @notice Liquidate an undercollateralized position
    /// @param borrower The address of the undercollateralized borrower
    /// @param collateralToken The collateral token to seize
    /// @param debtToRepay Amount of mUSD debt to repay on behalf of borrower
    function liquidate(
        address borrower,
        address collateralToken,
        uint256 debtToRepay
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused {
        require(borrower != msg.sender, "CANNOT_SELF_LIQUIDATE");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(debtToRepay &gt; 0, "INVALID_AMOUNT");
        // FIX M-20: Prevent dust liquidations that waste gas and spam events
        <span class="missing-if-branch" title="else path not taken" >E</span>require(debtToRepay &gt;= MIN_LIQUIDATION_AMOUNT, "DUST_LIQUIDATION");
&nbsp;
        // Check position is liquidatable
        uint256 hf = borrowModule.healthFactor(borrower);
        require(hf &lt; 10000, "POSITION_HEALTHY"); // Health factor &lt; 1.0
&nbsp;
        // Determine max repayable amount
        uint256 totalDebt = borrowModule.totalDebt(borrower);
        uint256 maxRepay;
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (hf &lt; fullLiquidationThreshold) {
            // Position is severely undercollateralized — allow full liquidation
            maxRepay = totalDebt;
        } else {
            // Normal liquidation — cap at close factor
            maxRepay = (totalDebt * closeFactorBps) / 10000;
        }
&nbsp;
        uint256 actualRepay = debtToRepay &gt; maxRepay ? maxRepay : debtToRepay;
&nbsp;
        // Calculate collateral to seize
        // FIX H-01: Use oracle.getValueUsd for proper decimal normalization
        // FIX S-M05: Allow liquidation even if collateral token is disabled
        // Disabled collateral positions must still be liquidatable for protocol safety
        (, , , uint256 penaltyBps) = vault.getConfig(collateralToken);
&nbsp;
        uint256 collateralPrice = oracle.getPrice(collateralToken);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(collateralPrice &gt; 0, "INVALID_PRICE");
&nbsp;
        // FIX H-01: Convert USD value to collateral token amount accounting for token decimals
        // collateralPrice is USD per 1 full token (18 decimals)
        // For a token with D decimals: seizeAmount = seizeValueUsd * 10^D / collateralPrice
        // FIX L-04: Require decimals() to succeed instead of silently defaulting to 18,
        // which would cause wildly incorrect seizure amounts for non-18-decimal tokens.
        // FIX: Combined calculation to avoid divide-before-multiply precision loss
        // seizeAmount = actualRepay * (10000 + penaltyBps) * 10^D / (10000 * collateralPrice)
        uint8 tokenDecimals = IERC20Decimals(collateralToken).decimals();
        uint256 seizeAmount = (actualRepay * (10000 + penaltyBps) * (10 ** tokenDecimals)) / (10000 * collateralPrice);
&nbsp;
        // Cap at available collateral
        uint256 available = vault.deposits(borrower, collateralToken);
        <span class="missing-if-branch" title="if path not taken" >I</span>if (seizeAmount &gt; available) {
            seizeAmount = available;
            // Recalculate actual debt repaid based on available collateral
<span class="cstat-no" title="statement not covered" >            uint256 seizeValue = oracle.getValueUsd(collateralToken, seizeAmount);</span>
            actualRepay = (seizeValue * 10000) / (10000 + penaltyBps);
        }
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(seizeAmount &gt; 0, "NOTHING_TO_SEIZE");
&nbsp;
        // FIX C-1: Execute liquidation following CEI pattern.
        // All three operations are calls to trusted protocol contracts.
        // We order: burn (removes liquidator's mUSD) -&gt; seize (moves collateral) -&gt; reduceDebt (bookkeeping)
        // If any call reverts, the entire transaction reverts atomically.
&nbsp;
        // 1. Liquidator pays mUSD (burns it)
        musd.burn(msg.sender, actualRepay);
&nbsp;
        // 2. Seize collateral to liquidator (moved before reduceDebt for safer ordering)
        vault.seize(borrower, collateralToken, seizeAmount, msg.sender);
&nbsp;
        // 3. Reduce borrower's debt (bookkeeping after all transfers complete)
        borrowModule.reduceDebt(borrower, actualRepay);
&nbsp;
        emit Liquidation(msg.sender, borrower, collateralToken, actualRepay, seizeAmount);
    }
&nbsp;
    // ============================================================
    //                  VIEW FUNCTIONS
    // ============================================================
&nbsp;
    /// @notice Check if a position is liquidatable
    function isLiquidatable(address borrower) external view returns (bool) {
        uint256 debt = borrowModule.totalDebt(borrower);
        if (debt == 0) return false;
        return borrowModule.healthFactor(borrower) &lt; 10000;
    }
&nbsp;
    /// @notice Estimate collateral received for a given debt repayment
    /// FIX 5C-L03: Allow estimates for disabled collateral (matches liquidate behavior)
    function estimateSeize(
        address borrower,
        address collateralToken,
        uint256 debtToRepay
    ) external view returns (uint256 collateralAmount) {
        (, , , uint256 penaltyBps) = vault.getConfig(collateralToken);
&nbsp;
        uint256 collateralPrice = oracle.getPrice(collateralToken);
        <span class="missing-if-branch" title="if path not taken" >I</span>if (collateralPrice == 0) <span class="cstat-no" title="statement not covered" >return 0;</span>
&nbsp;
        // FIX L-04: Require decimals() — view function, safe to let revert for unsupported tokens
        // FIX: Combined calculation to avoid divide-before-multiply precision loss
        uint8 tokenDecimals = IERC20Decimals(collateralToken).decimals();
        collateralAmount = (debtToRepay * (10000 + penaltyBps) * (10 ** tokenDecimals)) / (10000 * collateralPrice);
&nbsp;
        uint256 available = vault.deposits(borrower, collateralToken);
        <span class="missing-if-branch" title="if path not taken" >I</span>if (collateralAmount &gt; available) {
            collateralAmount = available;
        }
    }
&nbsp;
    // ============================================================
    //                  ADMIN
    // ============================================================
&nbsp;
    function setCloseFactor(uint256 _bps) external onlyRole(ENGINE_ADMIN_ROLE) {
        require(_bps &gt; 0 &amp;&amp; _bps &lt;= 10000, "INVALID_CLOSE_FACTOR");
        uint256 old = closeFactorBps;
        closeFactorBps = _bps;
        emit CloseFactorUpdated(old, _bps);
    }
&nbsp;
    function setFullLiquidationThreshold(uint256 _bps) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(ENGINE_ADMIN_ROLE) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_bps &gt; 0 &amp;&amp; _bps &lt; 10000, "INVALID_THRESHOLD");
        emit FullLiquidationThresholdUpdated(fullLiquidationThreshold, _bps);
        fullLiquidationThreshold = _bps;
    }
&nbsp;
    // ============================================================
    //                  EMERGENCY CONTROLS
    // ============================================================
&nbsp;
    /// @notice Pause liquidations
<span class="fstat-no" title="function not covered" >    function pause() external onlyRole(PAUSER_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _pause()</span>;
    }
&nbsp;
    /// @notice Unpause liquidations
<span class="fstat-no" title="function not covered" >    function unpause() external onlyRole(PAUSER_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        _unpause()</span>;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Jan 31 2026 17:52:22 GMT-0500 (Eastern Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
