module
 
MUSD
 
where

import
 Daml
.
Script

-- | The core stablecoin contract.

-- Signatories: Both the provider (issuer) and owner (holder).

-- This ensures the issuer cannot move funds without permission, 

-- and the holder cannot forge tokens without issuer backing.

template
 
MUSD

  
with

    
provider
 
:
 
Party

    
owner
    
:
 
Party

    
amount
   
:
 
Decimal

  
where

    
signatory
 
provider
,
 
owner

    
-- A. SECURITY: Ensure no zero or negative balances exist.

    
ensure
 
amount
 
>
 
0.0

    
-- B. LOGIC: Split a single asset into two.

    
choice
 
MUSD_Split
 
:
 
(
ContractId
 
MUSD
,
 
ContractId
 
MUSD
)

      
with

        
splitAmount
 
:
 
Decimal

      
controller
 
owner

      
do

        
assertMsg
 
"Split amount must be positive"
 
(
splitAmount
 
>
 
0.0
)

        
assertMsg
 
"Insufficient funds for split (must leave a remainder)"
 
(
splitAmount
 
<
 
amount
)

        
c1
 
<-
 
create
 
this
 
with
 
amount
 
=
 
splitAmount

        
c2
 
<-
 
create
 
this
 
with
 
amount
 
=
 
amount
 
-
 
splitAmount

        
return
 
(
c1
,
 
c2
)

    
-- C. LOGIC: Merge two assets.

    
choice
 
MUSD_Merge
 
:
 
ContractId
 
MUSD

      
with

        
otherCid
 
:
 
ContractId
 
MUSD

      
controller
 
owner

      
do

        
assertMsg
 
"Cannot merge a contract with itself"
 
(
self
 
/=
 
otherCid
)

        
other
 
<-
 
fetch
 
otherCid

        
-- SECURITY: Ensure metadata matches exactly

        
assertMsg
 
"Must be same provider"
 
(
provider
 
==
 
other
.
provider
)

        
assertMsg
 
"Must be same owner"
 
(
owner
 
==
 
other
.
owner
)

        
-- Archive the other contract; 'self' is archived automatically as this is a consuming choice.

        
archive
 
otherCid

        
create
 
this
 
with
 
amount
 
=
 
amount
 
+
 
other
.
amount

    
-- D. LOGIC: Initiate a transfer via Proposal pattern.

    
choice
 
MUSD_Transfer
 
:
 
ContractId
 
MUSD_TransferProposal

      
with

        
newOwner
 
:
 
Party

      
controller
 
owner

      
do

        
create
 
MUSD_TransferProposal
 
with
 
usd
 
=
 
this
,
 
newOwner

    
-- E. LOGIC: Redemption (Burn). 

    
-- The owner chooses to destroy the token, usually in exchange for fiat USD.

    
choice
 
MUSD_Redeem
 
:
 
(
)

      
controller
 
owner

      
do

        
-- In a production system, this might create a 'RedemptionRequest' 

        
-- to notify the provider's off-ledger systems to wire real cash.

        
return
 
(
)

-- | Proposal contract for transfers.

-- Solves the "Signatory Bottleneck": newOwner must consent to become a signatory.

template
 
MUSD_TransferProposal

  
with

    
usd
      
:
 
MUSD

    
newOwner
 
:
 
Party

  
where

    
signatory
 
usd
.
provider
,
 
usd
.
owner

    
observer
 
newOwner

    
-- Receiver accepts: the token owner changes.

    
choice
 
MUSD_AcceptTransfer
 
:
 
ContractId
 
MUSD

      
controller
 
newOwner

      
do

        
create
 
usd
 
with
 
owner
 
=
 
newOwner

    
-- Receiver rejects: the original MUSD is returned to the sender.

    
choice
 
MUSD_RejectTransfer
 
:
 
ContractId
 
MUSD

      
controller
 
newOwner

      
do
 
create
 
usd

    
-- Sender cancels: the original MUSD is returned to the sender.

    
choice
 
MUSD_CancelTransfer
 
:
 
ContractId
 
MUSD

      
controller
 
usd
.
owner

      
do
 
create
 
usd

-- | Proposal contract for initial Issuance (Minting).

-- Required because a user cannot be forced to sign a contract (MUSD) they didn't agree to.

template
 
MUSD_MintProposal

  
with

    
provider
 
:
 
Party

    
owner
    
:
 
Party

    
amount
   
:
 
Decimal

  
where

    
signatory
 
provider

    
observer
 
owner

    
choice
 
MUSD_MintProposal_Accept
 
:
 
ContractId
 
MUSD

      
controller
 
owner

      
do

        
create
 
MUSD
 
with
 
provider
,
 
owner
,
 
amount

    
choice
 
MUSD_MintProposal_Reject
 
:
 
(
)

      
controller
 
owner

      
do
 
return
 
(
)

    
choice
 
MUSD_MintProposal_Cancel
 
:
 
(
)

      
controller
 
provider

      
do
 
return
 
(
)
