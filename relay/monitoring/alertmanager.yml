# Minted Protocol — Alertmanager Configuration
# Routes critical bridge alerts to PagerDuty/Telegram.
#
# Item-10: Production alerting (replace placeholder routes).
#
# IMPORTANT: Replace <PAGERDUTY_SERVICE_KEY> and <TELEGRAM_BOT_TOKEN>
# with real credentials before deploying.

global:
  resolve_timeout: 5m

# Inhibition rules — prevent noise from cascading alerts
inhibit_rules:
  - source_matchers:
      - severity = critical
    target_matchers:
      - severity = warning
    equal: ["alertname", "team"]

# Notification routing tree
route:
  group_by: ["alertname", "team"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: "default-webhook"

  routes:
    # ── CRITICAL: page on-call immediately ──
    - matchers:
        - severity = critical
      receiver: "pagerduty-bridge"
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # ── Bridge security: always page + Telegram ──
    - matchers:
        - team = security
      receiver: "security-team"
      group_wait: 10s
      repeat_interval: 30m

    # ── Warning: Telegram only ──
    - matchers:
        - severity = warning
      receiver: "telegram-ops"
      repeat_interval: 4h

# Notification receivers
receivers:
  - name: "default-webhook"
    webhook_configs:
      - url: "http://localhost:9095/webhook"
        send_resolved: true

  - name: "pagerduty-bridge"
    pagerduty_configs:
      - service_key: "${PAGERDUTY_SERVICE_KEY}"
        severity: '{{ .CommonLabels.severity }}'
        description: '{{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'

  - name: "security-team"
    pagerduty_configs:
      - service_key: "${PAGERDUTY_SERVICE_KEY}"
        severity: critical
    webhook_configs:
      - url: "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
        send_resolved: true
        http_config:
          bearer_token: "${TELEGRAM_BOT_TOKEN}"

  - name: "telegram-ops"
    webhook_configs:
      - url: "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
        send_resolved: true
        http_config:
          bearer_token: "${TELEGRAM_BOT_TOKEN}"
