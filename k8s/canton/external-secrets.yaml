## H-06: External Secrets Operator Integration
##
## These ExternalSecret CRDs replace the plain Opaque secrets in secrets.yaml.
## They pull credentials from AWS Secrets Manager at runtime, ensuring secrets
## are never stored in version control or K8s manifests.
##
## INFRA-M-11: Key Rotation Policy
## All secrets managed by External Secrets Operator support automatic rotation:
##   - Database credentials: Rotate every 90 days via AWS Secrets Manager rotation lambda
##   - TLS certificates: Rotate every 365 days (prefer cert-manager for automated renewal)
##   - JWT secrets: Rotate every 90 days via AWS Secrets Manager
##   - Bridge signing keys: Rotate every 180 days with multi-sig ceremony
##
## To enable automatic rotation in AWS Secrets Manager:
##   aws secretsmanager rotate-secret --secret-id canton/production/postgres \
##     --rotation-lambda-arn arn:aws:lambda:REGION:ACCOUNT:function:SecretsManagerRotation \
##     --rotation-rules '{"AutomaticallyAfterDays": 90}'
##
## Prerequisites:
##   1. Install External Secrets Operator: helm install external-secrets external-secrets/external-secrets
##   2. Create AWS IAM role with SecretsManager read access
##   3. Apply ClusterSecretStore below first, then ExternalSecret resources
##   4. Configure AWS Secrets Manager rotation lambdas for each secret

---
# ClusterSecretStore — shared AWS Secrets Manager backend
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  # INFRA-H-01: Fixed namespace from 'canton' to 'musd-canton' to match workloads
  namespace: musd-canton
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: musd-canton

---
# ExternalSecret: PostgreSQL credentials
# Replaces: k8s/canton/secrets.yaml postgres-credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  # INFRA-H-01: Fixed namespace from 'canton' to 'musd-canton' to match workloads
  namespace: musd-canton
  labels:
    app: canton
    component: database
  annotations:
    # INFRA-M-11: Database credential rotation — 90-day cycle via AWS rotation lambda
    musd.io/rotation-schedule: "every-90-days"
    musd.io/rotation-method: "aws-secrets-manager-rotation-lambda"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: canton/production/postgres
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: canton/production/postgres
        property: password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: canton/production/postgres
        property: database
    - secretKey: POSTGRES_HOST
      remoteRef:
        key: canton/production/postgres
        property: host

---
# ExternalSecret: Canton TLS certificates
# Replaces: k8s/canton/secrets.yaml canton-tls
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: canton-tls
  # INFRA-H-01: Fixed namespace from 'canton' to 'musd-canton' to match workloads
  namespace: musd-canton
  labels:
    app: canton
    component: tls
  annotations:
    # INFRA-M-11: TLS certificate rotation — 365-day cycle; prefer cert-manager for auto-renewal
    musd.io/rotation-schedule: "every-365-days"
    musd.io/rotation-method: "cert-manager-preferred"
    # INFRA-M-12: Each environment MUST use unique certificates.
    # The AWS Secrets Manager path below should be per-environment
    # (e.g., canton/production/tls, canton/staging/tls).
    # NEVER share private keys across environments.
    musd.io/cert-scope: "per-environment-unique"
    musd.io/self-signed-allowed: "development-only"
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: canton-tls
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: canton/production/tls
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: canton/production/tls
        property: private_key
    - secretKey: ca.crt
      remoteRef:
        key: canton/production/tls
        property: ca_certificate

---
# ExternalSecret: JSON API credentials
# Replaces: k8s/canton/secrets.yaml json-api-credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: json-api-credentials
  # INFRA-H-01: Fixed namespace from 'canton' to 'musd-canton' to match workloads
  namespace: musd-canton
  labels:
    app: canton
    component: json-api
  annotations:
    # INFRA-M-11: JWT secret rotation — 90-day cycle via AWS rotation lambda
    musd.io/rotation-schedule: "every-90-days"
    musd.io/rotation-method: "aws-secrets-manager-rotation-lambda"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: json-api-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: LEDGER_API_TOKEN
      remoteRef:
        key: canton/production/json-api
        property: ledger_api_token
    - secretKey: JSON_API_SECRET
      remoteRef:
        key: canton/production/json-api
        property: api_secret
---
# ExternalSecret: Canton production domain connection settings
# Required by participant bootstrap script in participant-config.yaml.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: canton-domain-connection
  namespace: musd-canton
  labels:
    app: canton
    component: domain-connect
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: canton-domain-connection
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: CANTON_DOMAIN_ALIAS
      remoteRef:
        key: canton/production/domain
        property: alias
    - secretKey: CANTON_DOMAIN_URL
      remoteRef:
        key: canton/production/domain
        property: url
