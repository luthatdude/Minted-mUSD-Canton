## H-06: External Secrets Operator Integration
##
## These ExternalSecret CRDs replace the plain Opaque secrets in secrets.yaml.
## They pull credentials from AWS Secrets Manager at runtime, ensuring secrets
## are never stored in version control or K8s manifests.
##
## Prerequisites:
##   1. Install External Secrets Operator: helm install external-secrets external-secrets/external-secrets
##   2. Create AWS IAM role with SecretsManager read access
##   3. Apply ClusterSecretStore below first, then ExternalSecret resources

---
# ClusterSecretStore â€” shared AWS Secrets Manager backend
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  namespace: canton
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: canton

---
# ExternalSecret: PostgreSQL credentials
# Replaces: k8s/canton/secrets.yaml postgres-credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: canton
  labels:
    app: canton
    component: database
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: canton/production/postgres
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: canton/production/postgres
        property: password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: canton/production/postgres
        property: database
    - secretKey: POSTGRES_HOST
      remoteRef:
        key: canton/production/postgres
        property: host

---
# ExternalSecret: Canton TLS certificates
# Replaces: k8s/canton/secrets.yaml canton-tls
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: canton-tls
  namespace: canton
  labels:
    app: canton
    component: tls
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: canton-tls
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: canton/production/tls
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: canton/production/tls
        property: private_key
    - secretKey: ca.crt
      remoteRef:
        key: canton/production/tls
        property: ca_certificate

---
# ExternalSecret: JSON API credentials
# Replaces: k8s/canton/secrets.yaml json-api-credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: json-api-credentials
  namespace: canton
  labels:
    app: canton
    component: json-api
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: json-api-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: LEDGER_API_TOKEN
      remoteRef:
        key: canton/production/json-api
        property: ledger_api_token
    - secretKey: JSON_API_SECRET
      remoteRef:
        key: canton/production/json-api
        property: api_secret
