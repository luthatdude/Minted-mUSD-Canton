# PostgreSQL backup CronJob for disaster recovery
# Runs daily at 2:00 AM UTC, dumps the Canton participant database,
# and stores the backup in a PersistentVolumeClaim.
#
# Prerequisites:
#   - Secret "postgres-credentials" with keys "username" and "password"
#   - PVC "postgres-backups" (defined below) provisioned in the cluster
#   - PostgreSQL service reachable at postgres.musd-canton.svc.cluster.local:5432
#
# To restore from backup:
#   kubectl cp musd-canton/<backup-pod>:/backups/<file>.sql.gz ./restore.sql.gz
#   gunzip restore.sql.gz
#   psql -h <host> -U <user> -d canton < restore.sql
---
# PVC for storing database backups
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-backups
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/component: backup
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: gp3-encrypted
  resources:
    requests:
      storage: 50Gi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/component: backup
spec:
  # Run daily at 2:00 AM UTC
  schedule: "0 2 * * *"
  # Forbid concurrent backup runs
  concurrencyPolicy: Forbid
  # Keep last 7 successful and 3 failed jobs for debugging
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  # Don't start if missed by more than 15 minutes
  startingDeadlineSeconds: 900
  jobTemplate:
    spec:
      # Fail the job if it runs longer than 1 hour
      activeDeadlineSeconds: 3600
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres-backup
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
            runAsGroup: 999
            fsGroup: 999
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: pg-backup
              # Match the PostgreSQL version used in the StatefulSet (16.4-alpine)
              # Uses the same pinned digest as the main postgres container
              image: postgres:16.4-alpine@sha256:d898b0b78a2627cb4ee63464a14571e0a38aae2c66a9e0d7c5a44715c7bdc744
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail

                  TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
                  BACKUP_FILE="/backups/canton_backup_${TIMESTAMP}.sql.gz"

                  echo "[$(date -u)] Starting pg_dump of database '${PGDATABASE}'..."

                  pg_dump \
                    -h "${PGHOST}" \
                    -p "${PGPORT}" \
                    -U "${PGUSER}" \
                    -d "${PGDATABASE}" \
                    --no-password \
                    --format=custom \
                    --compress=6 \
                    --verbose \
                    -f "${BACKUP_FILE}"

                  BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
                  echo "[$(date -u)] Backup complete: ${BACKUP_FILE} (${BACKUP_SIZE})"

                  # Verify backup integrity
                  pg_restore --list "${BACKUP_FILE}" > /dev/null 2>&1
                  echo "[$(date -u)] Backup integrity check passed."

                  # Prune backups older than 30 days
                  echo "[$(date -u)] Pruning backups older than 30 days..."
                  find /backups -name "canton_backup_*.sql.gz" -mtime +30 -delete -print
                  echo "[$(date -u)] Pruning complete."

                  # List remaining backups
                  echo "[$(date -u)] Current backups:"
                  ls -lh /backups/canton_backup_*.sql.gz 2>/dev/null || echo "  (none)"
              env:
                - name: PGHOST
                  value: postgres.musd-canton.svc.cluster.local
                - name: PGPORT
                  value: "5432"
                - name: PGDATABASE
                  value: canton
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials
                      key: password
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                # Cannot use readOnlyRootFilesystem: true because pg_dump
                # needs /tmp for intermediate state; /backups is the PVC mount.
                readOnlyRootFilesystem: false
              volumeMounts:
                - name: backups
                  mountPath: /backups
                - name: tmp
                  mountPath: /tmp
          volumes:
            - name: backups
              persistentVolumeClaim:
                claimName: postgres-backups
            - name: tmp
              emptyDir:
                sizeLimit: 256Mi
