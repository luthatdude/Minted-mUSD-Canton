# ServiceAccount and RBAC for Canton deployment
# Explicit RBAC with least-privilege access
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: canton-participant
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: canton-participant
    app.kubernetes.io/component: ledger
  annotations:
    # INFRA-H-05: Restrict which secrets this SA can mount
    kubernetes.io/enforce-mountable-secrets: "true"
# Disable automatic token mounting - pods don't need K8s API access
automountServiceAccountToken: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-proxy
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: nginx-proxy
    app.kubernetes.io/component: ingress
  annotations:
    # INFRA-H-05: Restrict which secrets this SA can mount
    kubernetes.io/enforce-mountable-secrets: "true"
# Disable automatic token mounting
automountServiceAccountToken: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
  annotations:
    # INFRA-H-05: Restrict which secrets this SA can mount
    kubernetes.io/enforce-mountable-secrets: "true"
# Disable automatic token mounting
automountServiceAccountToken: false
---
# Role with minimal permissions (none needed for our workloads)
# This ensures pods cannot access K8s API even if token is somehow mounted
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: canton-minimal
  namespace: musd-canton
rules: []  # No permissions - pure deny
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: canton-participant-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: canton-participant
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nginx-proxy-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: nginx-proxy
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: postgres-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: postgres
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
# INFRA-H-05: Dedicated ServiceAccount for backup CronJob
# Backup pods should have zero K8s API access
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres-backup
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/component: backup
  annotations:
    # INFRA-H-05: Prevent privilege escalation via SA impersonation
    kubernetes.io/enforce-mountable-secrets: "true"
automountServiceAccountToken: false
---
# INFRA-H-05: Bind backup SA to the same zero-permission role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: postgres-backup-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: postgres-backup
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
# INFRA-H-05: Explicit ClusterRole deny â€” prevent namespace-escaping API access
# Even if a pod somehow mounts a token, it cannot access cluster-wide resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: musd-canton-deny-all
  labels:
    app.kubernetes.io/part-of: minted-musd
rules: []  # No cluster-level permissions
---
# INFRA-H-05: Bind all namespace SAs to the cluster-level deny role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: musd-canton-deny-all-binding
  labels:
    app.kubernetes.io/part-of: minted-musd
subjects:
  - kind: Group
    name: system:serviceaccounts:musd-canton
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: musd-canton-deny-all
  apiGroup: rbac.authorization.k8s.io
