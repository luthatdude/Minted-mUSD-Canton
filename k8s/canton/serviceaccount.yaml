# ServiceAccount and RBAC for Canton deployment
# Explicit RBAC with least-privilege access
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: canton-participant
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: canton-participant
    app.kubernetes.io/component: ledger
# Disable automatic token mounting - pods don't need K8s API access
automountServiceAccountToken: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-proxy
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: nginx-proxy
    app.kubernetes.io/component: ingress
# Disable automatic token mounting
automountServiceAccountToken: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
# Disable automatic token mounting
automountServiceAccountToken: false
---
# Role with minimal permissions (none needed for our workloads)
# This ensures pods cannot access K8s API even if token is somehow mounted
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: canton-minimal
  namespace: musd-canton
rules: []  # No permissions - pure deny
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: canton-participant-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: canton-participant
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nginx-proxy-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: nginx-proxy
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: postgres-binding
  namespace: musd-canton
subjects:
  - kind: ServiceAccount
    name: postgres
    namespace: musd-canton
roleRef:
  kind: Role
  name: canton-minimal
  apiGroup: rbac.authorization.k8s.io
