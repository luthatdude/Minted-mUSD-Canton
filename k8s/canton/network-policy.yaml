# Network policies for Canton deployment
# Enforces least-privilege network access between components
---
# Canton participant: only accepts traffic from JSON API sidecar (localhost),
# relay service, and Prometheus scraping
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: canton-participant-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: canton-participant
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Ledger API — only from relay service pods
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: bridge-relay
      ports:
        - port: 5011
          protocol: TCP
    # JSON API — from NGINX proxy only (not external ingress controller)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx-proxy
      ports:
        - port: 7575
          protocol: TCP
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9090
          protocol: TCP
  egress:
    # PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - port: 5432
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    # Canton domain connection (external)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 5018
          protocol: TCP
---
# PostgreSQL: only accepts connections from Canton participant and JSON API
# INFRA-M-01: Added json-api to ingress allowlist
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: json-api
      ports:
        - port: 5432
          protocol: TCP
  egress:
    # DNS only
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
---
# NGINX proxy: accepts external traffic, proxies to JSON API
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-proxy-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nginx-proxy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # External HTTPS traffic restricted to LoadBalancer source.
    # Without a 'from' selector, ALL pods/namespaces could reach NGINX directly,
    # bypassing the LoadBalancer's WAF/Cloud Armor protection.
    - from:
        - ipBlock:
            cidr: "0.0.0.0/0"  # LoadBalancer forwards external traffic
            except:
              - "10.0.0.0/8"   # Block direct pod-to-pod bypass within cluster
              - "172.16.0.0/12"
              - "192.168.0.0/16"
      ports:
        - port: 8443
          protocol: TCP
        - port: 8080
          protocol: TCP
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 8443
          protocol: TCP
  egress:
    # JSON API on Canton participant (port 7575)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
      ports:
        - port: 7575
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# INFRA-H-05: NetworkPolicy for backup CronJob pods
# Backup pods only need egress to PostgreSQL and DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-backup-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres-backup
  policyTypes:
    - Ingress
    - Egress
  ingress: []  # No inbound traffic needed
  egress:
    # PostgreSQL only
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - port: 5432
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# INFRA-M-01: JSON API — only accepts traffic from NGINX ingress proxy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: json-api-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: json-api
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx-proxy
      ports:
        - port: 7575
          protocol: TCP
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9090
          protocol: TCP
  egress:
    # PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - port: 5432
          protocol: TCP
    # Canton participant Ledger API
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
      ports:
        - port: 5011
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# INFRA-M-01: Bridge relay — allowed internet egress for cross-chain bridging
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: bridge-relay-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: bridge-relay
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9090
          protocol: TCP
  egress:
    # Canton participant Ledger API
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
      ports:
        - port: 5011
          protocol: TCP
    # Internet egress for cross-chain RPC endpoints
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443
          protocol: TCP
        - port: 8545
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# INFRA-M-01: Validator — allowed internet egress for attestation submission
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: validator-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: validator
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9090
          protocol: TCP
  egress:
    # Internet egress for on-chain attestation submission
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443
          protocol: TCP
        - port: 8545
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# Default deny all ingress/egress in namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: musd-canton
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
