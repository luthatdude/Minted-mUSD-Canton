# Network policies for Canton deployment
# Enforces least-privilege network access between components
---
# Canton participant: only accepts traffic from JSON API sidecar (localhost),
# relay service, and Prometheus scraping
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: canton-participant-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: canton-participant
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Ledger API — only from relay service pods
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: bridge-relay
      ports:
        - port: 5011
          protocol: TCP
    # JSON API — from NGINX proxy only (not external ingress controller)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx-proxy
      ports:
        - port: 7575
          protocol: TCP
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 9090
          protocol: TCP
  egress:
    # PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - port: 5432
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    # Canton domain connection (external)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 5018
          protocol: TCP
---
# PostgreSQL: only accepts connections from Canton participant
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
      ports:
        - port: 5432
          protocol: TCP
  egress:
    # DNS only
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
---
# NGINX proxy: accepts external traffic, proxies to JSON API
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-proxy-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nginx-proxy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # External HTTPS traffic (from LoadBalancer)
    - ports:
        - port: 8443
          protocol: TCP
        - port: 8080
          protocol: TCP
    # Prometheus metrics scraping
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 8443
          protocol: TCP
  egress:
    # JSON API on Canton participant (port 7575)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: canton-participant
      ports:
        - port: 7575
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# INFRA-H-05: NetworkPolicy for backup CronJob pods
# Backup pods only need egress to PostgreSQL and DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-backup-netpol
  namespace: musd-canton
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres-backup
  policyTypes:
    - Ingress
    - Egress
  ingress: []  # No inbound traffic needed
  egress:
    # PostgreSQL only
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgres
      ports:
        - port: 5432
          protocol: TCP
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
---
# Default deny all ingress/egress in namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: musd-canton
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
