# NGINX reverse proxy configuration for Daml JSON API
# Handles TLS termination, rate limiting, request filtering, and security headers.
#
# NEVER expose the JSON API (port 7575) directly to the internet.
# All external traffic must go through this proxy.
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: nginx-proxy
    app.kubernetes.io/component: api-gateway
data:
  nginx.conf: |
    worker_processes auto;
    worker_rlimit_nofile 8192;
    pid /tmp/nginx.pid;

    events {
        worker_connections 4096;
        multi_accept on;
    }

    http {
        # ============================================================
        #  RATE LIMITING ZONES
        # ============================================================

        # Per-IP rate limiting — 10 requests/sec for reads
        limit_req_zone $binary_remote_addr zone=api_read:10m rate=10r/s;

        # Stricter limit for write operations — 2 requests/sec per IP
        limit_req_zone $binary_remote_addr zone=api_write:10m rate=2r/s;

        # INFRA-H-04: Reduced global rate limit from 500r/s to 200r/s to limit DoS amplification
        limit_req_zone $server_name zone=api_global:1m rate=200r/s;

        # Connection limit per IP
        limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

        # INFRA-H-04: Per-IP burst penalty zone — track IPs that exceed burst limits
        limit_req_zone $binary_remote_addr zone=api_penalty:5m rate=1r/s;

        # Rate limit responses
        limit_req_status 429;
        limit_conn_status 429;

        # ============================================================
        #  SECURITY DEFAULTS
        # ============================================================

        # Hide NGINX version
        server_tokens off;

        # Prevent MIME type sniffing
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'none'; frame-ancestors 'none'" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # Request size limits — prevent oversized payloads
        client_max_body_size 1m;
        client_body_buffer_size 16k;
        client_header_buffer_size 1k;
        large_client_header_buffers 4 8k;

        # Timeouts — prevent slow-loris attacks
        client_body_timeout 10s;
        client_header_timeout 10s;
        send_timeout 10s;
        keepalive_timeout 30s;
        keepalive_requests 100;

        # Logging
        log_format json_combined escape=json
            '{"time":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"method":"$request_method",'
            '"uri":"$uri",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"http_user_agent":"$http_user_agent",'
            '"rate_limit":"$limit_req_status"}';

        access_log /var/log/nginx/access.log json_combined;
        error_log /var/log/nginx/error.log warn;

        # Temp paths for non-root operation
        proxy_temp_path /tmp/proxy_temp;
        client_body_temp_path /tmp/client_temp;
        fastcgi_temp_path /tmp/fastcgi_temp;
        uwsgi_temp_path /tmp/uwsgi_temp;
        scgi_temp_path /tmp/scgi_temp;

        # ============================================================
        #  UPSTREAM — JSON API BACKEND
        # ============================================================

        upstream json_api {
            server canton-participant.musd-canton.svc.cluster.local:7575;
            keepalive 16;
        }

        # ============================================================
        #  HTTP → HTTPS REDIRECT
        # ============================================================

        server {
            listen 8080;
            server_name _;
            return 301 https://$host$request_uri;
        }

        # ============================================================
        #  HTTPS SERVER
        # ============================================================

        server {
            listen 8443 ssl;
            server_name api.musd-stablecoin.com;

            # TLS configuration
            ssl_certificate /etc/nginx/tls/tls.crt;
            ssl_certificate_key /etc/nginx/tls/tls.key;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
            ssl_prefer_server_ciphers on;
            ssl_session_cache shared:SSL:10m;
            ssl_session_timeout 10m;
            ssl_session_tickets off;
            ssl_stapling on;
            ssl_stapling_verify on;

            # INFRA-H-04: Reduced connection limit from 20 to 10 per IP
            limit_conn conn_limit 10;

            # --------------------------------------------------------
            #  READ ENDPOINTS — 10 req/s per IP, burst 20
            # --------------------------------------------------------

            # Query contracts (read-only)
            location /v1/query {
                limit_req zone=api_read burst=20 nodelay;
                limit_req zone=api_global burst=50 nodelay;

                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # Only allow POST (JSON API query format)
                limit_except POST {
                    deny all;
                }

                proxy_connect_timeout 5s;
                proxy_read_timeout 30s;
                proxy_send_timeout 5s;
            }

            # Fetch contract by ID (read-only)
            location /v1/fetch {
                limit_req zone=api_read burst=15 delay=10;
                limit_req zone=api_global burst=30 nodelay;

                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                limit_except POST {
                    deny all;
                }

                proxy_connect_timeout 5s;
                proxy_read_timeout 30s;
                proxy_send_timeout 5s;
            }

            # --------------------------------------------------------
            #  WRITE ENDPOINTS — 2 req/s per IP, burst 5
            # --------------------------------------------------------

            # Create contract (write)
            location /v1/create {
                # INFRA-H-04: Tighter write limits — burst=3, delay=1 to smooth spikes
                limit_req zone=api_write burst=3 delay=1;
                limit_req zone=api_global burst=30 nodelay;

                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                limit_except POST {
                    deny all;
                }

                proxy_connect_timeout 5s;
                proxy_read_timeout 60s;  # Writes may take longer (consensus)
                proxy_send_timeout 10s;
            }

            # Exercise choice (write)
            location /v1/exercise {
                # INFRA-H-04: Tighter write limits — burst=3, delay=1 to smooth spikes
                limit_req zone=api_write burst=3 delay=1;
                limit_req zone=api_global burst=30 nodelay;

                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                limit_except POST {
                    deny all;
                }

                proxy_connect_timeout 5s;
                proxy_read_timeout 60s;
                proxy_send_timeout 10s;
            }

            # --------------------------------------------------------
            #  HEALTH / METRICS — internal only
            # --------------------------------------------------------

            location /livez {
                # INFRA-M-03: Restrict health probes to cluster-internal IPs only.
                # Prevents external actors from probing internal health state.
                allow 10.0.0.0/8;
                allow 172.16.0.0/12;
                allow 192.168.0.0/16;
                deny all;
                # INFRA-H-04: Rate limit health endpoints to prevent monitoring-based DoS
                limit_req zone=api_read burst=5 nodelay;
                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                access_log off;
            }

            location /readyz {
                # INFRA-M-03: Restrict health probes to cluster-internal IPs only.
                # Prevents external actors from probing internal health state.
                allow 10.0.0.0/8;
                allow 172.16.0.0/12;
                allow 192.168.0.0/16;
                deny all;
                # INFRA-H-04: Rate limit health endpoints to prevent monitoring-based DoS
                limit_req zone=api_read burst=5 nodelay;
                proxy_pass http://json_api;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                access_log off;
            }

            # NGINX stub status for Prometheus scraping
            location /nginx_status {
                stub_status;
                allow 10.0.0.0/8;      # Cluster-internal only
                allow 172.16.0.0/12;
                allow 192.168.0.0/16;
                deny all;
                access_log off;
            }

            # --------------------------------------------------------
            #  DENY EVERYTHING ELSE
            # --------------------------------------------------------

            # Block admin/party endpoints — these should never be exposed
            location /v1/parties {
                return 403;
            }

            location /v1/packages {
                return 403;
            }

            # Catch-all — deny unknown paths
            location / {
                return 404;
            }
        }
    }
