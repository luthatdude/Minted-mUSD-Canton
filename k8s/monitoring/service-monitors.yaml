# Minted Protocol - ServiceMonitor Definitions
# INFRA-H-03: Prometheus service discovery for all Canton namespace services.
# Requires prometheus-operator CRDs (ServiceMonitor, PodMonitor).
#
# INFRA-M-05: Label selectors MUST match the actual Service labels.
# Services use app.kubernetes.io/name labels (not bare "app:" labels).
# Verify selectors match by running: kubectl get svc -n musd-canton --show-labels
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: canton-participant-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: canton-participant
spec:
  selector:
    matchLabels:
      # INFRA-H-01/M-05: Use standard K8s label to match actual Service labels
      app.kubernetes.io/name: canton-participant
  endpoints:
    - port: ledger-api
      interval: 15s
      path: /metrics
      scheme: http
      tlsConfig:
        insecureSkipVerify: false
  namespaceSelector:
    matchNames:
      - musd-canton
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: nginx-proxy-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: nginx-proxy
spec:
  selector:
    matchLabels:
      # INFRA-H-01/M-05: Use standard K8s label to match actual Service labels
      app.kubernetes.io/name: nginx-proxy
  endpoints:
    - port: https
      interval: 15s
      path: /nginx_status
      scheme: https
      tlsConfig:
        insecureSkipVerify: true  # Self-signed internal cert for metrics scraping
  namespaceSelector:
    matchNames:
      - musd-canton
---
# INFRA-M-06: Scrapes the postgres-exporter sidecar (port 9187) added to the PostgreSQL StatefulSet.
# Provides pg_stat_activity, connection counts, replication lag, query duration, lock metrics, etc.
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgres-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: postgres
spec:
  selector:
    matchLabels:
      # INFRA-H-01/M-05: Use standard K8s label to match actual Service labels
      app.kubernetes.io/name: postgres
  endpoints:
    # INFRA-M-06: Targets the postgres-exporter sidecar's metrics port (9187)
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - musd-canton
---
# PodMonitor for relay services (no Service object â€” metrics exposed on sidecar)
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: bridge-relay-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: bridge-relay
spec:
  selector:
    matchLabels:
      # INFRA-H-01: Use standard K8s label to match deployment labels
      app.kubernetes.io/name: bridge-relay
  podMetricsEndpoints:
    - port: health
      interval: 15s
      path: /metrics
  namespaceSelector:
    matchNames:
      - musd-canton
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: price-oracle-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: price-oracle
spec:
  selector:
    matchLabels:
      # INFRA-H-01: Use standard K8s label
      app.kubernetes.io/name: price-oracle
  podMetricsEndpoints:
    - port: health
      interval: 15s
      path: /metrics
  namespaceSelector:
    matchNames:
      - musd-canton
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: yield-sync-metrics
  namespace: musd-canton
  labels:
    app: minted
    component: yield-sync
spec:
  selector:
    matchLabels:
      # INFRA-H-01: Use standard K8s label
      app.kubernetes.io/name: yield-sync
  podMetricsEndpoints:
    - port: health
      interval: 30s
      path: /metrics
  namespaceSelector:
    matchNames:
      - musd-canton
