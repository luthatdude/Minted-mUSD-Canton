# Minted mUSD Protocol — Prometheus Alerting Rules
# FIX: Addresses audit finding for missing monitoring/alerting (P0 operational gap)

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: musd-protocol-alerts
  namespace: musd
  labels:
    app: musd-relay
    release: prometheus
spec:
  groups:
    # ══════════════════════════════════════════════════════════
    #  BRIDGE & RELAY HEALTH
    # ══════════════════════════════════════════════════════════
    - name: musd-bridge-health
      rules:
        - alert: RelayServiceDown
          expr: up{job="musd-relay"} == 0
          for: 2m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "Relay service is down"
            description: "The mUSD relay service has been unreachable for >2 minutes. Bridge operations are halted."
            runbook_url: "https://github.com/luthatdude/Minted-mUSD-Canton/blob/main/docs/RUNBOOKS.md#relay-service-down"

        - alert: ValidatorServiceDown
          expr: up{job="musd-validator"} == 0
          for: 2m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "Validator {{ $labels.instance }} is down"
            description: "A bridge validator has been unreachable for >2 minutes. If 2+ validators are down, bridge attestations will fail."

        - alert: BridgeAttestationBacklog
          expr: musd_pending_attestations > 10
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Bridge attestation backlog growing"
            description: "{{ $value }} pending attestations — possible validator quorum issue."

        - alert: BridgeAttestationStale
          expr: time() - musd_last_attestation_timestamp > 3600
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "No bridge attestations in >1 hour"
            description: "Last attestation was {{ $value | humanizeDuration }} ago."

    # ══════════════════════════════════════════════════════════
    #  SUPPLY & RESERVE INTEGRITY
    # ══════════════════════════════════════════════════════════
    - name: musd-supply-integrity
      rules:
        - alert: SupplyCapApproaching
          expr: musd_total_supply / musd_supply_cap > 0.90
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "mUSD supply at {{ $value | humanizePercentage }} of cap"
            description: "Supply is approaching the global supply cap. New mints may be blocked soon."

        - alert: SupplyCapBreached
          expr: musd_total_supply > musd_supply_cap
          for: 1m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "mUSD supply EXCEEDS cap"
            description: "Total supply {{ $value }} exceeds the supply cap. This should never happen."

        - alert: ReserveRatioBelowThreshold
          expr: musd_usdc_reserves / musd_total_supply < 0.99
          for: 10m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "USDC reserve ratio below 99%"
            description: "Reserve ratio is {{ $value | humanizePercentage }}. mUSD may be undercollateralized."

    # ══════════════════════════════════════════════════════════
    #  LENDING & LIQUIDATION
    # ══════════════════════════════════════════════════════════
    - name: musd-lending-health
      rules:
        - alert: LendingUtilizationHigh
          expr: musd_lending_total_borrows / musd_lending_supply_cap > 0.85
          for: 10m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Lending utilization at {{ $value | humanizePercentage }}"
            description: "High lending utilization may indicate interest rate model needs adjustment."

        - alert: LiquidationSurge
          expr: rate(musd_liquidation_count[5m]) > 5
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Liquidation surge detected"
            description: "{{ $value }} liquidations/min — possible market crash or oracle issue."

        - alert: OraclePriceStale
          expr: time() - musd_oracle_last_update_timestamp > 600
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Oracle price feed stale for {{ $labels.asset }}"
            description: "Price feed for {{ $labels.asset }} not updated in {{ $value | humanizeDuration }}. Borrows/withdrawals will be blocked."

    # ══════════════════════════════════════════════════════════
    #  STAKING (smUSD)
    # ══════════════════════════════════════════════════════════
    - name: musd-staking-health
      rules:
        - alert: SharePriceDecreaseAnomaly
          expr: delta(musd_smusd_share_price[1h]) / musd_smusd_share_price < -0.05
          for: 5m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "smUSD share price dropped >5% in 1 hour"
            description: "Share price decrease from {{ $value }}. Possible strategy loss or oracle manipulation."

        - alert: YieldSyncStale
          expr: time() - musd_last_yield_sync_timestamp > 86400
          for: 30m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Yield sync not executed in >24 hours"
            description: "Canton share price is stale. Cross-chain yield distribution is lagging."

    # ══════════════════════════════════════════════════════════
    #  INFRASTRUCTURE
    # ══════════════════════════════════════════════════════════
    - name: musd-infrastructure
      rules:
        - alert: CantonParticipantDown
          expr: up{job="canton-participant"} == 0
          for: 2m
          labels:
            severity: critical
            team: infra
          annotations:
            summary: "Canton participant node is down"
            description: "The Canton participant has been unreachable for >2 minutes. All Canton operations are halted."

        - alert: PostgresDown
          expr: up{job="postgres"} == 0
          for: 2m
          labels:
            severity: critical
            team: infra
          annotations:
            summary: "PostgreSQL database is down"
            description: "Canton ledger database is unreachable."

        - alert: HighMemoryUsage
          expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.85
          for: 5m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "Container {{ $labels.container }} memory at {{ $value | humanizePercentage }}"
            description: "Container approaching memory limit. May be OOM-killed."

        - alert: HighCPUUsage
          expr: rate(container_cpu_usage_seconds_total[5m]) / container_spec_cpu_quota * container_spec_cpu_period > 0.85
          for: 10m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "Container {{ $labels.container }} CPU at {{ $value | humanizePercentage }}"

        - alert: PodRestartLoop
          expr: rate(kube_pod_container_status_restarts_total{namespace="musd"}[15m]) > 0.1
          for: 5m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "Pod {{ $labels.pod }} is restart-looping"
            description: "{{ $value }} restarts/min. Check logs for crash cause."

        - alert: PVCNearlyFull
          expr: kubelet_volume_stats_used_bytes{namespace="musd"} / kubelet_volume_stats_capacity_bytes > 0.85
          for: 10m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} at {{ $value | humanizePercentage }} capacity"

        - alert: CertificateExpiringSoon
          expr: certmanager_certificate_expiration_timestamp_seconds - time() < 604800
          for: 1h
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "TLS certificate expiring in < 7 days"
            description: "Certificate {{ $labels.name }} expires in {{ $value | humanizeDuration }}."

    # ══════════════════════════════════════════════════════════
    #  BOT SERVICE HEALTH
    # ══════════════════════════════════════════════════════════
    - name: musd-bot-health
      rules:
        - alert: LiquidationBotDown
          expr: up{job="musd-liquidation-bot"} == 0
          for: 3m
          labels:
            severity: critical
            team: protocol
          annotations:
            summary: "Liquidation bot is down"
            description: "The liquidation bot has been unreachable for >3 minutes. Under-collateralized positions will not be liquidated."
            runbook_url: "https://github.com/luthatdude/Minted-mUSD-Canton/blob/main/docs/RUNBOOKS.md#liquidation-surge"

        - alert: OracleKeeperDown
          expr: up{job="musd-oracle-keeper"} == 0
          for: 5m
          labels:
            severity: high
            team: protocol
          annotations:
            summary: "Oracle keeper bot is down"
            description: "The PriceOracle circuit-breaker keeper has been unreachable for >5 minutes. Tripped circuit breakers will not auto-reset."

        - alert: PendleSniperDown
          expr: up{job="musd-pendle-sniper"} == 0
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Pendle sniper bot is down"
            description: "The Pendle pool sniper has been unreachable for >5 minutes. New Pendle opportunities will be missed."

        - alert: PoolAlertBotDown
          expr: up{job="musd-pool-alerts"} == 0
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Pool alert bot is down"
            description: "The DeFi pool alert service has been unreachable for >5 minutes. New pool notifications are not being sent."

        - alert: BotHighRestartRate
          expr: rate(kube_pod_container_status_restarts_total{namespace="musd", container=~"liquidation-bot|oracle-keeper|pendle-sniper|pool-alerts"}[30m]) > 0.1
          for: 5m
          labels:
            severity: warning
            team: protocol
          annotations:
            summary: "Bot {{ $labels.container }} is restart-looping"
            description: "{{ $value }} restarts/min. Check logs and RPC connectivity."

    # ══════════════════════════════════════════════════════════
    #  RPC ENDPOINT HEALTH
    # ══════════════════════════════════════════════════════════
    - name: musd-rpc-health
      rules:
        - alert: RpcEndpointDown
          expr: probe_success{job="musd-rpc-probe"} == 0
          for: 2m
          labels:
            severity: critical
            team: infra
          annotations:
            summary: "RPC endpoint {{ $labels.instance }} is unreachable"
            description: "The Ethereum RPC endpoint has been down for >2 minutes. All on-chain operations are blocked."

        - alert: RpcHighLatency
          expr: probe_duration_seconds{job="musd-rpc-probe"} > 5
          for: 5m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "RPC latency >5s on {{ $labels.instance }}"
            description: "Current latency: {{ $value }}s. May cause transaction timeouts and bot failures."

        - alert: RpcHighErrorRate
          expr: rate(musd_rpc_errors_total[5m]) / rate(musd_rpc_requests_total[5m]) > 0.05
          for: 5m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "RPC error rate >5% on {{ $labels.instance }}"
            description: "{{ $value | humanizePercentage }} of RPC requests are failing. Check provider status."

        - alert: WebSocketDisconnectFrequent
          expr: rate(musd_ws_disconnect_total[15m]) > 0.2
          for: 5m
          labels:
            severity: warning
            team: infra
          annotations:
            summary: "Frequent WebSocket disconnects on {{ $labels.instance }}"
            description: "{{ $value }} disconnects/min. May indicate unstable RPC provider or network issues."
