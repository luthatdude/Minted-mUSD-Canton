apiVersion: apps/v1
kind: Deployment
metadata:
  name: security-sentinel
  namespace: musd-canton
  labels:
    app: security-sentinel
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: security-sentinel
  template:
    metadata:
      labels:
        app: security-sentinel
        component: monitoring
    spec:
      # INFRA-C-01 FIX: Dedicated ServiceAccount with zero permissions
      serviceAccountName: liquidation-bot
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: sentinel
          # INFRA-C-01 FIX: Pin image by SHA256 digest (same build as liquidation-bot)
          # Previously used mutable 'minted/bot:latest' â€” supply-chain risk
          image: ghcr.io/minted-protocol/liquidation-bot@sha256:49d1cbc0d8f39bf7fe7d86769522b2acea68eee6e092e0311145760691580588
          command: ["node", "dist/security-sentinel.js"]
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          env:
            - name: RPC_URL
              valueFrom:
                secretKeyRef:
                  name: minted-rpc
                  key: rpc-url
            - name: WS_RPC_URL
              valueFrom:
                secretKeyRef:
                  name: minted-rpc
                  key: ws-rpc-url
            - name: TELEGRAM_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: minted-telegram
                  key: bot-token
            - name: TELEGRAM_CHAT_ID
              valueFrom:
                secretKeyRef:
                  name: minted-telegram
                  key: chat-id
            - name: GUARDIAN_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: minted-guardian
                  key: private-key
                  optional: true
            - name: DEPLOYER_ADDRESS
              value: "0xe640db3Ad56330BFF39Da36Ef01ab3aEB699F8e0"
            - name: TRUSTED_ADDRESSES
              value: "0xe640db3Ad56330BFF39Da36Ef01ab3aEB699F8e0,0xcF1473dFdBFf5BDAd66730a01316d4A74B2dA410"
            - name: LARGE_MINT_THRESHOLD_USD
              value: "100000"
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          livenessProbe:
            exec:
              command: ["pgrep", "-f", "security-sentinel"]
            initialDelaySeconds: 10
            periodSeconds: 30
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 64Mi
      restartPolicy: Always
