# PostgreSQL for Canton participant storage
# Canton participants are stateful — they MUST NOT run multiple replicas
# without a shared database backend and sequencer coordination.
#
# INFRA-M-09: PostgreSQL High Availability
# This StatefulSet runs 2 replicas (primary + standby) to eliminate single point of failure.
# IMPORTANT: Full HA requires a Patroni sidecar or similar controller to manage:
#   1. Leader election and automatic failover
#   2. Streaming replication from primary to standby
#   3. Promotion of standby to primary on failure
#
# Production HA deployment options:
#   - Patroni (recommended): Add patroni sidecar + etcd/ZooKeeper for consensus
#   - Crunchy PGO: Use CrunchyData PostgreSQL Operator for managed HA
#   - CloudNativePG: Use the CloudNativePG operator (cnpg.io)
#
# Until a HA controller is deployed, the second replica will be a cold standby.
# Configure streaming replication by setting primary_conninfo on the standby.
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
spec:
  type: ClusterIP
  ports:
    # INFRA-M-04: Clients connect to PgBouncer (6432) for connection pooling.
    # Direct postgres access (5432) is available but should only be used for admin tasks.
    - name: pgbouncer
      port: 5432
      targetPort: 6432
      protocol: TCP
    - name: postgres-direct
      port: 5433
      targetPort: 5432
      protocol: TCP
    # INFRA-M-06: Metrics port for postgres-exporter (Prometheus scraping)
    - name: metrics
      port: 9187
      targetPort: 9187
      protocol: TCP
  selector:
    app.kubernetes.io/name: postgres
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: musd-canton
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
  annotations:
    # INFRA-M-09: HA placeholder — configure streaming replication before scaling.
    # See: https://www.postgresql.org/docs/16/warm-standby.html
    musd.io/ha-status: "placeholder-requires-patroni-or-operator"
    musd.io/ha-controller: "none — deploy Patroni, CrunchyPGO, or CloudNativePG"
    musd.io/replication-mode: "streaming-async"
spec:
  serviceName: postgres
  # INFRA-M-09: Increased from 1 to 2 for HA (primary + standby).
  # WARNING: A HA controller (Patroni/operator) MUST be deployed to manage
  # leader election and replication. Without it, the second pod is a cold standby.
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgres
        app.kubernetes.io/component: database
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: postgres
          # Pin to SHA256 digest for supply chain security
          # To update: docker pull postgres:16.4-alpine && docker inspect --format='{{index .RepoDigests 0}}' postgres:16.4-alpine
          image: postgres:16.4-alpine@sha256:d898b0b78a2627cb4ee63464a14571e0a38aae2c66a9e0d7c5a44715c7bdc744
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              value: canton
            # INFRA-H-03: Use _FILE variants to read credentials from mounted secrets
            # instead of injecting via environment variables (prevents /proc exposure)
            - name: POSTGRES_USER_FILE
              value: /run/secrets/db-username
            - name: POSTGRES_PASSWORD_FILE
              value: /run/secrets/db-password
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            # INFRA-M-02: Server-side TLS is enabled via container args below.
            # TLS cert and key must be mounted at /etc/postgresql/tls/ (owned by uid 999).
            # Use cert-manager or external-secrets to provision per-environment certificates.
          # INFRA-M-02: Pass SSL args to postgres to enforce server-side TLS
          args:
            - "-c"
            - "ssl=on"
            - "-c"
            - "ssl_cert_file=/etc/postgresql/tls/tls.crt"
            - "-c"
            - "ssl_key_file=/etc/postgresql/tls/tls.key"
            - "-c"
            - "ssl_ca_file=/etc/postgresql/tls/ca.crt"
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "2"
              memory: 4Gi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: tmp
              mountPath: /tmp
            - name: run
              mountPath: /var/run/postgresql
            # INFRA-M-02: Mount TLS certificates for server-side SSL.
            # Certificates must be provisioned via cert-manager or external-secrets.
            # Key file must be readable by postgres user (uid 999) and mode 0600.
            - name: postgres-tls
              mountPath: /etc/postgresql/tls
              readOnly: true
            # INFRA-H-03: Mount DB credentials as files instead of env vars
            - name: db-credentials
              mountPath: /run/secrets/db-username
              subPath: username
              readOnly: true
            - name: db-credentials
              mountPath: /run/secrets/db-password
              subPath: password
              readOnly: true
          livenessProbe:
            exec:
              command:
                # INFRA-H-03: Read username from mounted secret file
                - /bin/sh
                - -c
                - pg_isready -U "$(cat /run/secrets/db-username)" -d canton
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          readinessProbe:
            exec:
              command:
                # INFRA-H-03: Read username from mounted secret file
                - /bin/sh
                - -c
                - pg_isready -U "$(cat /run/secrets/db-username)" -d canton
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
        # INFRA-M-04: PgBouncer sidecar for connection pooling.
        # Prevents connection exhaustion by multiplexing application connections
        # to a smaller pool of PostgreSQL server connections.
        # Transaction-mode pooling allows connection reuse between transactions.
        - name: pgbouncer
          image: bitnami/pgbouncer:1.23.1@sha256:ac04c2b6f45e97792e9ab3a7c5b0e92db96db9af8a24ee10eb4c5a17f4df3254
          ports:
            - name: pgbouncer
              containerPort: 6432
              protocol: TCP
          env:
            - name: PGBOUNCER_DATABASE
              value: canton
            - name: POSTGRESQL_HOST
              value: "127.0.0.1"
            - name: POSTGRESQL_PORT
              value: "5432"
            # INFRA-M-04: Transaction-mode pooling — connections returned to pool after each transaction.
            # This is the recommended mode for Canton (uses short-lived transactions).
            - name: PGBOUNCER_POOL_MODE
              value: transaction
            # Max client connections PgBouncer will accept
            - name: PGBOUNCER_MAX_CLIENT_CONN
              value: "200"
            # Max server connections to PostgreSQL (should be < max_connections in PG)
            - name: PGBOUNCER_DEFAULT_POOL_SIZE
              value: "20"
            - name: PGBOUNCER_MIN_POOL_SIZE
              value: "5"
            - name: PGBOUNCER_RESERVE_POOL_SIZE
              value: "5"
            - name: PGBOUNCER_RESERVE_POOL_TIMEOUT
              value: "3"
            # INFRA-H-01: Removed secretKeyRef env vars (visible in /proc/<pid>/environ).
            # Credentials are loaded from file-mounted secrets via entrypoint wrapper.
          # INFRA-H-01: Wrap entrypoint to load credentials from mounted secret files
          command:
            - /bin/sh
            - -c
            - |
              export POSTGRESQL_USERNAME="$(cat /run/secrets/db-username)"
              export POSTGRESQL_PASSWORD="$(cat /run/secrets/db-password)"
              exec /opt/bitnami/scripts/pgbouncer/entrypoint.sh /opt/bitnami/scripts/pgbouncer/run.sh
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: pgbouncer-tmp
              mountPath: /tmp
            # INFRA-H-01: Mount DB credentials as files
            - name: db-credentials
              mountPath: /run/secrets/db-username
              subPath: username
              readOnly: true
            - name: db-credentials
              mountPath: /run/secrets/db-password
              subPath: password
              readOnly: true
          livenessProbe:
            tcpSocket:
              port: 6432
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 6432
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
        # INFRA-M-06: postgres-exporter sidecar — exposes PostgreSQL metrics for Prometheus.
        # Provides connection count, query stats, replication lag, lock metrics, etc.
        # Metrics available at :9187/metrics
        - name: postgres-exporter
          image: prometheuscommunity/postgres-exporter:v0.15.0@sha256:66ee58d625cc50a79e767e1c1082855f38fa3b2e33e03f67e6f2e97a3aa16cc5
          ports:
            - name: metrics
              containerPort: 9187
              protocol: TCP
          env:
            # Connect to the local postgres instance for metrics collection
            - name: DATA_SOURCE_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: username
            - name: DATA_SOURCE_PASS
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: password
            - name: DATA_SOURCE_URI
              # INFRA-H-02: Use sslmode=require (postgres has TLS enabled via args)
              value: "127.0.0.1:5432/canton?sslmode=require"
            # Disable default metrics that require superuser and enable safe collectors
            - name: PG_EXPORTER_DISABLE_DEFAULT_METRICS
              value: "false"
            - name: PG_EXPORTER_DISABLE_SETTINGS_METRICS
              value: "false"
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              cpu: 200m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          livenessProbe:
            httpGet:
              path: /metrics
              port: 9187
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9187
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        # INFRA-M-02: PostgreSQL server TLS certificates.
        # Secret must contain: tls.crt (server cert), tls.key (private key), ca.crt (CA cert).
        # Use cert-manager to auto-provision and rotate. Key file mode 0600 for postgres user.
        - name: postgres-tls
          secret:
            secretName: postgres-tls
            defaultMode: 0600
        # INFRA-H-03: DB credentials mounted as files (read from /run/secrets/)
        - name: db-credentials
          secret:
            secretName: postgres-credentials
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi
        - name: run
          emptyDir:
            sizeLimit: 10Mi
        # INFRA-M-04: Temp dir for PgBouncer sidecar
        - name: pgbouncer-tmp
          emptyDir:
            sizeLimit: 10Mi
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3-encrypted
        resources:
          requests:
            storage: 100Gi
