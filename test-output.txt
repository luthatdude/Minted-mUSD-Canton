[dotenv@17.2.3] injecting env (3) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops


  BLEBridgeV9
    Initialization
      âœ” Should initialize with correct parameters
      âœ” Should reject initialization with zero minSigs
      âœ” Should reject initialization with one minSig
      âœ” Should reject initialization with zero MUSD address
      âœ” Should reject initialization with ratio below 100%
    Attestation Processing
      âœ” Should process valid attestation with sufficient signatures
      âœ” Should reject attestation with insufficient signatures
      âœ” Should reject attestation with wrong nonce
      âœ” Should reject reused attestation ID
      âœ” Should reject unsorted signatures
      âœ” Should reject future timestamp
      âœ” Should reject stale attestation
    Rate Limiting
      âœ” Should enforce daily cap increase limit
      âœ” Should reset rate limit after 24 hours
    Emergency Functions
      âœ” Should allow emergency role to pause
      âœ” Should require admin role to unpause
      âœ” Should allow emergency cap reduction
      âœ” Should reject cap increase via emergency function
      âœ” Should invalidate attestation IDs
    Admin Functions
      âœ” Should update min signatures
      âœ” Should update collateral ratio with cooldown
      âœ” Should reject ratio change > 10%
      âœ” Should update daily cap increase limit
    Paused State
      âœ” Should reject attestations when paused
    BRIDGE-M-04: Relayer Access Control
      âœ” Should reject processAttestation from non-relayer
      âœ” Should allow processAttestation from granted relayer
      âœ” Should reject processAttestation after relayer role is revoked
    Bridge to Canton (ETH â†’ Canton)
      âœ” Should bridge mUSD to Canton successfully
      âœ” Should increment nonce on each bridge-out
      âœ” Should emit unique requestIds for each bridge-out
      âœ” Should reject zero amount
      âœ” Should reject amount below minimum
      âœ” Should reject empty canton recipient
      âœ” Should reject canton recipient without :: delimiter
      âœ” Should accept canton recipient with valid :: delimiter
      âœ” Should reject when paused
      âœ” Should reject when user has insufficient balance
      âœ” Should reject when user has not approved bridge
      âœ” Should allow admin to update bridge-out minimum
      âœ” Should allow zero minimum (no minimum enforcement)
      âœ” Should restrict setBridgeOutMinAmount to admin

  BorrowModule
    Deployment
      âœ” Should initialize with correct parameters
      âœ” Should set interest rate correctly
      âœ” Should set minimum debt correctly
    Borrowing
      âœ” Should allow borrowing against collateral
      âœ” Should reject borrow exceeding LTV
      âœ” Should reject borrow below minimum debt
      âœ” Should emit Borrowed event
    Repayment
      âœ” Should allow full repayment
      âœ” Should accrue interest over time and require more to repay
      âœ” Should emit Repaid event
    Health Factor
      âœ” Should calculate correct health factor
      âœ” Should return max health factor with no debt
    Interest Accrual
      âœ” Should accrue interest over time
    Collateral Withdrawal
      âœ” Should allow withdrawal while maintaining health
      âœ” Should prevent withdrawal that would make position unhealthy
    View Functions
      âœ” Should return max borrow amount correctly
    Admin Functions
      âœ” Should allow admin to set interest rate
      âœ” Should reject interest rate above maximum
      âœ” Should reject non-admin setting interest rate
      âœ” Should allow admin to set minimum debt

  BorrowModule â€” Extended Coverage
    borrowFor / repayFor
      âœ” leverageVault role can borrowFor a user
      âœ” borrowFor reverts from non-LEVERAGE_VAULT_ROLE
      âœ” leverageVault role can repayFor a user
      âœ” repayFor reverts from non-LEVERAGE_VAULT_ROLE
    reduceDebt / absorbBadDebt
      âœ” liquidator can reduceDebt for a user
      âœ” reduceDebt reverts from non-LIQUIDATION_ROLE
      âœ” absorbBadDebt adds to protocol bad debt
      âœ” absorbBadDebt reverts with zero amount
      âœ” absorbBadDebt reverts from non-LIQUIDATION_ROLE
    Admin config functions
      âœ” timelock can setInterestRateModel
      âœ” setInterestRateModel reverts with zero address
      âœ” setInterestRateModel reverts from non-timelock
      âœ” timelock can setSMUSD
      âœ” setSMUSD reverts with zero address
      âœ” timelock can setTreasury
      âœ” setTreasury reverts with zero address
    withdrawReserves
      âœ” reverts when no reserves exist
      âœ” reverts with zero address recipient
      âœ” reverts from non-TIMELOCK_ROLE
    Pause/Unpause
      âœ” pauser can pause
      âœ” timelock can unpause
      âœ” pause reverts from non-PAUSER_ROLE
      âœ” unpause reverts from non-TIMELOCK_ROLE
    Interest accrual
      âœ” accrueInterest updates user position after time passes
      âœ” accrueGlobalInterest updates protocol totals
      âœ” accrueInterest with dynamic rate model
    drainPendingInterest
      âœ” reverts when no pending interest
      âœ” reverts from non-TIMELOCK_ROLE
    reconcileTotalBorrows
      âœ” borrowAdmin can reconcile with valid borrower list
      âœ” reverts from non-BORROW_ADMIN_ROLE
    View functions
      âœ” getUtilizationRate returns 0 with no borrows
      âœ” getCurrentBorrowRate returns fallback rate with no model
      âœ” getCurrentBorrowRate returns model rate when set
      âœ” getCurrentSupplyRate returns a value with no borrows
      âœ” getCurrentSupplyRate with dynamic model + borrows
      âœ” getTotalSupply returns a default with no treasury
      âœ” borrowCapacity reflects available capacity
      âœ” healthFactorUnsafe returns value for active position

  TEST-003: parseInt radix 10 correctness
    âœ” should parse standard decimal port strings correctly
    âœ” should parse poll interval and retry config strings
    âœ” should not misinterpret leading zeros as octal
    âœ” should return NaN for empty or non-numeric strings
    âœ” should parse negative numbers correctly
    âœ” should truncate floating point strings to integer

  TEST-003: RPC URL transport security validation
    âœ” should flag http:// URLs to remote hosts as insecure
    âœ” should NOT flag https:// URLs as insecure
    âœ” should NOT flag localhost HTTP URLs (dev environment)
    âœ” should NOT flag 127.0.0.1 HTTP URLs (loopback)
    âœ” should NOT flag empty string
    âœ” should handle URLs with paths correctly

  TEST-003: unhandledRejection handling pattern
    âœ” process should have at least one unhandledRejection listener
    âœ” should be possible to register and remove an unhandledRejection listener
    âœ” unhandledRejection handler receives reason and promise

  TEST-003: Graceful shutdown patterns
    âœ” should support SIGTERM listener registration and removal
    âœ” should support SIGINT listener registration and removal
    âœ” YieldScanner can be stopped gracefully
    âœ” YieldScanner getBestOpportunity returns null before first scan
    âœ” YieldScanner getLastScan returns null before first scan

  TEST-003: Configuration validation patterns
    Default config values
      âœ” YieldScanner defaults should have sane minimums
      âœ” YieldScanner config override should merge correctly
    JSON size bounds (B-H03)
      âœ” normal validator config should be well under 10KB limit
      âœ” bloated config should exceed 10KB limit
    Environment variable fallback patterns
      âœ” OR-fallback produces correct default for missing env vars
      âœ” OR-fallback preserves env var value when set
      âœ” boolean config from env var string comparison

  TEST-003: YieldScanner scan and filter logic
    âœ” scan() should return a valid ScanResult structure
    âœ” scan() should update lastScan cache
    âœ” getBestOpportunity returns null when no opportunities exist
    âœ” opportunity filtering by APY/risk/TVL thresholds works correctly
    âœ” risk-adjusted sorting ranks higher APY/lower risk first

  Bridge Nonce Sync (Canton â†” Solidity)
    Initialization
      âœ” Both Solidity nonce counters start at 0
      âœ” DAML model starts at 0 matching Solidity
    Inbound attestation nonce (Cantonâ†’ETH)
      âœ” Sequential attestations increment currentNonce 1-by-1
      âœ” Rejects nonce gap (skipping nonce 2)
      âœ” Rejects nonce replay (re-submitting nonce 1)
      âœ” Rejects nonce 0 (must start at 1)
    Outbound bridge-out nonce (ETHâ†’Canton)
      âœ” bridgeOutNonce increments independently of currentNonce
    Cross-direction nonce independence
      âœ” Interleaved bridge-in/out maintains both counters correctly
    DAML BridgeService single-counter desync risk
      âœ” Models DAML single-counter desync: bridge-out then bridge-in
      âœ” Models DAML single-counter desync: multiple bridge-outs before bridge-in
      âœ” Models correct behavior: pure bridge-in sequence (no desync)
      âœ” Models correct behavior: pure bridge-out sequence (no desync)
      âœ” Models fixed architecture: separate directional nonce counters
    forceUpdateNonce emergency recovery
      âœ” Can recover from stuck nonce via emergency function
      âœ” forceUpdateNonce must be strictly increasing
      âœ” forceUpdateNonce doesn't affect bridgeOutNonce
      âœ” forceUpdateNonce requires EMERGENCY_ROLE
      âœ” forceUpdateNonce requires reason
    High-volume nonce stress
      âœ” 20 sequential attestations maintain strict monotonicity (40ms)
      âœ” Interleaved bridge-in/out over 30 operations (41ms)
    Nonce after forceUpdate + resumed attestations
      âœ” Attestation after forceUpdate must use new nonce + 1

  CollateralVault
    Collateral Config
      âœ” should add collateral with correct parameters
      âœ” should reject duplicate collateral add
      âœ” should reject zero address collateral
      âœ” should reject factor >= threshold
      âœ” should reject threshold > 95%
      âœ” should reject penalty > 20%
      âœ” should cap at 50 supported tokens (59ms)
      âœ” should disable and re-enable collateral
      âœ” should reject deposits on disabled collateral
      âœ” should reject unauthorized config changes
    Deposits
      âœ” should accept deposits
      âœ” should reject zero amount deposits
      âœ” should reject deposits for unsupported tokens
      âœ” should emit Deposited event
      âœ” depositFor: should credit deposit to specified user
      âœ” depositFor: should reject from non-LEVERAGE_VAULT_ROLE
    Withdrawals
      âœ” should allow withdrawal via BORROW_MODULE_ROLE
      âœ” should reject over-withdrawal
      âœ” should reject unauthorized withdrawal
      âœ” withdrawFor: should send collateral to specified recipient
      âœ” withdrawFor: should reject zero recipient
    Seize
      âœ” should seize collateral to liquidator
      âœ” should reject seize exceeding deposit
      âœ” should reject seize without LIQUIDATION_ROLE
    View Functions
      âœ” should return correct deposit amount
      âœ” should return supported tokens list

  BLEBridgeV9 â€” Coverage Boost
    View Functions
      âœ” getCurrentSupplyCap should return MUSD supply cap
      âœ” getRemainingMintable should return cap - totalSupply
      âœ” calculateSupplyCap should return assets / collateralRatio
      âœ” getNetDailyCapIncrease should return 0 initially
      âœ” getRemainingDailyCapLimit should return full limit initially
      âœ” getHealthRatio should return max uint256 when no supply
      âœ” getHealthRatio should return correct ratio after attestation
    MUSD Token â€” setMUSDToken
      âœ” Should update MUSD token via setMUSDToken
      âœ” Should reject setMUSDToken with zero address
      âœ” Should reject setMUSDToken from non-timelock
    Emergency Functions â€” Additional Branches
      âœ” forceUpdateNonce should update nonce
      âœ” forceUpdateNonce should reject from non-emergency
      âœ” migrateUsedAttestations should mark IDs as used
      âœ” migrateUsedAttestations should reject from non-admin
      âœ” unpause() view function should revert directing to requestUnpause
      âœ” Should reject unpause execution before timelock
    Rate Limit Edge Cases
      âœ” Should track cap decreases separately from increases
      âœ” Should handle attestation with exactly MIN_ATTESTATION_GAP
      âœ” Should reject attestation too soon after last
    Collateral Ratio Edge Cases
      âœ” Should reject ratio change without cooldown
      âœ” Should allow ratio change after cooldown
      âœ” Should reject ratio below minimum (10000)
    Min Signatures Edge Cases
      âœ” Should reject minSignatures of 0
      âœ” Should reject minSignatures of 1
      âœ” Should reject minSignatures > 10

  BLEBridgeV9 â€” Branch Coverage Boost
    Initialization
      âœ” should revert INVALID_DAILY_LIMIT when _dailyCapIncreaseLimit is 0
    emergencyReduceCap
      âœ” should revert SUB_SUPPLY_CAP_REQUIRES_ADMIN when cap < totalSupply from non-admin
      âœ” should revert REASON_REQUIRED when reason is empty
    setDailyCapIncreaseLimit
      âœ” should revert INVALID_LIMIT when _limit is 0
    migrateUsedAttestations â€” zero previous bridge
      âœ” should revert INVALID_PREVIOUS_BRIDGE when previousBridge is zero
    setCollateralRatio â€” triggers _updateSupplyCap
      âœ” should update supply cap when attestedCantonAssets > 0
    pause â€” cancels pending unpause
      âœ” should cancel pending unpause and emit UnpauseCancelled
    requestUnpause â€” not paused
      âœ” should revert NOT_PAUSED when bridge is not paused
    executeUnpause â€” no pending request
      âœ” should revert NO_UNPAUSE_REQUEST when no unpause was requested
    processAttestation â€” zero assets
      âœ” should revert ZERO_ASSETS when cantonAssets is 0
    processAttestation â€” non-RELAYER caller
      âœ” should revert when caller lacks RELAYER_ROLE (BRIDGE-M-04)
    invalidateAttestationId
      âœ” should revert ALREADY_USED when attestation ID was already marked
      âœ” should revert REASON_REQUIRED when reason is empty
    _updateSupplyCap â€” no-op path
      âœ” should not emit SupplyCapUpdated when calculated cap == current cap
    _updateSupplyCap â€” cap decrease
      âœ” should decrease cap and track in dailyCapDecreased
    _handleRateLimitCapIncrease â€” exhausted
      âœ” should revert DAILY_CAP_LIMIT_EXHAUSTED after limit is fully used
    getHealthRatio â€” supply > 0, no attestation
      âœ” should return 0 when totalSupply > 0 but attestedCantonAssets == 0
    View functions â€” window-expired branches
      âœ” getNetDailyCapIncrease returns 0 after 24h window expires
      âœ” getRemainingDailyCapLimit returns full limit after 24h window expires
      âœ” getRemainingDailyCapLimit returns 0 when limit is fully exhausted within window

  CoverageBoost â€” DirectMintV2
    Constructor â€” missing zero-address branches
      âœ” Should revert when treasury is zero address
      âœ” Should revert when feeRecipient is zero address
    mintFor â€” TreasuryReceiver integration
      âœ” Should mint mUSD to recipient via MINTER_ROLE caller
      âœ” Should mint with zero fees
      âœ” Should revert when recipient is zero address
      âœ” Should revert when below minimum mint
      âœ” Should revert when above maximum mint
      âœ” Should revert when exceeding supply cap
      âœ” Should revert when paused
      âœ” Should revert when caller lacks MINTER_ROLE
    Redeem â€” uncovered branches
      âœ” Should revert redeem above max
      âœ” Should revert redeem when paused
      âœ” Should apply minimum 1-wei fee when redeemFeeBps > 0 and fee rounds to zero
      âœ” Should correctly track redeem fees
      âœ” Should apply minimum 1-wei fee for small amounts with non-zero redeemFeeBps
    View Functions
      âœ” previewMint â€” should return correct musdOut and fee
      âœ” previewMint â€” zero fee when mintFeeBps = 0
      âœ” previewRedeem â€” should return correct usdcOut and fee
      âœ” previewRedeem â€” zero fee when redeemFeeBps = 0
      âœ” previewRedeem â€” min-fee-of-1 when fee rounds to zero but redeemFeeBps > 0
      âœ” remainingMintable â€” cap > supply
      âœ” remainingMintable â€” cap == supply â†’ 0
      âœ” totalTreasuryValue â€” should return treasury value
      âœ” availableForRedemption â€” should return available reserves
      âœ” totalAccumulatedFees â€” should return sum of mint + redeem fees
      âœ” totalAccumulatedFees â€” sums both mint and redeem fees
    setFees â€” validation branches
      âœ” setFees â€” should revert REDEEM_FEE_TOO_HIGH
      âœ” setFees â€” both at max should succeed
      âœ” setFees â€” access control (non-timelock reverts)
    setFeeRecipient â€” validation branches
      âœ” setFeeRecipient â€” should revert with zero address
      âœ” setFeeRecipient â€” should update feeRecipient
      âœ” setFeeRecipient â€” access control (non-timelock reverts)
    setLimits â€” validation branches
      âœ” setLimits â€” should revert INVALID_REDEEM_LIMITS (min > max)
      âœ” setLimits â€” should apply limits directly
      âœ” setLimits â€” both pairs at boundary (min == max) should succeed
      âœ” setLimits â€” access control (non-timelock reverts)
    Fee Withdrawal â€” uncovered paths
      âœ” withdrawFees â€” should revert NO_FEES when no mint fees accrued
      âœ” withdrawFees â€” access control (non-FEE_MANAGER reverts)
      âœ” withdrawRedeemFees â€” should revert NO_REDEEM_FEES when none accrued
      âœ” withdrawRedeemFees â€” should transfer redeem fees to feeRecipient
      âœ” withdrawRedeemFees â€” access control (non-FEE_MANAGER reverts)
    Pause / Unpause â€” separation of duties
      âœ” unpause â€” should require DEFAULT_ADMIN_ROLE
      âœ” pause â€” non-PAUSER reverts
      âœ” Should pause and unpause correctly
      âœ” mint should work after unpause
    recoverToken â€” all branches
      âœ” Should recover arbitrary ERC20 tokens
      âœ” Should revert when trying to recover USDC
      âœ” Should revert when trying to recover mUSD
      âœ” Should revert for non-admin caller
    Access Control â€” exhaustive role checks
      âœ” setLimits â€” only timelock
      âœ” setFeeRecipient â€” only timelock
      âœ” recoverToken â€” only DEFAULT_ADMIN_ROLE
    Edge cases & boundary values
      âœ” Mint exactly at minMintAmount boundary
      âœ” Mint exactly at maxMintAmount boundary
      âœ” Redeem exactly at minRedeemAmount boundary
      âœ” Mint with maximum fee (5%) should work
      âœ” Multiple mints accumulate fees correctly
      âœ” Constants are correct

  socializeBadDebt â€” Incomplete List Invariant
    âœ” Should NOT clear all badDebt when borrower list is incomplete (39ms)
    âœ” badDebt should decrease by totalReduced, not socializeAmount, when list is incomplete

  Treasury â€” Recovery Fee
    âœ” peakRecordedValue should be initialized to 0 (114ms)
    âœ” peakRecordedValue should track deposits
    âœ” peakRecordedValue getter should be accessible

  CoverageBoost â€” Misc Contracts
    TreasuryV2 â€” Uncovered Branches
      âœ” should skip fee accrual when called within MIN_ACCRUAL_INTERVAL
      âœ” should detect spike as recovery and skip fee accrual
      âœ” should skip fees when value recovers to below peak (high-water mark)
      âœ” should charge fees only on yield above peak (partial recovery + new yield)
      âœ” should claim fees and handle partial reserve
      âœ” should return early from claimFees when no fees accrued
      âœ” should revert withdrawToVault when liquidity insufficient
      âœ” should keep depositFromVault below minAutoAllocateAmount in reserve
      âœ” should revert depositFromVault with zero amount
      âœ” should revert withdrawToVault with zero amount
      âœ” should revert legacy deposit with zero amount
      âœ” should revert legacy withdraw with zero amount
      âœ” should revert legacy withdraw when insufficient reserves after strategy pull
      âœ” should handle auto-allocate with no auto-allocate strategies
      âœ” should return 0 when all strategies have zero value
      âœ” should emit StrategyWithdrawFailed when strategy withdraw fails
      âœ” should revert updateStrategy if total allocation exceeds BPS
      âœ” should revert setVault from non-timelock
      âœ” should revert recoverToken for the primary asset
      âœ” should recover a non-primary token
      âœ” should revert setMinAutoAllocate with zero
      âœ” should return 0 from totalValueNet when accrued fees exceed total
      âœ” should return early from rebalance when total is 0
      âœ” should handle broken strategy during rebalance
      âœ” should emit StrategyWithdrawFailed on emergency with broken strategy
    LiquidationEngine â€” Uncovered Branches
      âœ” should revert on invalid constructor args
      âœ” should revert liquidate with zero debtToRepay
      âœ” should revert liquidate below MIN_LIQUIDATION_AMOUNT
      âœ” should allow full liquidation when HF is severely low
      âœ” should cap seize amount at available collateral
      âœ” should return false for isLiquidatable when no debt
      âœ” should revert when borrower tries to self-liquidate
      âœ” should revert when liquidation amount is below minimum
      âœ” should cap estimateSeize at available collateral
      âœ” should revert setCloseFactor with invalid value
      âœ” should revert setCloseFactor from non-timelock
      âœ” should revert setFullLiquidationThreshold with invalid value
      âœ” should revert setFullLiquidationThreshold from non-timelock
      âœ” should pause and require DEFAULT_ADMIN_ROLE for unpause
    CollateralVault â€” Uncovered Branches
      âœ” should revert setBorrowModule with zero address
      âœ” should revert setBorrowModule from non-timelock
      âœ” should accept addCollateral with low penalty (no lower bound check)
      âœ” should revert addCollateral from non-timelock
      âœ” should revert updateCollateral for disabled token
      âœ” should revert updateCollateral with invalid factor
      âœ” should revert updateCollateral with threshold > 9500
      âœ” should revert updateCollateral with penalty out of range
      âœ” should revert updateCollateral from non-timelock
      âœ” should revert enableCollateral for token never added
      âœ” should revert enableCollateral for already enabled token
      âœ” should revert disableCollateral for unsupported token
      âœ” should revert depositFor with zero address user
      âœ” should revert depositFor with zero amount
      âœ” should revert withdrawFor with insufficient deposit
      âœ” should revert withdrawFor with zero recipient
      âœ” should allow withdrawFor with skipHealthCheck=true
      âœ” should revert seize with insufficient collateral
      âœ” should pause deposits and require admin for unpause
    DepositRouter â€” Uncovered Branches
      âœ” should revert constructor with zero wormhole relayer
      âœ” should revert constructor with zero token bridge
      âœ” should revert constructor with zero directMint
      âœ” should revert constructor with zero admin
      âœ” should revert depositFor with zero recipient
      âœ” should revert deposit with zero amount
      âœ” should revert deposit below minimum
      âœ” should revert deposit above maximum
      âœ” should revert setTreasury with zero address
      âœ” should revert setDirectMint with zero address
      âœ” should revert setFee above 5%
      âœ” should update fee successfully
      âœ” should succeed withdrawFees when no fees accumulated (transfers 0)
      âœ” should revert withdrawFees to zero address
      âœ” should revert markDepositComplete for unknown sequence
      âœ” should revert emergencyWithdraw on zero amount
      âœ” should revert USDC emergencyWithdraw when not paused
      âœ” should allow USDC emergencyWithdraw when paused
      âœ” should allow native token emergency withdrawal
      âœ” should allow non-USDC token emergency withdrawal when paused
      âœ” should separate pause and unpause roles
      âœ” should correctly preview deposit fees
    TreasuryReceiver â€” Uncovered Branches
      âœ” should revert constructor with zero usdc
      âœ” should revert constructor with zero wormhole
      âœ” should revert constructor with zero tokenBridge
      âœ” should revert constructor with zero directMint
      âœ” should revert constructor with zero treasury (46ms)
      âœ” should allow authorizeRouter with zero bytes32
      âœ” should authorize and revoke router
      âœ” should revert setDirectMint with zero address
      âœ” should revert setTreasury with zero address
      âœ” should update directMint address
      âœ” should update treasury address
      âœ” should revert emergencyWithdraw to zero address
      âœ” should allow USDC emergencyWithdraw when paused
      âœ” should allow USDC emergencyWithdraw when paused
      âœ” should revert claimPendingMint for non-existent hash
      âœ” should enforce pause/unpause role separation
    SMUSD â€” Uncovered Branches
      âœ” should revert syncCantonShares with non-sequential epoch
      âœ” should revert syncCantonShares when called too frequently
      âœ” should reject initial canton shares exceeding 2x ETH shares
      âœ” should revert when subsequent sync increase exceeds 5%
      âœ” should revert when subsequent sync decrease exceeds 5%
      âœ” should revert receiveInterest with zero amount
      âœ” should revert receiveInterest when no shares exist
      âœ” should revert receiveInterest exceeding cap
      âœ” should revert distributeYield when no shares exist
      âœ” should revert distributeYield with zero amount
      âœ” should revert distributeYield exceeding cap
      âœ” should set treasury successfully
      âœ” should revert setTreasury with zero address
      âœ” should return 0 for maxWithdraw when paused
      âœ” should return 0 for maxRedeem when paused
      âœ” should return 0 for maxDeposit when paused
      âœ” should return 0 for maxMint when paused
      âœ” should return 0 for maxWithdraw during cooldown
      âœ” should propagate stricter cooldown on transfer
      âœ” should revert with NoTreasury when treasury reverts and no cache
      âœ” should return default price when no shares exist
    SMUSDPriceAdapter â€” Uncovered Branches
      âœ” should revert constructor with zero smusd
      âœ” should return last known price when totalSupply too low
      âœ” should clamp share price to min bound
      âœ” should clamp share price to max bound
      âœ” should rate-limit price increase per block
      âœ” should rate-limit price decrease per block
      âœ” should revert setSharePriceBounds with zero min
      âœ” should revert setSharePriceBounds with max <= min
      âœ” should revert setSharePriceBounds with max > $10
      âœ” should revert setDonationProtection with zero supply
      âœ” should revert setDonationProtection with zero change
      âœ” should revert setDonationProtection with change > 50%
      âœ” should increment round
      âœ” should return same data from getRoundData
      âœ” should return correct description and version
    LeverageVault â€” Uncovered Branches
      âœ” should revert constructor with zero swapRouter
      âœ” should revert constructor with zero collateralVault
      âœ” should revert constructor with zero borrowModule
      âœ” should revert constructor with zero priceOracle
      âœ” should revert constructor with zero musd
      âœ” should revert setConfig with invalid maxLoops
      âœ” should revert setConfig with slippage too high
      âœ” should accept setConfig with any fee tier (no fee tier validation)
      âœ” should accept valid setConfig
      âœ” should revert setMaxLeverage with invalid values
      âœ” should accept valid setMaxLeverage
      âœ” should revert enableToken with zero address
      âœ” should revert enableToken with invalid fee tier
      âœ” should disable token
      âœ” should return 0 for getEffectiveLeverage with no position
      âœ” should revert emergencyWithdraw with zero token
      âœ” should revert emergencyWithdraw with invalid token (EOA)
      âœ” should revert emergencyWithdraw from non-admin
      âœ” should enforce pause/unpause role separation
      âœ” should revert openLeveragedPosition for disabled token
      âœ” should revert openLeveragedPosition with expired deadline

  PendleMarketSelector â€” Coverage Boost
    View Functions
      âœ” whitelistedCount should return correct count (57ms)
      âœ” getWhitelistedMarkets should return all markets
      âœ” getMarketInfo should return info for whitelisted market
    Market Selection
      âœ” selectBestMarket should revert with no markets
      âœ” getValidMarkets should return empty for non-matching category
      âœ” getValidMarkets should filter expired markets
      âœ” getValidMarkets should filter markets too close to expiry
    Market Removal
      âœ” Should remove market and update array correctly
      âœ” Should revert when removing non-whitelisted market
      âœ” Should revert removal from non-admin
    Whitelist Edge Cases
      âœ” Should allow re-whitelisting same market with different category
      âœ” Should reject batch whitelist with zero address
      âœ” Should reject batch > 50 markets
    Parameter Validation
      âœ” Should reject weights not summing to 10000
      âœ” Should update all parameters

  PendleMarketSelector â€” Full Coverage Boost
    initialize
      âœ” reverts when admin is zero address (76ms)
    selectBestMarket â€” with valid markets
      âœ” selects the highest-scoring market among multiple valid markets (54ms)
      âœ” selects the only valid market when all others are filtered
      âœ” reverts NoValidMarkets when all markets are expired
      âœ” reverts NoValidMarkets for empty category (no markets match)
      âœ” reverts NoValidMarkets when markets are whitelisted but none in that category
    getValidMarkets â€” filtering & scoring
      âœ” filters out markets below minTvlUsd
      âœ” filters out markets below minApyBps
      âœ” filters out markets too close to expiry (partial expiry filtering)
      âœ” returns empty when all whitelisted markets in category are expired
      âœ” scores multiple valid markets with different TVL & APY
      âœ” returns single-element with score=10000 when only one market passes
      âœ” handles removed (de-whitelisted) market still in array gracefully
    getMarketInfo â€” oracle integration
      âœ” returns correct MarketInfo for a whitelisted market
      âœ” returns zero APY when implied rate is zero
      âœ” returns info for non-whitelisted market (raw _getMarketInfo path)
      âœ” returns zero timeToExpiry for expired market
      âœ” uses oracle ptToSyRate for TVL calculation
    _lnRateToAPY edge cases
      âœ” returns 0 APY when timeToExpiry is 0
      âœ” returns higher APY for shorter time-to-expiry with same rate
      âœ” handles very large implied rate
    _calculateScores
      âœ” all-TVL weighting: market with highest TVL wins
      âœ” all-APY weighting: market with highest APY wins
      âœ” equal markets get equal scores
    whitelistMarket â€” edge cases
      âœ” reverts on zero address
      âœ” reverts when MAX_WHITELISTED_MARKETS is reached (719ms)
      âœ” does not duplicate when whitelisting already-whitelisted market
      âœ” emits MarketWhitelisted event
      âœ” rejects whitelistMarket from non-admin
    whitelistMarkets (batch)
      âœ” reverts on length mismatch
      âœ” successfully batch-whitelists multiple markets
      âœ” handles duplicate in same batch without double-counting
      âœ” reverts batch from non-admin
      âœ” reverts batch that would exceed MAX_WHITELISTED_MARKETS (986ms)
    removeMarket â€” swap-and-pop
      âœ” removes the last element correctly (no swap needed)
      âœ” removes a middle element via swap-and-pop
      âœ” emits MarketRemoved event
      âœ” clears marketCategory on removal
      âœ” reverts MarketNotWhitelisted for unknown market
    setParams â€” branches
      âœ” reverts InvalidWeights when sum < 10000
      âœ” reverts InvalidWeights when sum > 10000
      âœ” emits ParamsUpdated on success
      âœ” reverts from non-PARAMS_ADMIN
      âœ” allows zero minTimeToExpiry
    Constants and view getters
      âœ” PENDLE_ORACLE constant matches expected address
      âœ” TWAP_DURATION is 900
      âœ” BPS is 10000
      âœ” SECONDS_PER_YEAR is 365 days
      âœ” MAX_WHITELISTED_MARKETS is 100
      âœ” timelock role is set correctly
      âœ” default params are set correctly after initialize
      âœ” whitelistedMarkets array is accessible by index
      âœ” isWhitelisted returns false for unknown address
      âœ” marketCategory returns empty string for unknown market
    Role-based access control
      âœ” MARKET_ADMIN_ROLE and PARAMS_ADMIN_ROLE are distinct
      âœ” non-timelock user cannot whitelist markets
      âœ” non-timelock user cannot setParams

  PendleStrategyV2 â€” Coverage Boost
    Initialization
      âœ” Should set correct asset (236ms)
      âœ” Should be active after initialization
      âœ” Should have default slippage of 50 bps
      âœ” Should have default PT discount rate of 1000 bps (10%)
      âœ” Should have default rollover threshold of 7 days
      âœ” Should reject zero USDC address in initialize (47ms)
      âœ” Should reject zero market selector in initialize (81ms)
    View Functions
      âœ” totalValue should return 0 when no deposits
      âœ” ptBalance should return 0 initially
      âœ” currentMarket should be zero address initially
      âœ” shouldRollover should be true with no current market
      âœ” timeToExpiry should be 0 with no market
      âœ” marketCategory should return correct category
    Admin Functions
      âœ” Should update slippage
      âœ” Should reject slippage > MAX_SLIPPAGE_BPS
      âœ” Should update PT discount rate
      âœ” Should reject PT discount rate > 5000
      âœ” Should update rollover threshold
      âœ” Should reject rollover threshold < 1 day
      âœ” Should update market selector
      âœ” Should toggle active status
      âœ” Should reject admin functions from unauthorized
    Emergency Controls
      âœ” Should pause from guardian
      âœ” Should unpause from admin (DEFAULT_ADMIN_ROLE)
      âœ” Should allow guardian to emergency withdraw USDC to treasury
      âœ” Should allow admin to recover non-USDC tokens
      âœ” Should reject recover for USDC
      âœ” Should reject recover from non-admin
    Deposit Authorization
      âœ” Should reject deposit from non-treasury
      âœ” Should reject deposit when paused
      âœ” Should reject deposit of 0
      âœ” Should reject withdraw from non-treasury
      âœ” Should reject withdrawAll from non-treasury
    Rollover
      âœ” Should reject rollToNewMarket from non-strategist
      âœ” Should reject triggerRollover from non-strategist

  PendleStrategyV2 â€” Full Coverage
    deposit() â€” happy path
      âœ” deposits USDC, receives PT, emits Deposited (68ms)
      âœ” second deposit into same market accumulates PT
    deposit() â€” auto-rollover
      âœ” rolls to new market when near expiry
      âœ” auto-selects market on first deposit (currentMarket == 0)
    withdraw() â€” happy path
      âœ” pre-maturity: uses swapExactPtForToken
      âœ” post-maturity: uses redeemPyToToken
      âœ” caps ptNeeded at ptBalance when withdrawing more than available
    withdraw() â€” reverts
      âœ” ZeroAmount
      âœ” NoMarketSet (no prior deposit)
    withdrawAll() â€” happy path
      âœ” redeems all PT and transfers to treasury
      âœ” includes dust USDC in the transfer
    withdrawAll() â€” zero balance
      âœ” returns 0 without reverting when no PT
    rollToNewMarket()
      âœ” rolls when near expiry (redeem old PT â†’ select new â†’ re-deposit)
      âœ” rolls when no market set (currentMarket == 0)
      âœ” rolls with zero ptBalance (no re-deposit)
    rollToNewMarket() â€” revert
      âœ” RolloverNotNeeded when market is active
    triggerRollover()
      âœ” triggers rollover with RolloverTriggered + MarketRolled events
      âœ” daysRemaining is 0 when fully expired
      âœ” calculates daysRemaining correctly when near expiry
    triggerRollover() â€” revert
      âœ” RolloverNotNeeded when market active
    shouldRollover() paths
      âœ” true when no market set (currentMarket == 0)
      âœ” false when market active with plenty of time
      âœ” true when near expiry (within threshold)
      âœ” true when expired
    _selectNewMarket() reverts
      âœ” NO_VALID_MARKET when selector returns address(0)
      âœ” INVALID_PT_TOKEN when pt is address(0)
    PT valuation (_ptToUsdc / _usdcToPt)
      âœ” totalValue < deposit amount (time discount before maturity)
      âœ” 1:1 value at maturity (expired market)
      âœ” timeRemaining clamped to 1 year for >1yr expiry
      âœ” _usdcToPt: more PT consumed than USDC value (discount)
      âœ” _ptToUsdc with zero ptBalance returns 0 in totalValue
    totalValue()
      âœ” 0 when empty
      âœ” USDC balance only when currentMarket == 0
      âœ” ptValue + usdcBalance after deposit
      âœ” expired market gives 1:1 PT value
    isActive()
      âœ” true when active and not paused
      âœ” false when inactive
      âœ” false when paused
    emergencyWithdraw()
      âœ” redeems PT + transfers USDC to treasury + pauses
      âœ” works with zero PT (only USDC dust)
      âœ” reverts with ZERO_RECIPIENT
      âœ” reverts when recipient lacks TREASURY_ROLE
    recoverToken()
      âœ” cannot recover USDC
      âœ” cannot recover PT after market selected
      âœ” can recover random tokens
    setMarketSelector()
      âœ” reverts with zero address
      âœ” updates selector
    Access control
      âœ” deposit: non-treasury reverts
      âœ” deposit: reverts when not active
      âœ” deposit: reverts when paused
      âœ” deposit: ZeroAmount
      âœ” withdraw: non-treasury reverts
      âœ” withdrawAll: non-treasury reverts
      âœ” rollToNewMarket: non-strategist reverts
      âœ” triggerRollover: non-strategist reverts
      âœ” setSlippage: non-strategist reverts
      âœ” setPtDiscountRate: non-strategist reverts
      âœ” setRolloverThreshold: non-strategist reverts
      âœ” setMarketSelector: non-admin reverts
      âœ” setActive: non-guardian reverts
      âœ” emergencyWithdraw: non-guardian reverts
      âœ” pause: non-guardian reverts
      âœ” unpause: non-admin reverts (guardian cannot)
      âœ” recoverToken: non-admin reverts
    Admin setters
      âœ” setSlippage emits SlippageUpdated
      âœ” setSlippage > MAX_SLIPPAGE_BPS reverts
      âœ” setPtDiscountRate emits PtDiscountRateUpdated
      âœ” setPtDiscountRate > 5000 reverts
      âœ” setRolloverThreshold emits RolloverThresholdUpdated
      âœ” setRolloverThreshold < 1 day reverts
      âœ” setRolloverThreshold > 30 days reverts
      âœ” setActive toggles
      âœ” pause / unpause
    Initialization
      âœ” revert zero USDC (271ms)
      âœ” revert zero marketSelector (106ms)
      âœ” revert zero treasury (94ms)
      âœ” revert zero admin (102ms)
      âœ” asset() returns USDC
      âœ” defaults set correctly
    timeToExpiry()
      âœ” 0 when no market
      âœ” positive after deposit
      âœ” 0 after expiry

  Cross-Chain E2E: Canton â†” Ethereum Bridge
    1. Canton â†’ Ethereum: Attestation-driven supply cap
      âœ” should process a Canton attestation and update mUSD supply cap
      âœ” should chain multiple attestations with linked state hashes
      âœ” should enforce rate limiting on rapid supply cap increases
    2. Ethereum â†’ Canton: Bridge-out (burn + relay pickup)
      âœ” should burn mUSD and emit BridgeToCantonRequested event
      âœ” should allow relay to create BridgeOutRequest on Canton via mock API (40ms)
      âœ” should reject bridge-out below minimum amount
      âœ” should reject bridge-out with invalid Canton party format
    3. Full round-trip: Canton attestation â†’ mint â†’ bridge-out â†’ re-attest
      âœ” should complete a full Cantonâ†”Ethereum lifecycle
    4. Relay CantonClient integration with mock Canton
      âœ” should query attestation request contracts from Canton
      âœ” should exercise a choice on a Canton contract
      âœ” should handle Canton API timeout gracefully
    5. Bridge event ABI compatibility with relay
      âœ” should emit AttestationReceived with fields relay expects
      âœ” should emit BridgeToCantonRequested with fields relay expects
      âœ” should emit SupplyCapUpdated for relay monitoring
    6. Cross-chain attack scenarios
      âœ” should prevent double-spend via attestation replay
      âœ” should prevent supply inflation via stale attestation
      âœ” should prevent bridge-out during emergency pause
      âœ” should prevent unauthorized validator from inflating supply

  DEEP AUDIT â€“ Full Protocol Integration
    1. Mint Flow
      âœ” should mint mUSD 1:1 from USDC (minus 1% fee)
      âœ” should redeem mUSD back to USDC (0% default redeem fee)
      âœ” should handle decimal conversion correctly (USDC 6 â†’ mUSD 18)
      âœ” should enforce supply cap on mint
      âœ” should reject mint below minimum amount
      âœ” should reject mint above maximum amount
      âœ” should allow mintFor by MINTER_ROLE
      âœ” should reject mintFor without MINTER_ROLE
    2. Collateral Vault
      âœ” should accept WETH deposits
      âœ” should accept WBTC deposits
      âœ” should reject deposits for unsupported tokens
      âœ” should reject zero amount deposits
      âœ” should disable/enable collateral correctly
      âœ” should enforce max 50 supported tokens (138ms)
    3. Lending & Borrowing
      âœ” should allow borrowing within LTV
      âœ” should reject borrowing exceeding borrow capacity
      âœ” should reject borrow below minimum debt
      âœ” should accrue interest over time
      âœ” should allow full repayment
      âœ” should allow partial repayment
      âœ” should correctly track totalBorrows accounting
      âœ” should prevent collateral withdrawal that breaks health factor
    4. Liquidation Engine
      âœ” should reject liquidation on healthy position
      âœ” should liquidate after price drop
      âœ” should enforce close factor (max 50% liquidation)
      âœ” should allow full liquidation when health < 0.5
      âœ” should prevent self-liquidation
      âœ” should prevent dust liquidations
      âœ” should correctly compute WBTC seizure with 8 decimals
    5. Treasury Strategy Disbursement
      âœ” should auto-allocate deposits to strategies
      âœ” should keep reserve buffer in treasury
      âœ” should accrue performance fees on yield
      âœ” should rebalance strategies to target allocations
      âœ” should handle strategy removal with full withdrawal
    6. Staked mUSD (smUSD)
      âœ” should deposit mUSD and receive shares
      âœ” should enforce 24h cooldown on withdrawal
      âœ” should propagate fresh cooldown via transfer
    7. Bridge Attestation (BLEBridgeV9)
      âœ” should process valid attestation with sufficient signatures
      âœ” should reject attestation with insufficient signatures
      âœ” should reject replay attestation
      âœ” should reject attestation with wrong nonce
      âœ” should reject expired attestation
      âœ” should enforce unpause timelock
    8. Price Oracle
      âœ” should normalize prices to 18 decimals
      âœ” should correctly compute USD value for different decimal tokens
      âœ” should reject stale prices
      âœ” should allow admin to update price after circuit breaker
    9. Interest Rate Model
      âœ” should return base rate at 0% utilization
      âœ” should have kinked rate above 80% utilization
      âœ” should split interest between supplier and reserve
    10. Access Control & Emergency
      âœ” should reject unauthorized mint
      âœ” should reject unauthorized burn
      âœ” should enforce blacklist on transfers
      âœ” should pause/unpause MUSD with role separation
      âœ” should prevent vault pause griefing (role separation)
    11. Decimal Consistency (USDC 6 â†” mUSD 18)
      âœ” should handle exact 1 USDC â†’ mUSD conversion
      âœ” should handle exact mUSD â†’ USDC conversion on redeem
      âœ” should handle Treasury totalValue scaling
      âœ” should handle rounding correctly for small amounts
    12. Multi-User Interactions
      âœ” should handle concurrent borrowers with independent positions
      âœ” should liquidate one user without affecting another
      âœ” should correctly handle full flow: mint â†’ stake â†’ borrow â†’ repay â†’ unstake â†’ redeem

  DEEP AUDIT V2 â€“ Verification & Hack Vectors
    1. Supply Cap Bricking
      âœ” should allow repayment even when supply cap is exhausted
      âœ” should emit InterestRoutingFailed when supply cap blocks interest mint
      âœ” should still track totalBorrows with interest even when routing fails
    2. Treasury Strategy DoS Resistance
      âœ” should return correct totalValue when a strategy reverts
      âœ” should allow deposits and withdrawals when strategies are healthy
    3. Strategy Force Removal
      âœ” should force-remove a strategy even when withdrawAll fails
      âœ” should still remove strategy normally when withdrawAll succeeds
    4. Circuit Breaker Bypass for Liquidations
      âœ” should liquidate even after a >20% price crash (circuit breaker trips)
      âœ” getValueUsdUnsafe should return correct values
    5. totalBorrows Divergence Prevention
      âœ” should maintain totalBorrows consistency across multi-user borrows
      âœ” should properly reduce totalBorrows on full repayment
    6. withdrawReserves Cap-Bounded Minting
      âœ” should revert withdrawReserves when supply cap is exhausted
      âœ” should succeed withdrawReserves when supply cap has room
    7. enableCollateral 50-Token Cap
      âœ” should enforce 50-token cap on addCollateral (63ms)
      âœ” should enforce 50-token cap on enableCollateral (68ms)
    8. SMUSD globalTotalAssets Cap
      âœ” should use globalTotalAssets for receiveInterest cap
    9. Hack Vector: ERC4626 Donation Attack
      âœ” should resist share inflation via direct mUSD donation
    10. Hack Vector: Flash Loan Share Price Manipulation
      âœ” should prevent instant deposit+withdraw profit via cooldown
    11. Hack Vector: Self-Referential Collateral
      âœ” should not allow mUSD as collateral (admin responsibility check)
      âœ” should allow smUSD as collateral (yield-bearing stable, 90% LTV)
    12. Hack Vector: Liquidation Cascade Edge Cases
      âœ” should handle liquidation that seizes all collateral
      âœ” should prevent self-liquidation
      âœ” should correctly handle multi-collateral liquidation
    13. Hack Vector: Interest Rate Manipulation
      âœ” should cap interest per accrual at 10% of totalBorrows
      âœ” should reject interest rate above 50% APR
      âœ” should allow interest rate up to 50% APR
    14. Treasury Fee Accrual Edge Cases
      âœ” should enforce minimum accrual interval
      âœ” should correctly separate yield from deposits
    15. Cross-Contract Accounting Integrity
      âœ” should maintain mint-borrow-repay-burn accounting cycle
      âœ” should enforce USDC 6 â†” mUSD 18 decimal consistency throughout
      âœ” should prevent deposit-borrow-withdraw-default attack
      âœ” should enforce blacklist across mint and transfer paths
      âœ” should allow emergency pause to halt all operations
    16. Stale Price Protection
      âœ” should reject prices older than stale period
      âœ” should revert stale prices in unsafe variant
      âœ” should check isFeedHealthy correctly
    17. Access Control Exhaustive
      âœ” should reject unauthorized strategy operations on Treasury
      âœ” should reject unauthorized reserve withdrawal from BorrowModule
      âœ” should reject unauthorized collateral config changes
      âœ” should reject unauthorized price feed changes
      âœ” should reject unauthorized interest rate changes
      âœ” should reject unauthorized SMUSD yield distribution
      âœ” should enforce pause/unpause role separation across all contracts
    18. Minimum Debt & Dust Prevention
      âœ” should reject borrow below minimum debt
      âœ” should auto-close dust positions below minDebt
      âœ” should allow full repayment to zero

  DepositRouter
    Deployment
      âœ” Should set correct initial state
      âœ” Should grant roles to admin
      âœ” Should revert on zero address parameters
      âœ” Should revert on fee too high
    Deposit
      âœ” Should accept valid deposit and emit event
      âœ” Should calculate fees correctly
      âœ” Should revert on zero amount
      âœ” Should revert on amount below minimum
      âœ” Should revert on amount above maximum
      âœ” Should revert on insufficient native token
      âœ” Should refund excess native token
    DepositFor
      âœ” Should accept deposit for another address
      âœ” Should revert on zero recipient
    View Functions
      âœ” Should return correct bridge cost quote
      âœ” Should track pending deposits
      âœ” Should report deposit completion status
    Admin Functions
      âœ” Should update treasury address
      âœ” Should update DirectMint address
      âœ” Should update fee
      âœ” Should revert on fee > 5%
      âœ” Should withdraw accumulated fees
      âœ” Should revert admin functions for non-admin
    Pause/Unpause
      âœ” Should pause and prevent deposits
      âœ” Should unpause and allow deposits
      âœ” Should require DEFAULT_ADMIN_ROLE for unpause
    Emergency Withdraw
      âœ” Should allow timelock to withdraw tokens to treasury when paused
      âœ” Should allow timelock to withdraw native token to treasury when paused
      âœ” Should revert emergency withdraw for non-timelock
      âœ” Should revert emergency withdraw when not paused

  DirectMintV2
    Initialization
      âœ” Should initialize with correct parameters
      âœ” Should have correct default limits
      âœ” Should reject zero addresses in constructor
    Minting
      âœ” Should mint mUSD for USDC at 1:1 ratio (no fees)
      âœ” Should apply mint fee correctly
      âœ” Should reject mint below minimum
      âœ” Should reject mint above maximum
      âœ” Should reject mint that exceeds supply cap
      âœ” Should reject mint when paused
    Redeeming
      âœ” Should redeem mUSD for USDC at 1:1 ratio (no fees)
      âœ” Should apply redeem fee correctly
      âœ” Should reject redeem below minimum
      âœ” Should reject zero redeem amount
    Fee Management
      âœ” Should allow fee manager to update fees
      âœ” Should reject fees above maximum
      âœ” Should allow fee withdrawal
      âœ” Should update fee recipient
    Limits Management
      âœ” Should allow admin to update limits
      âœ” Should reject invalid limits (min > max)
    Access Control
      âœ” Should reject pause from non-pauser
      âœ” Should reject fee changes from non-fee-manager
      âœ” Should allow pauser to pause/unpause

  ETHPool
    Deployment
      âœ” sets correct initial state
      âœ” reverts on zero musd address
      âœ” reverts on zero oracle address
      âœ” configures 4 time-lock tiers
    Stake ETH
      âœ” stakes ETH successfully with no lock tier
      âœ” increases totalETHDeposited
      âœ” reverts on zero ETH
      âœ” respects pool cap
      âœ” applies tier multiplier to smUSD-E shares
      âœ” sets correct unlock time for tiered stake
    Stake with Token
      âœ” stakes USDC successfully
      âœ” reverts on unsupported token
      âœ” reverts on zero amount
    Unstake
      âœ” unstakes immediately with no lock tier
      âœ” reverts before unlock time
      âœ” unstakes after lock expires
      âœ” reverts on non-existent position
      âœ” reverts on already-unstaked position
      âœ” returns ETH to the user
    View Functions
      âœ” canUnstake returns false for locked position
      âœ” canUnstake returns true for unlocked position
      âœ” getRemainingLockTime returns 0 for unlocked
      âœ” totalPoolValue reflects deposits
    Share Price
      âœ” allows yield manager to update share price
      âœ” reverts on too-large share price change
      âœ” reverts from unauthorized caller
    Admin
      âœ” adds stablecoin
      âœ” removes stablecoin
      âœ” reverts adding duplicate stablecoin
      âœ” reverts removing non-existent stablecoin
      âœ” sets pool cap
      âœ” sets tier config
      âœ” sets price oracle
      âœ” reverts admin from unauthorized
    Pausable
      âœ” pauser can pause
      âœ” stake blocked when paused
      âœ” admin can unpause
      âœ” non-pauser cannot pause
    Multiple Positions
      âœ” user can create multiple positions
      âœ” multiple users can stake independently

  EulerV2CrossStableLoopStrategy
    Initialization
      âœ” Should set correct initial parameters (69ms)
      âœ” Should grant roles correctly
      âœ” Should not allow re-initialization
      âœ” Should report correct IStrategy interface
      âœ” Should setup EVC collateral and controller
    Deposit (Cross-Stable Leverage)
      âœ” Should deposit with flash-loan cross-stable leverage
      âœ” Should calculate correct leverage after deposit
      âœ” Should report positive totalValue after deposit
      âœ” Should revert deposit when not active
      âœ” Should revert deposit when paused
      âœ” Should revert deposit with zero amount
      âœ” Should revert deposit from non-treasury
      âœ” Should handle multiple deposits
    Withdraw (Cross-Stable Deleverage)
      âœ” Should withdraw with flash-loan deleverage
      âœ” Should withdrawAll and return full position
      âœ” Should revert withdraw with zero amount
      âœ” Should handle withdraw larger than principal
    Health Factor & Position
      âœ” Should return max health factor with no debt
      âœ” Should return correct health factor after deposit
      âœ” Should return full position data
      âœ” Should return correct realSharePrice
      âœ” Should return correct realTvl
    Depeg Circuit Breaker
      âœ” Should allow deposit when RLUSD is within peg
      âœ” Should revert deposit when RLUSD depegs below 98c
      âœ” Should revert deposit when RLUSD depegs above $1.02
      âœ” Should detect stale price as depeg
      âœ” Should report untrusted when depegged in realSharePrice
      âœ” Should allow at exactly 2% depeg boundary
    Merkl Rewards
      âœ” Should claim and compound reward tokens
      âœ” Should revert claim with non-whitelisted token
      âœ” Should handle empty claims gracefully
    Rebalance & Leverage
      âœ” Should rebalance when LTV drifts
      âœ” Should adjust leverage with share price protection
      âœ” Should revert adjustLeverage with invalid LTV
      âœ” Should revert adjustLeverage when depegged
      âœ” Should set parameters correctly
      âœ” Should revert setParameters with invalid LTV
    Emergency Deleverage
      âœ” Should fully deleverage in emergency
      âœ” Should revert emergency deleverage from non-guardian
    Access Control & Admin
      âœ” Should toggle reward tokens
      âœ” Should revert setRewardToken with zero address
      âœ” Should set swap fees
      âœ” Should set min swap output
      âœ” Should revert setMinSwapOutput with invalid value (42ms)
      âœ” Should activate/deactivate strategy
      âœ” Should pause and unpause (timelock)
      âœ” Should recover tokens via timelock (52ms)
      âœ” Should revert recoverToken for USDC with active principal
    TreasuryV2 Integration (Updated Allocations)
      âœ” Should add EulerV2CrossStable as a strategy in TreasuryV2 (101ms)
      âœ” Should auto-allocate deposits with new proportions
      âœ” Should report correct total value with new strategy mix
      âœ” Should withdraw proportionally across all strategies
    Yield Estimate Validation
      âœ” Should show expected leverage mechanics at 75% LTV

  EulerV2LoopStrategy
    Initialization
      âœ” sets correct initial parameters (119ms)
      âœ” grants roles correctly
      âœ” prevents re-initialization
      âœ” reports correct IStrategy interface
      âœ” reverts on zero timelock address
      âœ” reverts on zero usdc address
    EVC Setup
      âœ” setupEVC configures collateral and controller
      âœ” reverts if setupEVC called twice
      âœ” reverts if non-admin calls setupEVC
    Deposit
      âœ” deposits with flash-loan leverage
      âœ” calculates correct leverage after deposit
      âœ” reports positive totalValue after deposit
      âœ” reports healthy health factor after deposit
      âœ” emits Deposited event
      âœ” reverts with ZeroAmount on zero deposit
      âœ” reverts when strategy is inactive
      âœ” reverts when called by non-TREASURY_ROLE
      âœ” reverts when paused
      âœ” handles multiple sequential deposits
    Withdraw
      âœ” withdraws with deleverage
      âœ” emits Withdrawn event
      âœ” reverts with ZeroAmount on zero withdraw
      âœ” reverts when called by non-TREASURY_ROLE
      âœ” handles withdraw when no debt (no leverage)
      âœ” handles withdraw more than totalPrincipal (clamps)
    WithdrawAll
      âœ” withdraws entire position
      âœ” reverts when called by non-TREASURY_ROLE
      âœ” handles withdrawAll when no position exists
    Leverage Views
      âœ” getHealthFactor returns max when no debt
      âœ” getHealthFactor returns >1 after deposit
      âœ” getCurrentLeverage returns 100 with no position
      âœ” getPosition returns zeros with no position
      âœ” getPosition returns correct values after deposit
      âœ” realSharePrice returns WAD when no position
      âœ” realSharePrice returns ~1.0 after initial deposit
      âœ” realTvl returns correct net TVL
    Rebalance
      âœ” rebalances when over-leveraged (debt > target + 100bps)
      âœ” does nothing when near target LTV
      âœ” does nothing when no collateral
      âœ” reverts when called by non-KEEPER_ROLE
      âœ” reverts when paused
    AdjustLeverage
      âœ” increases leverage when new LTV > current
      âœ” decreases leverage when new LTV < current
      âœ” enforces minSharePrice protection
      âœ” reverts with InvalidLTV for < 3000
      âœ” reverts with InvalidLTV for > 9000
      âœ” accepts edge case LTV = 3000
      âœ” accepts edge case LTV = 9000
      âœ” reverts when called by non-STRATEGIST_ROLE
      âœ” noop when adjusting to same LTV with no collateral
    ClaimAndCompound (Merkl)
      âœ” claims and compounds USDC rewards
      âœ” claims and swaps non-USDC rewards
      âœ” emits RewardsCompounded on success
      âœ” returns early with empty tokens array
      âœ” reverts on non-whitelisted reward token
      âœ” reverts when called by non-KEEPER_ROLE
    Emergency Deleverage
      âœ” fully deleverages position
      âœ” emits EmergencyDeleveraged event
      âœ” handles emergency deleverage with no position
      âœ” reverts when called by non-GUARDIAN_ROLE
    Admin
      âœ” setParameters updates LTV and loops
      âœ” setParameters emits ParametersUpdated
      âœ” setParameters reverts on invalid LTV
      âœ” setRewardToken whitelists and de-whitelists tokens
      âœ” setRewardToken reverts on zero address
      âœ” setActive toggles strategy active state
      âœ” recoverToken transfers stuck tokens (no active USDC)
      âœ” recoverToken reverts for USDC when totalPrincipal > 0
      âœ” recoverToken reverts when called by non-timelock
    Pause / Unpause
      âœ” guardian can pause
      âœ” timelock can unpause
      âœ” non-guardian cannot pause
      âœ” non-timelock cannot unpause
      âœ” isActive returns false when paused
    Flash Loan Callback Auth
      âœ” reverts executeOperation from unauthorized caller
    Full Lifecycle
      âœ” deposit â†’ adjustLeverage â†’ rebalance â†’ withdrawAll
      âœ” deposit â†’ emergency â†’ withdrawAll recovers funds

  FlashLoanLib
    calculateFlashLoanFee
      âœ” AaveV3 charges 0.05% fee
      âœ” BalancerV3 charges zero fee
      âœ” UniswapV3 charges 0.05% fee
      âœ” returns 0 for zero amount (all providers)
      âœ” handles very large amounts without overflow
      âœ” rounds down for small amounts
    validateProvider
      âœ” AaveV3 is valid
      âœ” BalancerV3 is valid
      âœ” UniswapV3 is valid
    isFreeLoan
      âœ” BalancerV3 is free
      âœ” AaveV3 is NOT free
      âœ” UniswapV3 is NOT free

  FluidLoopStrategy
    MODE 1: Stable (syrupUSDC / USDC â€” VaultT1)
      Initialization
        âœ” Should set correct vault mode and parameters (70ms)
        âœ” Should grant all roles correctly
        âœ” Should not allow re-initialization
        âœ” Should reject invalid vault mode
        âœ” Should report zero totalValue before deposits
      Deposit (Flash-Loan Leverage)
        âœ” Should deposit with flash-loan leverage via VaultT1
        âœ” Should create position NFT on first deposit
        âœ” Should accumulate principal on multiple deposits
        âœ” Should revert deposit when not active
        âœ” Should revert deposit with zero amount
        âœ” Should only allow TREASURY_ROLE to deposit
      Withdraw
        âœ” Should withdraw partial amount
        âœ” Should withdrawAll and return everything
        âœ” Should revert withdraw with zero amount
        âœ” Should only allow TREASURY_ROLE to withdraw
      Health Factor & Position
        âœ” Should return max health factor with no position
        âœ” Should calculate health factor after deposit
        âœ” Should return correct getPosition data
        âœ” Should report realSharePrice around 1.0
        âœ” Should report realTvl matching totalValue
      Rebalance
        âœ” Should rebalance when over-leveraged
        âœ” Should only allow KEEPER_ROLE to rebalance
      Adjust Leverage
        âœ” Should adjust LTV target
        âœ” Should reject invalid LTV
        âœ” Should only allow STRATEGIST_ROLE
      Emergency Deleverage
        âœ” Should fully unwind position
        âœ” Should only allow GUARDIAN_ROLE
      Admin Functions
        âœ” Should set parameters
        âœ” Should toggle reward tokens
        âœ” Should set swap fees
        âœ” Should pause and unpause
        âœ” Should only allow timelock to unpause
        âœ” Should set active/inactive
        âœ” Should recover tokens via timelock
        âœ” Should block recovering active asset with principal
        âœ” Should reject setParameters with invalid LTV
      Merkl Rewards
        âœ” Should claim USDC rewards and compound
        âœ” Should reject unallowed reward tokens
        âœ” Should only allow KEEPER_ROLE to claim
    MODE 2: LRT (weETH-ETH / wstETH â€” VaultT2)
      Initialization (LRT)
        âœ” Should set MODE_LRT parameters (51ms)
      Deposit (LRT)
        âœ” Should deposit with T2 operate
      Withdraw (LRT)
        âœ” Should withdrawAll from T2 vault
      Position Monitoring (LRT)
        âœ” Should report health factor > 1
        âœ” Should report leverage
      Emergency (LRT)
        âœ” Should emergency deleverage T2 position
    MODE 3: LST (wstETH-ETH / wstETH-ETH â€” VaultT4)
      Initialization (LST)
        âœ” Should set MODE_LST parameters (104ms)
      Deposit (LST)
        âœ” Should deposit with T4 operate (smart col + smart debt)
      Withdraw (LST)
        âœ” Should withdrawAll from T4 vault
      Position Monitoring (LST)
        âœ” Should report health factor > 1
        âœ” Should report high leverage for LST loop
      Emergency (LST)
        âœ” Should emergency deleverage T4 position
      Interest Simulation (LST)
        âœ” Should detect over-leverage from interest accrual
    Cross-Cutting
      âœ” Should emit Deposited event on deposit (52ms)
      âœ” Should emit Withdrawn event on withdraw
      âœ” Should emit ParametersUpdated on setParameters
      âœ” Should handle deposit â†’ full withdraw cycle
      âœ” Should handle multiple deposit-withdraw cycles
      âœ” Should reject setMinSwapOutput out of range
    VaultResolver Integration (T1 with live resolver)
      âœ” Should store vaultResolver address on initialization (75ms)
      âœ” Should store dexResolver address on initialization
      âœ” Should read position via VaultResolver after deposit
      âœ” Should return correct health factor via resolver
      âœ” Should allow timelock to set new vaultResolver
      âœ” Should reject non-timelock setting vaultResolver
      âœ” Should reject setting vaultResolver to zero address
    DEX Smart Collateral (T2 with DEX integration)
      âœ” Should initialize with DEX enabled (54ms)
      âœ” Should deposit DEX collateral via strategist
      âœ” Should reject DEX deposit on T1 (stable) vault (44ms)
      âœ” Should reject DEX deposit from non-strategist
      âœ” Should allow timelock to toggle dexPool
      âœ” Should reject DEX deposit when dexEnabled is false
      âœ” Should reject DEX deposit with zero amounts

  FUZZ: InterestRateModel
    Utilization Rate Properties
      âœ” FUZZ: utilization is always in [0, 10000] bps for any supply/borrow
      âœ” FUZZ: utilization is monotonically non-decreasing with borrows (fixed supply)
    Borrow Rate Properties
      âœ” FUZZ: borrow rate is monotonically non-decreasing with utilization
      âœ” FUZZ: borrow rate is always >= baseRate for any utilization
      âœ” FUZZ: borrow rate jumps at kink
      âœ” FUZZ: supply rate <= borrow rate for any utilization (72ms)

  FUZZ: PriceOracle
    âœ” FUZZ: normalized price always has 18 decimals regardless of feed decimals (223ms)
    âœ” FUZZ: getPrice never returns negative (211ms)

  FUZZ: SMUSD ERC-4626 Properties
    âœ” FUZZ: convertToShares(convertToAssets(shares)) â‰ˆ shares (round-trip) (62ms)
    âœ” FUZZ: convertToAssets(convertToShares(assets)) â‰ˆ assets (round-trip) (53ms)
    âœ” FUZZ: deposit(x) then withdraw should return <= x assets (no free money)
    âœ” FUZZ: totalAssets >= totalSupply of shares implies sharePrice >= 1 (no dilution)
    âœ” FUZZ: previewDeposit <= deposit (actual shares >= preview) (60ms)

  FUZZ: LiquidationEngine
    âœ” FUZZ: healthy positions are never liquidatable across random price/collateral combos (162ms)
    âœ” FUZZ: liquidation penalty is always bounded by configured penalty bps
    âœ” FUZZ: price crashes always make undercollateralized positions liquidatable (52ms)

  FUZZ: Arithmetic Edge Cases
    âœ” FUZZ: very large deposit amounts don't overflow in InterestRateModel (51ms)
    âœ” FUZZ: zero/one edge cases in SMUSD share conversion

  GlobalPausable â€” whenNotGloballyPaused modifier
    No registry (address(0))
      âœ” globalPauseRegistry returns address(0)
      âœ” guarded function succeeds (modifier is no-op)
      âœ” multiple calls succeed
    Registry deployed and NOT paused
      âœ” globalPauseRegistry is set
      âœ” guarded function succeeds when not paused
    Registry deployed and PAUSED
      âœ” guarded function reverts with GloballyPaused
      âœ” unguarded function still succeeds when paused
      âœ” guarded function resumes after unpause
      âœ” full lifecycle: unpaused â†’ paused â†’ reverts â†’ unpaused â†’ succeeds

  GlobalPauseRegistry
    Deployment
      âœ” assigns DEFAULT_ADMIN_ROLE to admin
      âœ” assigns GUARDIAN_ROLE to guardian
      âœ” starts unpaused
      âœ” reverts on zero-address admin
      âœ” reverts on zero-address guardian
    pauseGlobal
      âœ” guardian can pause
      âœ” records lastPausedAt timestamp
      âœ” emits GlobalPauseStateChanged(true, guardian)
      âœ” reverts if already paused (AlreadyPaused)
      âœ” reverts when called by admin (not guardian)
      âœ” reverts when called by stranger
    unpauseGlobal
      âœ” admin can unpause
      âœ” records lastUnpausedAt timestamp
      âœ” emits GlobalPauseStateChanged(false, admin)
      âœ” reverts if not paused (NotPaused)
      âœ” reverts when called by guardian (separation of duties)
      âœ” reverts when called by stranger
    Role separation
      âœ” guardian CANNOT unpause (only admin can)
      âœ” admin CANNOT pause (only guardian can)
      âœ” full lifecycle: guardian pauses â†’ admin unpauses â†’ guardian pauses again
    Integration with GlobalPausable
      âœ” downstream contract reverts when globally paused
      âœ” timestamps are correctly tracked across multiple pause/unpause cycles

  PriceOracle â€” Circuit Breaker (Audit)
    setMaxDeviation
      âœ” should update max deviation within valid range
      âœ” should emit MaxDeviationUpdated event
      âœ” should reject deviation below 1% (100 bps)
      âœ” should reject deviation above 50% (5000 bps)
      âœ” should accept boundary values (100 and 5000 bps)
      âœ” should reject non-admin caller
    setCircuitBreakerEnabled
      âœ” should disable circuit breaker
      âœ” should re-enable circuit breaker
      âœ” should emit CircuitBreakerToggled event
      âœ” should reject non-admin caller
    resetLastKnownPrice
      âœ” should update lastKnownPrice from current feed
      âœ” should reject for disabled feed
      âœ” should reject when feed returns invalid price
      âœ” should reject non-admin caller
    updatePrice
      âœ” should update lastKnownPrice and emit event
      âœ” should emit CircuitBreakerTriggered with deviation info
      âœ” should reject for disabled feed
      âœ” should reject stale price
      âœ” should reject invalid price (zero)
      âœ” should reject non-admin caller
    getPrice â€” circuit breaker enforcement
      âœ” should block getPrice when price deviation exceeds threshold
      âœ” should allow getPrice within deviation threshold
      âœ” should bypass circuit breaker when disabled
      âœ” should allow getPrice after admin resets lastKnownPrice
      âœ” should allow getPrice after admin updatePrice
    getPriceUnsafe
      âœ” should return price even when circuit breaker would trigger
      âœ” should still enforce staleness check
      âœ” should still enforce valid price check
      âœ” should reject disabled feed
    getValueUsdUnsafe
      âœ” should calculate value bypassing circuit breaker
      âœ” should handle 8-decimal token (WBTC-like)
      âœ” should reject stale price
    setFeed â€” lastKnownPrice auto-init
      âœ” should auto-initialize lastKnownPrice on setFeed
      âœ” should update lastKnownPrice when feed is re-registered

  BorrowModule â€” Full Coverage (Audit)
    setInterestRateModel
      âœ” should set the interest rate model (39ms)
      âœ” should emit InterestRateModelUpdated event
      âœ” should reject zero address
      âœ” should reject non-admin caller
    setSMUSD
      âœ” should set the SMUSD address
      âœ” should emit SMUSDUpdated event
      âœ” should reject zero address
      âœ” should reject non-admin caller
    setTreasury
      âœ” should set the treasury address
      âœ” should emit TreasuryUpdated event
      âœ” should reject zero address
      âœ” should reject non-admin caller
    borrowFor
      âœ” should allow LEVERAGE_VAULT_ROLE to borrow on behalf of user
      âœ” should reject zero amount
      âœ” should reject zero user address
      âœ” should reject exceeding borrow capacity
      âœ” should reject non-LEVERAGE_VAULT_ROLE caller
      âœ” should reject below min debt
    repayFor
      âœ” should allow LEVERAGE_VAULT_ROLE to repay on behalf of user
      âœ” should reject zero amount
      âœ” should reject zero user address
      âœ” should reject when no debt exists
      âœ” should reject non-LEVERAGE_VAULT_ROLE caller
      âœ” should auto-close dust position on partial repay below min debt
    reduceDebt
      âœ” should reduce user debt on liquidation
      âœ” should handle reduction larger than debt
      âœ” should emit DebtAdjusted event
      âœ” should reject non-LIQUIDATION_ROLE caller
      âœ” should update totalBorrows correctly
    healthFactorUnsafe
      âœ” should return max when no debt
      âœ” should calculate health factor using unsafe oracle
      âœ” should work when circuit breaker trips (getPrice reverts)
    borrowCapacity
      âœ” should return correct capacity based on collateral
      âœ” should return zero for user with no collateral
    Interest Rate View Functions
      âœ” getUtilizationRate â€” should return 0 with no borrows
      âœ” getUtilizationRate â€” should return nonzero after borrowing (fallback mode)
      âœ” getUtilizationRate â€” should use interestRateModel when set
      âœ” getCurrentBorrowRate â€” should return fixed rate without model
      âœ” getCurrentBorrowRate â€” should return dynamic rate with model
      âœ” getCurrentSupplyRate â€” should return 90% of borrow rate without model
      âœ” getCurrentSupplyRate â€” should use model when set
      âœ” getTotalSupply â€” should return fallback when no treasury
      âœ” getTotalSupply â€” should return 2x borrows as fallback
    withdrawReserves
      âœ” should reject when no reserves exist
      âœ” should reject zero address recipient
      âœ” should reject non-admin caller
    Pause / Unpause
      âœ” should allow PAUSER_ROLE to pause
      âœ” should block borrow when paused
      âœ” should block repay when paused
      âœ” should block borrowFor when paused
      âœ” should block repayFor when paused
      âœ” should block withdrawCollateral when paused
      âœ” should require DEFAULT_ADMIN_ROLE to unpause (separation of duties)
      âœ” should reject pause from non-PAUSER_ROLE
    Dynamic Interest Routing (integration)
      âœ” should accrue interest with dynamic model and route to SMUSD
      âœ” should fall back to fixed rate when model not set
    Repay â€” dust position guard
      âœ” should auto-close dust position on partial repay below min debt
      âœ” should allow full repay to zero
    setMinDebt boundaries
      âœ” should reject zero min debt
      âœ” should reject min debt too high (>1e24)
      âœ” should accept boundary value (1e24)
      âœ” should emit MinDebtUpdated event
    setInterestRate boundaries
      âœ” should accept zero rate
      âœ” should accept max rate (5000 bps = 50%)
      âœ” should reject rate above 5000

  SMUSD â€” ERC-4626 Compliance (Audit)
    convertToShares / convertToAssets consistency
      âœ” convertToShares should match deposit result
      âœ” convertToAssets should match redeem result
      âœ” round-trip: convertToShares â†’ convertToAssets should approximate identity
    receiveInterest
      âœ” should accept interest from INTEREST_ROUTER_ROLE
      âœ” should reject zero amount
      âœ” should reject when no shares exist
      âœ” should reject interest exceeding MAX_YIELD_BPS cap
      âœ” should reject non-INTEREST_ROUTER_ROLE caller
    Canton Share Sync â€” rate limiting
      âœ” should reject sync too frequent (< 1 hour)
      âœ” should reject share change exceeding 5%
      âœ” should reject share decrease exceeding 5%
      âœ” should cap initial sync to 2x ETH shares

  CollateralVault â€” Additional Coverage (Audit)
    Collateral configuration
      âœ” should add multiple collateral types
      âœ” should reject duplicate collateral
      âœ” should update collateral config
      âœ” should disable collateral
    Deposit / Withdraw
      âœ” should track deposits per user per token
      âœ” should withdraw via BORROW_MODULE_ROLE

  LiquidationEngine â€” Additional Coverage (Audit)
    Full liquidation threshold
      âœ” should enforce close factor for partial undercollateralization
    estimateSeize accuracy
      âœ” should return correct seizure estimate

  DirectMintV2 â€” Fee Edge Cases (Audit)
    Minimum fee enforcement
      âœ” should charge minimum 1 wei USDC fee even on tiny redemptions (96ms)
    Fee tracking
      âœ” should track accumulated mint fees

  BLEBridgeV9 â€” Additional Coverage (Audit)
    Initialization
      âœ” should initialize with correct parameters
      âœ” should have MAX_ATTESTATION_AGE set
    Emergency controls
      âœ” should allow EMERGENCY_ROLE to pause
      âœ” should reject pause from non-EMERGENCY_ROLE

  InterestRateModel
    Initialization
      âœ” Should set correct default parameters
      âœ” Should grant RATE_ADMIN_ROLE to admin
    Utilization Rate
      âœ” Should return 0 when no supply
      âœ” Should calculate utilization correctly
      âœ” Should cap at 100% utilization
    Borrow Rate
      âœ” Should return base rate at 0% utilization
      âœ” Should increase linearly below kink
      âœ” Should jump above kink
    Supply Rate
      âœ” Should return 0 at 0% utilization
      âœ” Should account for reserve factor
    Interest Calculation
      âœ” Should calculate interest correctly
      âœ” Should return 0 for 0 principal or time
    Interest Splitting
      âœ” Should split interest according to reserve factor
    Admin Functions
      âœ” Should allow RATE_ADMIN to update params
      âœ” Should reject kink above 100%
      âœ” Should reject reserve factor above 50%
      âœ” Should reject max rate above 100%
      âœ” Should reject non-admin updates
    Rate Curve View
      âœ” Should return rate curve at 10% increments
    View Functions
      âœ” Should return all params in one call
    Annual Rates and Interest Calculation
      âœ” getBorrowRateAnnual should return correct BPS at typical utilization
      âœ” getSupplyRateAnnual should return correct BPS at typical utilization
      âœ” Annual borrow rate at 100% util should be highest
      âœ” calculateInterest avoids per-second truncation for small rates
    Enhanced Parameter Validation
      âœ” Should reject kinkBps > 10000 (KinkTooHigh)
      âœ” Should reject reserveFactorBps > 5000 (ReserveFactorTooHigh)
      âœ” Should reject params that produce maxRate > 10000 (InvalidParameter)
      âœ” Should reject another maxRate > 10000 combination (InvalidParameter)
      âœ” Should accept valid params at boundary

  LeverageMathLib
    calculateFlashLoanAmount
      âœ” 75% LTV â†’ flash = deposit * 3 (4x leverage)
      âœ” 50% LTV â†’ flash = deposit * 1 (2x leverage)
      âœ” 0% LTV â†’ flash = 0
      âœ” 100% LTV (>= BPS) â†’ returns 0
      âœ” over 100% LTV â†’ returns 0
      âœ” zero deposit â†’ zero flash
    ltvToLeverage
      âœ” 0% LTV â†’ 1x leverage (100)
      âœ” 50% LTV â†’ 2x leverage (200)
      âœ” 75% LTV â†’ 4x leverage (400)
      âœ” 100% LTV (>= BPS) â†’ max uint256
      âœ” over 100% LTV â†’ max uint256
    calculateLtv
      âœ” 50% LTV from equal collateral/debt ratio
      âœ” zero collateral â†’ returns 0
      âœ” zero debt â†’ returns 0
      âœ” 100% LTV
      âœ” > 100% LTV (underwater)
    calculateHealthFactor
      âœ” collateral = debt â†’ health factor = 1.0 (WAD)
      âœ” collateral = 2 * debt â†’ health factor = 2.0
      âœ” zero debt â†’ max uint256
      âœ” zero collateral with debt â†’ health factor = 0
    calculateNetValue
      âœ” collateral > debt â†’ positive net value
      âœ” collateral < debt â†’ floors at 0
      âœ” collateral == debt â†’ 0
      âœ” zero debt â†’ net value = collateral
    calculateSharePrice
      âœ” equal value and shares â†’ 1.0 WAD
      âœ” zero shares â†’ default 1.0 WAD
      âœ” value > shares â†’ price > 1.0
      âœ” value < shares â†’ price < 1.0
      âœ” zero value + zero shares â†’ 1.0 WAD
    needsRebalance
      âœ” within threshold â†’ no rebalance needed
      âœ” over-leveraged beyond threshold â†’ rebalance + over-leveraged
      âœ” under-leveraged beyond threshold â†’ rebalance + not over-leveraged
      âœ” at exact threshold boundary â†’ no rebalance
      âœ” zero threshold â†’ any difference triggers rebalance
    calculateDeleverageAmount
      âœ” excess debt when over target LTV
      âœ” zero excess when at target LTV
      âœ” zero excess when under target LTV
      âœ” zero collateral â†’ target debt = 0, excess = full debt
    calculateReleverageAmount
      âœ” deficit when under target LTV
      âœ” zero deficit when at target LTV
      âœ” zero deficit when over target LTV
      âœ” with large WAD-scaled values
    validateSharePrice
      âœ” price above min â†’ valid
      âœ” price equal to min â†’ valid
      âœ” price below min â†’ invalid
      âœ” zero price, zero min â†’ valid

  LeverageVault
    Deployment
      âœ” should deploy with correct parameters
      âœ” should have WETH enabled for leverage
    Open Leveraged Position
      âœ” should open a 2x leveraged position
      âœ” should reject leverage exceeding max for LTV
      âœ” should reject if token not enabled
      âœ” should reject second position if one already exists
    Admin Functions
      âœ” should allow admin to update config
      âœ” should reject invalid max loops
      âœ” should reject invalid slippage
      âœ” should allow admin to enable/disable tokens
      âœ” should allow admin to set max leverage
      âœ” should reject leverage above configured max
      âœ” should reject invalid max leverage values
    View Functions
      âœ” should estimate loops correctly
      âœ” should return effective leverage
      âœ” should return zero leverage for no position
      âœ” should return position details
    Emergency Functions
      âœ” should reject emergency close for no position
      âœ” should reject emergency close from non-admin
      âœ” should allow emergency withdraw of stuck tokens
      âœ” should reject emergency withdraw from non-timelock
    Pause/Unpause
      âœ” should pause operations
      âœ” should reject operations when paused
      âœ” should require admin to unpause
      âœ” should resume operations after unpause
    Edge Cases
      âœ” should reject zero initial amount
      âœ” should reject leverage too low
      âœ” should reject invalid token address for enable
      âœ” should reject invalid fee tier
      âœ” should revert cleanly on swap failure without leaving debt or position
    User-Specified Slippage
      âœ” should close position with user-specified slippage
    Close Leveraged Position
      âœ” should close a 2x position and return collateral
      âœ” should fail close with insufficient minCollateralOut (slippage protection)
      âœ” should fail close when no position exists
    Close Leveraged Position With mUSD
      âœ” should close position by providing mUSD directly
      âœ” should refund excess mUSD
      âœ” should fail with insufficient mUSD
      âœ” should fail when no position exists
    mUSD Needed To Close
      âœ” should return correct debt amount for open position
      âœ” should return 0 for no position
    Emergency Close Position
      âœ” admin should emergency close a user position

  LeverageVault â€” Extended Coverage
    Price change PnL
      âœ” user profits when collateral price increases (50ms)
      âœ” user loses when collateral price decreases
    Multi-user isolation
      âœ” two users can have independent positions
      âœ” closing one position doesn't affect another
    Emergency close resilience
      âœ” emergency close with enough swap router funds succeeds
      âœ” emergency close isolation: other users unaffected
    Token management edge cases
      âœ” accepts valid fee tiers: 500, 3000, 10000
      âœ” cannot open position on disabled token
    Interest accrual on leveraged debt
      âœ” debt grows over time
    getPosition edge cases
      âœ” returns zero struct for non-existent user
      âœ” reflects correct debt after time passes
    setConfig boundary tests
      âœ” rejects maxLoops = 0
      âœ” accepts maxLoops = 20
      âœ” rejects slippage = 501 (> 5%)
      âœ” accepts maxSlippageBps = 500 (boundary)
      âœ” accepts maxSlippageBps = 300

  TEST-004: LeverageVault Flash Loan & Security Tests
    ReentrancyGuard prevents reentrant calls
      âœ” openLeveragedPosition has nonReentrant modifier (50ms)
      âœ” closeLeveragedPosition has nonReentrant modifier
      âœ” cannot open a second position while one is active
    SOL-003: emergencyClosePosition does not sweep other users' residuals
      âœ” user2 residual tokens in vault contract are not sent to user1 during emergency close
      âœ” emergency close should only clear the targeted user's position
      âœ” emergency close reverts for non-admin caller
      âœ” emergency close reverts when user has no position
    Flash loan attack vector prevention
      âœ” attacker cannot open position with zero collateral
      âœ” attacker cannot exceed maximum allowed leverage
      âœ” attacker cannot set leverage below 1x
      âœ” position cannot be opened on disabled token
      âœ” large position opening and closing preserves invariant: user gets back <= deposited (no free money)
      âœ” closing position with mUSD: user cannot extract value by providing exact debt amount
      âœ” closeLeveragedPositionWithMusd reverts when insufficient mUSD provided
    Pausable emergency controls
      âœ” admin can pause and unpause the vault
      âœ” opening position is blocked when paused
      âœ” closing position is blocked when paused
      âœ” closeLeveragedPositionWithMusd is blocked when paused
      âœ” emergencyClosePosition works even when paused (admin recovery)
      âœ” non-pauser cannot pause
      âœ” non-admin cannot unpause
    Admin configuration security
      âœ” setMaxLeverage rejects values outside [10, 40] range
      âœ” setMaxLeverage accepts valid values
      âœ” setConfig rejects slippage above 5%
      âœ” setConfig rejects zero maxLoops
      âœ” setConfig rejects maxLoops > 20
      âœ” enableToken rejects invalid fee tiers
      âœ” enableToken accepts valid Uniswap V3 fee tiers
      âœ” non-admin cannot change configuration

  LiquidationEngine
    Deployment
      âœ” Should initialize with correct parameters (38ms)
      âœ” Should set close factor correctly
      âœ” Should set full liquidation threshold
    Liquidation Eligibility
      âœ” Should correctly identify liquidatable positions
      âœ” Should return false for healthy positions
      âœ” Should return false for positions with no debt
    Liquidation Execution
      âœ” Should liquidate undercollateralized position
      âœ” Should reduce borrower debt after liquidation
      âœ” Should reject liquidation of healthy position
      âœ” Should reject self-liquidation
      âœ” Should emit Liquidation event
    Close Factor Limits
      âœ” Should respect close factor when position is not severely undercollateralized
    Estimate Functions
      âœ” Should estimate collateral seizure correctly
    Admin Functions
      âœ” Should allow admin to update close factor
      âœ” Should reject invalid close factor
      âœ” Should allow admin to update full liquidation threshold
      âœ” Should reject non-admin setting close factor

  MUSD
    Deployment
      âœ” should set correct name and symbol
      âœ” should set initial supply cap
      âœ” should revert with zero supply cap
      âœ” should grant DEFAULT_ADMIN_ROLE to deployer
    Minting
      âœ” should mint tokens with BRIDGE_ROLE
      âœ” should reject mint without BRIDGE_ROLE
      âœ” should reject mint exceeding supply cap
      âœ” should allow minting up to exact supply cap
      âœ” should reject mint of 1 wei over supply cap
      âœ” should emit Mint event
    Burning
      âœ” should burn tokens with BRIDGE_ROLE (self burn)
      âœ” should burn tokens from user with allowance
      âœ” should reject burn without allowance
      âœ” should emit Burn event
    Supply Cap
      âœ” should allow admin to update supply cap
      âœ” should allow CAP_MANAGER_ROLE to update supply cap
      âœ” should reject unauthorized supply cap change
      âœ” should reject zero supply cap
      âœ” should ALLOW cap below current supply (undercollateralization response)
      âœ” should allow cap equal to current supply
      âœ” should emit SupplyCapUpdated event
    Blacklist
      âœ” should blacklist an account
      âœ” should block transfers from blacklisted sender
      âœ” should block transfers to blacklisted receiver
      âœ” should block minting to blacklisted address
      âœ” should remove from blacklist
      âœ” should reject blacklist of zero address
      âœ” should reject blacklist without COMPLIANCE_ROLE
    Pausable
      âœ” should allow EMERGENCY_ROLE to pause
      âœ” should block transfers when paused
      âœ” should block minting when paused
      âœ” should require DEFAULT_ADMIN_ROLE to unpause (separation of duties)
      âœ” should resume transfers after unpause
      âœ” should reject pause without EMERGENCY_ROLE
    Transfers
      âœ” should transfer tokens
      âœ” should handle transferFrom with approval

  MetaVault
    Initialization
      âœ” sets correct initial state (59ms)
      âœ” reverts on zero addresses in initialize
      âœ” grants TREASURY_ROLE to treasury address
    Sub-strategy management
      âœ” adds 4 sub-strategies with correct weights summing to 10000
      âœ” reverts deposit when weights don't sum to 10000
      âœ” reverts when adding more than 4 strategies
      âœ” reverts when non-strategist tries to add
      âœ” removes a sub-strategy and withdraws its funds
      âœ” updates weights via setWeights
      âœ” reverts setWeights with wrong length
      âœ” toggles sub-strategy (circuit breaker)
    Deposits
      âœ” deposits and splits across 4 sub-strategies by weight
      âœ” reverts deposit when inactive
      âœ” reverts deposit of zero
      âœ” reverts deposit with no sub-strategies
      âœ” reverts deposit from non-treasury
      âœ” respects per-strategy cap on deposit
      âœ” skips disabled sub-strategies on deposit
    Withdrawals
      âœ” withdraws pro-rata from all sub-strategies
      âœ” withdrawAll returns everything to treasury
      âœ” reverts withdraw of zero
      âœ” uses idle USDC first before pulling from sub-strategies
    Rebalance
      âœ” rebalances when drift exceeds threshold
      âœ” reverts rebalance if drift below threshold
      âœ” reverts rebalance before cooldown elapsed
      âœ” reverts rebalance from non-keeper
    Emergency
      âœ” emergency withdraws from a single sub-strategy
      âœ” emergency withdraws all
      âœ” reverts emergency from non-guardian
    Pause / Admin
      âœ” pause blocks deposits
      âœ” unpause resumes deposits
      âœ” sets cap on sub-strategy
    View helpers
      âœ” currentAllocations returns correct BPS
      âœ” currentDrift returns 0 when perfectly balanced
      âœ” currentDrift increases when one strategy gets yield

  MintedYB
    âœ” should be implemented

  MorphoLoopStrategy
    Initialization
      âœ” Should set correct initial parameters (49ms)
      âœ” Should grant roles correctly
      âœ” Should not allow re-initialization
    Deposit
      âœ” Should accept deposit from treasury
      âœ” Should revert deposit with zero amount
      âœ” Should revert deposit from non-treasury
      âœ” Should revert deposit when strategy is inactive
      âœ” Should revert deposit when paused
    Withdraw
      âœ” Should withdraw funds
      âœ” Should withdraw all funds
      âœ” Should revert withdraw with zero amount
      âœ” Should revert withdraw from non-treasury
    View Functions
      âœ” Should return total value
      âœ” Should return asset token
    Admin Functions
      âœ” Should update parameters
      âœ” Should revert on excessive loops
      âœ” Should revert on invalid LTV (too high)
      âœ” Should revert on invalid LTV (too low)
      âœ” Should set active status
      âœ” Should revert admin functions for non-strategist
    Emergency Controls
      âœ” Should pause operations
      âœ” Should unpause operations
      âœ” Should emergency deleverage
    Upgradeability
      âœ” Should be upgradeable by timelock (103ms)
      âœ” Should not be upgradeable by non-admin (41ms)
      âœ” Should preserve state after upgrade
    Role Management
      âœ” Should allow admin to grant strategist role
      âœ” Should allow admin to revoke roles
    View Functions Extended
      âœ” Should return market ID
      âœ” Should return safety buffer
      âœ” Should return target loops
      âœ” Should return active status
    Deposit Edge Cases
      âœ” Should handle multiple sequential deposits
      âœ” Should handle small deposits
    Withdraw Edge Cases
      âœ” Should handle partial withdrawals
      âœ” Should handle withdrawals when paused
    Emergency Deleverage Edge Cases
      âœ” Should deleverage with no position gracefully
      âœ” Should only allow guardian to deleverage

  PendleMarketSelector
    Initialization
      âœ” Should set correct initial parameters (51ms)
      âœ” Should grant roles to admin
      âœ” Should not allow re-initialization
    Market Whitelisting
      âœ” Should whitelist a market
      âœ” Should batch whitelist markets
      âœ” Should remove a market from whitelist
      âœ” Should revert whitelist for non-market-admin
      âœ” Should revert whitelist for zero address
      âœ” Should revert batch whitelist with mismatched arrays
    Parameter Updates
      âœ” Should update selection parameters
      âœ” Should revert on invalid weights (not summing to 10000)
      âœ” Should update minimum APY via setParams
      âœ” Should revert parameter update for non-params-admin
    View Functions
      âœ” Should return whitelisted markets array
      âœ” Should check if market is valid
    Market Selection
      âœ” Should revert with NoValidMarkets when no markets match
      âœ” Should revert with NoValidMarkets when category doesn't match
      âœ” Should return valid markets for category
      âœ” Should check if market is whitelisted after removal
    Additional Admin Functions
      âœ” Should revert remove for non-admin
      âœ” Should emit event on market removal
      âœ” Should handle duplicate whitelist gracefully
      âœ” Should preserve state after upgrade
    Edge Cases
      âœ” Should handle empty category string
      âœ” Should return empty array for no whitelisted markets
    Upgradeability
      âœ” Should be upgradeable by admin
      âœ” Should not be upgradeable by non-admin (75ms)

  PendleStrategyV2
    Initialization
      âœ” Should set correct initial parameters (123ms)
      âœ” Should grant roles correctly
      âœ” Should not allow re-initialization
      âœ” Should revert on zero address in initialize
    View Functions
      âœ” Should return asset token
      âœ” Should return total value (zero when no deposits)
      âœ” Should return PT balance (zero when no deposits)
      âœ” Should return current market (zero when not set)
    Admin Functions
      âœ” Should update slippage
      âœ” Should revert on invalid slippage (too high)
      âœ” Should update rollover threshold
      âœ” Should set active status
      âœ” Should update market selector
      âœ” Should revert admin functions for non-strategist
    Emergency Controls
      âœ” Should pause operations
      âœ” Should unpause operations
      âœ” Should prevent deposits when paused
      âœ” Should prevent deposits when inactive
    Deposit Validation
      âœ” Should revert deposit with zero amount
      âœ” Should revert deposit from non-treasury
    Withdraw Validation
      âœ” Should revert withdraw with zero amount
      âœ” Should revert withdraw from non-treasury
    Upgradeability
      âœ” Should be upgradeable by admin (70ms)
      âœ” Should not be upgradeable by non-admin (109ms)
      âœ” Should preserve state after upgrade
    Additional Admin Functions
      âœ” Should update market selector with zero address revert
      âœ” Should emit SlippageUpdated event
      âœ” Should update rollover threshold
    Role Management
      âœ” Should allow admin to grant strategist role
      âœ” Should allow admin to revoke roles
      âœ” Should prevent non-admin from granting roles
    View Functions Extended
      âœ” Should return market category
      âœ” Should return rollover threshold
      âœ” Should return active status
      âœ” Should return slippage settings
      âœ” Should return current PT and SY addresses (zero when no market)
    Edge Cases
      âœ” Should handle zero slippage setting
      âœ” Should handle minimum rollover threshold
    PT Discount Rate
      âœ” Should set PT discount rate as strategist
      âœ” Should emit PtDiscountRateUpdated event
      âœ” Should reject discount rate above 50%
      âœ” Should allow zero discount rate
      âœ” Should allow max 50% discount rate
      âœ” Should reject non-strategist setting discount rate
    Upgrade Authorization
      âœ” Should allow admin to perform UUPS upgrade
      âœ” Should reject upgrade from non-admin
    Rollover View Functions
      âœ” Should return true for shouldRollover when no market is set
      âœ” Should return 0 timeToExpiry when no market is set
    Guardian setActive
      âœ” Should allow guardian to deactivate strategy
      âœ” Should allow guardian to reactivate strategy
      âœ” Should reject setActive from non-guardian
      âœ” Should reject strategist from calling setActive (needs GUARDIAN_ROLE)
    Rollover Threshold Edge Cases
      âœ” Should reject zero rollover threshold
      âœ” Should allow max rollover threshold (30 days)
      âœ” Should emit RolloverThresholdUpdated event
      âœ” Should reject non-strategist from setting rollover threshold
    Recover Token
      âœ” Should recover random stuck tokens
      âœ” Should reject recovering USDC
      âœ” Should reject non-admin from recovering tokens
    isActive View Function
      âœ” Should return true when active and not paused
      âœ” Should return false when paused
      âœ” Should return false when inactive
      âœ” Should return false when both paused and inactive

  PriceAggregator
    Deployment
      âœ” initializes correctly
      âœ” grants ORACLE_ADMIN_ROLE
    Adapter Management
      âœ” adds adapter
      âœ” adds up to MAX_ADAPTERS
      âœ” removes adapter
      âœ” reverts adding zero address
      âœ” reverts from unauthorized caller
      âœ” sets adapters in batch
    Price Queries
      âœ” returns price from single adapter
      âœ” reverts with no adapters
      âœ” getAllPrices returns prices from all adapters
    Deviation
      âœ” sets max deviation
      âœ” toggles cross-validation
    UUPS Upgrade
      âœ” blocks upgrade from non-timelock (43ms)

  PriceOracle
    Feed Management
      âœ” should add a feed
      âœ” should reject zero token address
      âœ” should reject zero feed address
      âœ” should reject zero stale period
      âœ” should reject tokenDecimals > 18
      âœ” should remove a feed
      âœ” should reject remove of non-existent feed
      âœ” should reject unauthorized feed changes
    getPrice
      âœ” should return normalized 18-decimal price for ETH
      âœ” should return normalized price for BTC
      âœ” should reject query for disabled feed
      âœ” should reject stale price
      âœ” should reject zero/negative price
      âœ” should reject negative price
    getValueUsd
      âœ” should calculate USD value for 18-decimal token (ETH)
      âœ” should calculate USD value for 8-decimal token (WBTC)
      âœ” should handle fractional amounts correctly
      âœ” should handle zero amount
    isFeedHealthy
      âœ” should return true for healthy feed
      âœ” should return false for stale feed
      âœ” should return false for disabled feed
      âœ” should return false for zero price

  RedemptionQueue
    Initialization
      âœ” Should initialize with correct parameters
      âœ” Should revert with zero token addresses
    Queue Redemption
      âœ” Should queue a redemption request
      âœ” Should lock mUSD in the contract
      âœ” Should revert on zero amount
      âœ” Should revert on dust amount (< 1 USDC equivalent)
      âœ” Should revert if slippage exceeded
      âœ” Should queue multiple requests from same user
      âœ” Should revert when paused
    Process Batch
      âœ” Should process requests in FIFO order after cooldown
      âœ” Should process multiple requests in one batch
      âœ” Should respect cooldown period
      âœ” Should respect daily redemption limit
      âœ” Should respect USDC liquidity
      âœ” Should skip cancelled requests
      âœ” Should reset daily limit after 24 hours
      âœ” Should revert if caller lacks PROCESSOR_ROLE
    Cancel Redemption
      âœ” Should cancel and return mUSD
      âœ” Should revert if not request owner
      âœ” Should revert if already fulfilled
      âœ” Should revert if already cancelled
      âœ” Should revert for invalid request ID
    Admin Functions
      âœ” Should update max daily redemption
      âœ” Should update min request age
      âœ” Should restrict admin functions to DEFAULT_ADMIN_ROLE
    Pause / Unpause
      âœ” Pauser can pause
      âœ” Admin can unpause
      âœ” Non-pauser cannot pause
      âœ” Non-admin cannot unpause
    View Functions
      âœ” Should return correct queue length
      âœ” Should return correct pending count
    Edge Cases
      âœ” Should handle empty queue processBatch gracefully
      âœ” Should handle processBatch with maxCount=0
      âœ” Should handle multiple users queueing and processing

  TEST-002: Relay Utils â€” isValidSecp256k1PrivateKey
    Valid keys
      âœ” should accept a well-known valid private key (32 bytes, no 0x prefix)
      âœ” should accept a valid key with 0x prefix
      âœ” should accept key = n - 1 (maximum valid key)
      âœ” should accept a mid-range hex key
      âœ” should accept key with mixed-case hex characters
      âœ” should accept key = 2 (small but valid)
    Invalid keys â€” zero
      âœ” should reject zero key (all zeros)
      âœ” should reject zero key with 0x prefix
    Invalid keys â€” at or above curve order
      âœ” should reject key equal to curve order n
      âœ” should reject key equal to n + 1
      âœ” should reject key = 0xFFFF...FFFF (all ones, above curve order)
    Invalid keys â€” malformed input
      âœ” should reject empty string
      âœ” should reject too-short hex string (31 bytes)
      âœ” should reject too-long hex string (33 bytes)
      âœ” should reject non-hex characters
      âœ” should reject string with spaces
      âœ” should reject key with special characters
      âœ” should reject bare 0x prefix with no key data

  TEST-002: Relay Utils â€” readSecret
    âœ” should fall back to env var when Docker secret path does not exist
    âœ” should return empty string when neither secret file nor env var exists
    âœ” should handle undefined env var gracefully
    âœ” should read env var correctly with whitespace value

  TEST-002: Relay Utils â€” readAndValidatePrivateKey
    âœ” should return empty string when key is not set
    âœ” should return valid key when env var contains a valid private key
    âœ” should throw for invalid private key (zero)
    âœ” should throw for private key above curve order
    âœ” should throw for malformed key (wrong length)
    âœ” should include env var name in error message for diagnostics

  TEST-002: Relay Signer â€” formatKMSSignature validation
    âœ” should reject null/undefined derSig input
    âœ” should reject non-Buffer derSig
    âœ” should reject messageHash without 0x prefix
    âœ” should reject publicKey without 0x prefix
    âœ” should reject DER signature that is too short (< 8 bytes)
    âœ” should reject DER signature with wrong sequence tag
    âœ” should reject DER signature with length exceeding buffer

  TEST-002: Relay Config â€” parseInt radix & URL validation patterns
    âœ” parseInt with radix 10 produces correct results for decimal strings
    âœ” parseInt with radix 10 avoids octal interpretation of leading-zero strings
    âœ” parseInt with radix 10 returns NaN for non-numeric strings
    âœ” HTTP RPC URL should trigger warning for non-localhost
    âœ” HTTPS RPC URL should NOT trigger warning
    âœ” localhost HTTP URL should NOT trigger warning (dev environment)
    âœ” 127.0.0.1 HTTP URL should NOT trigger warning (loopback)
    âœ” VALIDATOR_ADDRESSES JSON size should be bounded to 10KB

  SMUSD
    Deployment
      âœ” should set correct name and symbol
      âœ” should use mUSD as underlying asset
      âœ” should have decimalsOffset of 3
    Deposit
      âœ” should accept deposits and issue shares
      âœ” should set cooldown for depositor
      âœ” should set cooldown for receiver (not depositor) on third-party deposit
    Donation Attack Resistance
      âœ” should be economically unprofitable for first depositor to donate then redeem
    Withdraw
      âœ” should reject withdrawal during cooldown
      âœ” should allow withdrawal after cooldown
      âœ” should enforce cooldown on redeem() too
      âœ” should allow redeem after cooldown
    Transfer cooldown propagation
      âœ” should propagate stricter cooldown to receiver
      âœ” should not weaken receiver's existing cooldown
    Yield Distribution
      âœ” should increase share value after yield
      âœ” should reject yield distribution with no shares
      âœ” should reject zero yield
      âœ” should reject yield without YIELD_MANAGER_ROLE
      âœ” should reject yield exceeding MAX_YIELD_BPS cap
      âœ” should accept yield within MAX_YIELD_BPS cap
    Pause/Unpause
      âœ” should allow PAUSER_ROLE to pause
      âœ” should reject deposit when paused
      âœ” should reject withdraw when paused
      âœ” should require DEFAULT_ADMIN_ROLE for unpause
      âœ” should resume operations after unpause
    Treasury Integration
      âœ” should set treasury address
      âœ” should reject zero address for treasury
      âœ” should emit TreasuryUpdated event
      âœ” should reject treasury update from non-admin
    Canton Shares Sync
      âœ” should sync Canton shares from bridge
      âœ” should reject non-sequential epoch
      âœ” should update global total shares
      âœ” should reject sync from non-bridge
      âœ” should emit CantonSharesSynced event
    Global Share Price
      âœ” should return correct global share price with no Canton shares
      âœ” should return default price with no shares
      âœ” should return ethereum total shares
      âœ” should return global total assets without treasury
    View Functions
      âœ” should return remaining cooldown correctly
      âœ” should return zero remaining cooldown after expiry
      âœ” should convert assets to shares correctly
      âœ” should convert shares to assets correctly

  SMUSDE
    Deployment
      âœ” has correct name and symbol
      âœ” starts with zero supply
    Mint & Burn
      âœ” pool can mint
      âœ” pool can burn
      âœ” reverts mint to zero address
      âœ” reverts mint of zero amount
      âœ” reverts burn exceeding balance
      âœ” non-pool cannot mint
      âœ” non-pool cannot burn
    Blacklist
      âœ” compliance can blacklist
      âœ” blocks transfers from blacklisted
      âœ” blocks transfers to blacklisted
      âœ” non-compliance cannot blacklist
      âœ” reverts blacklisting zero address
    Pausable
      âœ” pauser can pause
      âœ” transfers blocked when paused
      âœ” admin can unpause
      âœ” non-pauser cannot pause
    Transfers
      âœ” standard transfer works
      âœ” transferFrom with approval works

  SMUSDPriceAdapter
    Deployment
      âœ” should set correct smusd address
      âœ” should set initial round ID to 1
      âœ” should set default price bounds
      âœ” should grant admin roles
      âœ” should revert with zero address for smusd
    AggregatorV3 Interface
      âœ” should return 8 decimals
      âœ” should return correct description
      âœ” should return version 1
    Share Price
      âœ” should return 1.0 USD for 1:1 share price
      âœ” should reflect increased share price after yield
      âœ” should handle 1.50 USD share price
      âœ” should return consistent data between latestRoundData and getRoundData
      âœ” should set timestamps to block.timestamp
      âœ” should set answeredInRound equal to roundId
      âœ” should update price when vault share price changes (48ms)
    Price Bounds
      âœ” should clamp when share price is below minimum (0.95 USD)
      âœ” should clamp when share price exceeds maximum (2.0 USD)
      âœ” should accept price right at minimum bound (0.95 USD)
      âœ” should accept price right at maximum bound (2.0 USD)
      âœ” should clamp when price is just below minimum
      âœ” should clamp when price is just above maximum
      âœ” should respect updated bounds
      âœ” should clamp with tightened bounds
      âœ” should clamp on getRoundData when price out of bounds
    Admin Functions
      setSharePriceBounds
        âœ” should update price bounds
        âœ” should emit SharePriceBoundsUpdated event
        âœ” should revert if min is zero
        âœ” should revert if max <= min
        âœ” should revert if max equals min
        âœ” should revert if max exceeds $10 cap
        âœ” should accept max at exactly $10 cap
        âœ” should revert when called by non-admin
      incrementRound
        âœ” should increment roundId
        âœ” should increment multiple times
        âœ” should revert when called by non-admin
    Integration
      âœ” should track price changes as vault accrues yield over time
      âœ” should work correctly with the PriceOracle feed format
      âœ” should work with incrementRound and changing prices

  SkySUSDSStrategy
    âœ” deploys via proxy and initializes
    âœ” rejects initialization with zero addresses (74ms)
    âœ” blocks re-initialization (82ms)
    âœ” only TREASURY_ROLE can deposit
    âœ” only TREASURY_ROLE can withdraw
    âœ” STRATEGIST_ROLE can toggle active (86ms)
    âœ” GUARDIAN can pause, DEFAULT_ADMIN can unpause
    âœ” deposit reverts when paused
    âœ” deposit reverts with zero amount
    âœ” recover rejects protected tokens

  SkySUSDSStrategy â€” Happy Path
    deposit (happy path)
      âœ” deposits USDC â†’ PSM â†’ sUSDS successfully
      âœ” updates totalPrincipal after deposit (38ms)
      âœ” multiple deposits accumulate principal (90ms)
    withdraw (happy path)
      âœ” withdraws USDC back to treasury (96ms)
      âœ” emits Withdrawn event (40ms)
      âœ” withdraw zero amount reverts (39ms)
      âœ” updates totalPrincipal after withdrawal (92ms)
    withdrawAll (happy path)
      âœ” withdraws all USDC and resets principal (42ms)
      âœ” withdrawAll with zero shares returns dust
    totalValue
      âœ” returns deposited amount (1:1 exchange rate) (97ms)
      âœ” reflects yield when exchange rate increases (45ms)
    sUsdsShares
      âœ” returns non-zero after deposit (38ms)
    unrealizedYield
      âœ” returns 0 when exchange rate is 1:1 (91ms)
      âœ” returns positive yield when exchange rate increases (90ms)
    emergencyWithdraw
      âœ” redeems all sUSDS, holds USDC in contract, pauses (40ms)
      âœ” emergencyWithdraw resets totalPrincipal to 0
    recoverToken (success)
      âœ” recovers a non-protected ERC20 (55ms)
      âœ” reverts when recovering sUSDS (70ms)
    isActive
      âœ” returns false when paused even if active flag is true (38ms)
      âœ” returns false when active flag is false even if not paused

  StabilityDAOFeatures
    âœ” should be implemented

  TimelockGoverned â€” setTimelock / onlyTimelock modifier
    Constructor / _setTimelock
      âœ” sets timelock correctly on construction
      âœ” emits TimelockUpdated(address(0), newTimelock) on construction
      âœ” reverts with ZeroTimelock when constructed with address(0)
      âœ” reverts when initializeTimelock called with address(0)
    onlyTimelock modifier
      âœ” allows timelock to call gated functions
      âœ” reverts with OnlyTimelock when called by deployer
      âœ” reverts with OnlyTimelock when called by attacker
    setTimelock
      âœ” timelock can migrate to a new timelock
      âœ” old timelock loses access after migration
      âœ” reverts with ZeroTimelock when setting to address(0)
      âœ” reverts with OnlyTimelock when non-timelock calls setTimelock
      âœ” new timelock can perform a second migration

  Timelock Wiring â€” Findings #3 & #4
    Finding #3: Central OZ TimelockController wiring
      âœ” timelock has TIMELOCK_ROLE on CollateralVaultUpgradeable
      âœ” admin (deployer) does NOT have TIMELOCK_ROLE
      âœ” setBorrowModule reverts when called directly by admin
      âœ” setBorrowModule succeeds when called through timelock
      âœ” addCollateral reverts when called directly by admin
      âœ” addCollateral succeeds through timelock after delay
      âœ” no hand-rolled request/cancel/execute functions exist
    Finding #4: UUPS upgrades gated by TIMELOCK_ROLE
      âœ” direct upgradeToAndCall by admin reverts
      âœ” upgrade succeeds through timelock after 48h delay
      âœ” attacker cannot upgrade even with DEFAULT_ADMIN_ROLE
    Timelock safety properties
      âœ” operations cannot be executed before delay elapses
      âœ” non-proposer cannot schedule operations
      âœ” non-executor cannot execute ready operations
      âœ” minimum delay enforced at deployment (< 24h rejected)

  TreasuryReceiver
    Deployment
      âœ” Should set correct initial state
      âœ” Should grant roles to deployer
      âœ” Should revert on zero address parameters
    Router Authorization
      âœ” Should authorize router
      âœ” Should revoke router
      âœ” Should revert router authorization for non-bridge-admin
    View Functions
      âœ” Should track processed VAAs
      âœ” Should return chain ID constants
    Admin Functions
      âœ” Should update DirectMint address
      âœ” Should update Treasury address
      âœ” Should revert update with zero address
      âœ” Should revert admin functions for non-admin
    receiveAndMint
      âœ” Should receive bridged USDC and mint mUSD via DirectMint
      âœ” Should queue a pending mint when DirectMint fails
      âœ” Should allow recipient to claim queued mint once DirectMint recovers
      âœ” Should reject invalid VAA
      âœ” Should reject replay (same VAA hash)
      âœ” Should reject unauthorized router
      âœ” Should reject when paused
    Emergency Controls
      âœ” Should pause operations
      âœ” Should unpause operations
      âœ” Should require DEFAULT_ADMIN_ROLE for unpause
      âœ” Should allow emergency withdrawal
      âœ” Should revert emergency withdraw for non-admin

  TreasuryV2
    Initialization
      âœ” Should initialize with correct defaults
      âœ” Should reject zero addresses on init
    Strategy Management
      âœ” Should add a strategy
      âœ” Should add multiple strategies with correct allocation
      âœ” Should reject duplicate strategy
      âœ” Should reject allocation exceeding 100%
      âœ” Should reject more than MAX_STRATEGIES (46ms)
      âœ” Should remove a strategy and withdraw funds
      âœ” Should update strategy allocation
    Auto-Allocation
      âœ” Should auto-allocate deposit across strategies
      âœ” Should keep small deposits in reserve
      âœ” Should handle strategy deposit failure gracefully
    Withdrawal
      âœ” Should withdraw from reserve when sufficient
      âœ” Should withdraw from strategies when reserve insufficient
      âœ” Should revert on insufficient total balance
    Vault Interface
      âœ” Should depositFromVault with auto-allocation
      âœ” Should withdrawToVault from reserve + strategies
      âœ” Should reject deposits from non-vault
    Fee Accrual
      âœ” Should accrue fees on yield
      âœ” Should claim fees to recipient
    Rebalancing
      âœ” Should rebalance from over-allocated to under-allocated
    Emergency
      âœ” Should emergency withdraw all from strategies
      âœ” Should pause and unpause
    Admin
      âœ” Should update fee config
      âœ” Should reject fee too high (39ms)
      âœ” Should update reserve bps
      âœ” Should reject reserve too high
      âœ” Should update vault address via timelock
      âœ” Should reject vault change from non-timelock
      âœ” Should update min auto-allocate
    View Functions
      âœ” Should report correct totalValue
      âœ” Should report totalValueNet minus fees
      âœ” Should return correct current allocations
      âœ” Should report strategies via getAllStrategies
    Strategy Rollover
      âœ” Should remove a funded strategy (funds returned) and add a replacement
      âœ” Should handle rollover when old strategy withdraw fails
      âœ” Should remove an empty strategy cleanly
    Token Recovery
      âœ” Should recover a non-primary token to the timelock
      âœ” Should revert when trying to recover the primary asset (USDC)
      âœ” Should revert when called by a non-timelock address
    Yield Harvest
      âœ” Should return pending yield correctly (117ms)
      âœ” Should return zero pending yield when no profit
      âœ” Should harvestYield: accrue fees, auto-claim, and emit events
      âœ” Should harvestYield with no yield (no-op) (112ms)
      âœ” Should revert harvestYield from non-allocator

  UniswapV3TWAPOracle
    Deployment
      âœ” should deploy with correct factory address
      âœ” should revert on zero factory address
      âœ” should have correct constants
    getTWAPQuote
      âœ” should return a TWAP quote for token0 â†’ token1 at tick 0 (1:1 price)
      âœ” should return higher quote for positive tick (token0 cheaper)
      âœ” should return lower quote for negative tick
      âœ” should enforce MIN_TWAP_DURATION when duration is too short
      âœ” should revert for non-existent pool
      âœ” should handle token1 â†’ token0 direction
    validateSwapOutput
      âœ” should validate swap within deviation bounds
      âœ” should reject swap outside deviation bounds
      âœ” should accept exact TWAP output
      âœ” should accept output above TWAP (favorable)
      âœ” should reject at exactly MIN_ACCEPTABLE boundary
    Tick bit decomposition â€” full 20-bit coverage
      âœ” exercises even-numbered bits (0,2,4,6,8,10,12,14,16,18) with tick 0x55555
      âœ” exercises odd-numbered bits (1,3,5,7,9,11,13,15,17,19) with tick 0xAAAAA
      âœ” exercises ALL 20 bits with tick 0xD89E7 (max valid minus 1 = 887271)
      âœ” exercises negative tick path (meanTick > 0 branch = false)
      âœ” exercises negative large tick with odd bits
      âœ” exercises single-bit ticks for fine-grained coverage

  UpgradeablePath
    CollateralVaultUpgradeable
      âœ” deploys via proxy and initializes
      âœ” rejects upgrade from non-TIMELOCK_ROLE (80ms)
      âœ” TIMELOCK_ROLE can upgrade successfully (65ms)
      âœ” blocks re-initialization after upgrade
    BorrowModuleUpgradeable
      âœ” deploys via proxy and initializes (47ms)
      âœ” rejects upgrade from non-TIMELOCK_ROLE (125ms)
      âœ” preserves storage across upgrade (226ms)
      âœ” blocks re-initialization (149ms)
    SMUSDUpgradeable
      âœ” deploys via proxy and initializes (72ms)
      âœ” rejects upgrade from non-TIMELOCK_ROLE (249ms)
      âœ” preserves storage across upgrade (81ms)
      âœ” blocks re-initialization
    LiquidationEngineUpgradeable
      âœ” deploys via proxy and initializes (43ms)
      âœ” rejects upgrade from non-TIMELOCK_ROLE (63ms)
      âœ” blocks re-initialization
    LeverageVaultUpgradeable
      âœ” deploys via proxy and initializes (39ms)
      âœ” rejects upgrade from non-TIMELOCK_ROLE (59ms)
      âœ” preserves storage across upgrade (58ms)
      âœ” blocks re-initialization

  VaultEdgeCases: Multi-Collateral Liquidation
    âœ” should liquidate WETH collateral when user has both WETH and WBTC (55ms)
    âœ” should liquidate WBTC collateral when liquidator chooses WBTC
    âœ” should apply correct per-token penalty (10% WETH vs 15% WBTC)

  VaultEdgeCases: Bad Debt & Insolvency
    âœ” should record bad debt when collateral value < debt after price crash (50ms)
    âœ” should realize socialized bad debt from reserves first, then queue supplier loss
    âœ” should realize queued supplier loss by haircutting future supplier interest
    âœ” should reject socializeBadDebt from non-timelock address

  VaultEdgeCases: SMUSD Donation Attack
    âœ” should resist donation attack via decimalsOffset=3
    âœ” should prevent first-depositor share manipulation
    âœ” should enforce 24h cooldown blocking immediate withdrawal after deposit
    âœ” attacker should NOT profit from front-running donation attack
    âœ” victim loss from donation attack should be bounded by decimalsOffset
    âœ” share price distortion from donation should be bounded and proportional
    âœ” donation attack is economically irrational across multiple donation sizes (38ms)

  VaultEdgeCases: sMUSD-Holder Bad-Debt Impact
    âœ” bad debt socialization reduces totalBorrows, lowering future interest to sMUSD stakers (68ms)
    âœ” sMUSD share price is not directly decreased but future yield is impaired (77ms)
    âœ” bad debt impact is shared proportionally across all sMUSD stakers (324ms)
    âœ” absorbBadDebt uses reserves first before queuing supplier haircut (71ms)

  YieldDistributor â€” DirectMint Swap Path
    Initialization
      âœ” Should store all immutable addresses (81ms)
      âœ” Should set default parameters
      âœ” Should revert on zero address constructor args
      âœ” Should pre-approve DirectMint, Bridge, and SMUSD
    distributeYield â€” zero fee
      âœ” Should swap USDC through DirectMint and split proportionally
      âœ” Should emit correct events
      âœ” Should update cumulative tracking state
    distributeYield â€” with mint fee
      âœ” Should account for DirectMint 1% fee in split
      âœ” Should show Treasury net change is only the fee
    Edge Cases
      âœ” Should handle 100% ETH shares (no Canton)
      âœ” Should revert if below minimum distribution
      âœ” Should revert if cooldown not elapsed
      âœ” Should revert if Canton recipient not set
      âœ” Should revert if no shares exist
    Multiple Distributions
      âœ” Should accumulate state across multiple distributions
    previewDistribution
      âœ” Should return correct split with 0% fee
      âœ” Should return correct split with 1% fee
    Access Control
      âœ” Should reject non-keeper calling distributeYield
      âœ” Should reject non-governor calling setCantonYieldRecipient
      âœ” Should reject empty Canton recipient
    Governance
      âœ” Should allow governor to update parameters
      âœ” Should pause and unpause
      âœ” Should rescue stuck tokens
    Bridge Integration
      âœ” Should record correct bridge-out details
    Share Price Integrity
      1) Should not distort globalSharePrice after distribution (0% fee)
      2) Should show minimal price impact with 1% fee

  Yield Integration E2E â€” Manual MetaVault Deploy
    1. Initial state
      âœ” Treasury starts with 1M USDC seeded and 3 registered strategies (69ms)
      âœ” Strategies have autoAllocate = false
      âœ” SMUSD is linked to Treasury for globalTotalAssets
    2. USDC deposit stays in Treasury reserve
      âœ” deposit() with autoAllocate=false keeps all USDC in reserve
    3. Admin manually deploys to MetaVaults via deployToStrategy()
      âœ” Admin deploys USDC from reserve to 3 strategies at 45/45/10 split
      âœ” deployToStrategy reverts for unregistered strategy
      âœ” deployToStrategy reverts when reserve insufficient
      âœ” deployToStrategy requires ALLOCATOR_ROLE
    4. Strategy yield increases Treasury totalValue()
      âœ” Simulated yield in strategies increases totalValue()
    5. SMUSD globalSharePrice reflects Treasury yield
      âœ” globalTotalAssets() returns treasury.totalValue() * 1e12
      âœ” globalSharePrice increases with strategy yield
    6. Performance fee accrual
      âœ” 20% performance fee accrues on yield above high-water mark
      âœ” No fees on principal recovery after loss (high-water mark)
      âœ” claimFees sends USDC to fee recipient
    7. SMUSD distributeYield() and 12h vesting
      âœ” distributeYield transfers mUSD and starts 12h vesting
      âœ” Local share price increases as yield vests
      âœ” distributeYield rejects amount exceeding MAX_YIELD_BPS (10%)
    8. User redeems smUSD at higher price after cooldown
      âœ” Alice redeems more mUSD than she deposited after yield + cooldown
      âœ” Redeem blocked before 24h cooldown
    9. Full lifecycle: deposit â†’ manual deploy â†’ yield â†’ distribute â†’ vest â†’ redeem
      âœ” Complete E2E flow with 3 MetaVaults
    10. Multi-user proportional yield
      âœ” Two users share yield proportionally to their smUSD holdings
    11. Admin withdraws from strategy back to reserve
      âœ” withdrawFromStrategy pulls USDC back to Treasury reserve
    12. Vesting prevents sandwich attack
      âœ” Front-running deposit before distributeYield captures minimal yield

  YieldVerifier
    Deployment
      âœ” sets admin correctly
      âœ” starts with zero adapters
      âœ” reverts on zero admin address
    Adapter Registration
      âœ” registers adapter
      âœ” registers multiple adapters
      âœ” deactivates adapter
      âœ” reverts registration from unauthorized
    Verification
      âœ” verifies within tolerance
      âœ” quickVerify returns bool
      âœ” fails verification when APY deviates too much
      âœ” returns passed=false for unregistered adapter
    Batch Verification
      âœ” batch verifies multiple adapters
    Tolerance
      âœ” sets custom tolerance
      âœ” returns default tolerance for unset protocols
    Read Live
      âœ” reads live data from adapter
    Get Adapters
      âœ” returns all registered adapters


  2069 passing (50s)
  2 failing

  1) YieldDistributor â€” DirectMint Swap Path
       Share Price Integrity
         Should not distort globalSharePrice after distribution (0% fee):

      globalSharePrice should be non-zero after setup
      + expected - actual


      at Context.<anonymous> (test/YieldDistributor.test.ts:759:33)

  2) YieldDistributor â€” DirectMint Swap Path
       Share Price Integrity
         Should show minimal price impact with 1% fee:

      globalSharePrice should be non-zero
      + expected - actual


      at Context.<anonymous> (test/YieldDistributor.test.ts:791:33)



